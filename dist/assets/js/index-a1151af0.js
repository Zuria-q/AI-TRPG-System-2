import{r as y,a as be,R as fe}from"./vendor-b1791c80.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();var me={exports:{}},ne={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ne=y,ve=Symbol.for("react.element"),je=Symbol.for("react.fragment"),ke=Object.prototype.hasOwnProperty,Se=Ne.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ee={key:!0,ref:!0,__self:!0,__source:!0};function he(m,t,s){var r,n={},a=null,i=null;s!==void 0&&(a=""+s),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(i=t.ref);for(r in t)ke.call(t,r)&&!Ee.hasOwnProperty(r)&&(n[r]=t[r]);if(m&&m.defaultProps)for(r in t=m.defaultProps,t)n[r]===void 0&&(n[r]=t[r]);return{$$typeof:ve,type:m,key:a,ref:i,props:n,_owner:Se.current}}ne.Fragment=je;ne.jsx=he;ne.jsxs=he;me.exports=ne;var e=me.exports,ie={},oe=be;ie.createRoot=oe.createRoot,ie.hydrateRoot=oe.hydrateRoot;const S={DIALOGUE:"dialogue",ACTION:"action",ITEM:"item"},D={NONE:"none",CHARACTER:"character",ENVIRONMENT:"environment",ITEM:"item"};function we(m){let t=S.DIALOGUE,s=m;const r=/^\s*[\[ã€](.+?)[\]ã€‘]\s*$/,n=m.match(r);if(n)return t=S.ACTION,s=n[1],{type:t,content:s};const a=/^\s*[{ã€Œ](.+?)[}ã€]\s*$/,i=m.match(a);if(i)return t=S.ITEM,s=i[1],{type:t,content:s};const o=/^\s*[""](.+?)[""]?\s*$/,l=m.match(o);return l&&(s=l[1]),{type:t,content:s}}const Ae=({onSubmitAction:m,availableTargets:t=[],currentActorId:s="player"})=>{const[r,n]=y.useState(""),[a,i]=y.useState(S.DIALOGUE),[o,l]=y.useState(D.NONE),[c,h]=y.useState(""),[g,x]=y.useState(!1),[d,R]=y.useState({tone:"",emotion:"",intensity:50,bodyPart:"",isStealthy:!1,effect:""}),T=y.useRef(null);y.useEffect(()=>{if(r){const{type:b,content:F}=we(r);b!==a&&i(b)}},[r]),y.useEffect(()=>{a===S.DIALOGUE&&l(c?D.CHARACTER:D.NONE)},[a,c]);const O=b=>{n(b.target.value)},v=b=>{i(b.target.value)},j=b=>{l(b.target.value),b.target.value===D.NONE&&h("")},G=b=>{h(b.target.value)},_=(b,F)=>{R(u=>({...u,[b]:F}))},E=b=>{if(b.preventDefault(),!r.trim())return;const F={type:a,actorId:s,content:r,targetType:o,targetId:c||null,timestamp:Date.now(),...W()};m(F),n(""),h(""),R({tone:"",emotion:"",intensity:50,bodyPart:"",isStealthy:!1,effect:""}),T.current&&T.current.focus()},W=()=>{switch(a){case S.DIALOGUE:return{tone:d.tone||null,emotion:d.emotion||null};case S.ACTION:return{intensity:d.intensity||50,bodyPart:d.bodyPart||null,isStealthy:d.isStealthy||!1};case S.ITEM:return{effect:d.effect||null};default:return{}}},Y=()=>e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"è¡Œä¸ºç±»å‹"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.DIALOGUE?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.DIALOGUE,checked:a===S.DIALOGUE,onChange:v,className:"sr-only"}),e.jsx("span",{children:"ğŸ’¬ å¯¹è¯"})]}),e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.ACTION?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.ACTION,checked:a===S.ACTION,onChange:v,className:"sr-only"}),e.jsx("span",{children:"ğŸƒ åŠ¨ä½œ"})]}),e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.ITEM?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.ITEM,checked:a===S.ITEM,onChange:v,className:"sr-only"}),e.jsx("span",{children:"ğŸ§° ç‰©å“"})]})]})]}),P=()=>e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"ç›®æ ‡"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("select",{value:o,onChange:j,className:"select",children:[e.jsx("option",{value:D.NONE,children:"æ— ç‰¹å®šç›®æ ‡"}),e.jsx("option",{value:D.CHARACTER,children:"è§’è‰²"}),e.jsx("option",{value:D.ENVIRONMENT,children:"ç¯å¢ƒ/åœºæ™¯"}),e.jsx("option",{value:D.ITEM,children:"ç‰©å“"})]})}),o!==D.NONE&&e.jsx("div",{children:e.jsxs("select",{value:c,onChange:G,className:"select",disabled:o===D.NONE,children:[e.jsx("option",{value:"",children:"é€‰æ‹©å…·ä½“ç›®æ ‡..."}),t.filter(b=>b.type===o).map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})})]})]}),z=()=>{if(!g)return null;switch(a){case S.DIALOGUE:return e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"è¯­æ°”/è¯­è°ƒ"}),e.jsx("input",{type:"text",value:d.tone,onChange:b=>_("tone",b.target.value),placeholder:"ä¾‹å¦‚ï¼šæ„¤æ€’ã€æ¸©æŸ”ã€ç–‘æƒ‘",className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"æƒ…ç»ªçŠ¶æ€"}),e.jsx("input",{type:"text",value:d.emotion,onChange:b=>_("emotion",b.target.value),placeholder:"ä¾‹å¦‚ï¼šé«˜å…´ã€æ‚²ä¼¤ã€ç´§å¼ ",className:"input"})]})]});case S.ACTION:return e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["åŠ¨ä½œå¼ºåº¦ (",d.intensity,")"]}),e.jsx("input",{type:"range",min:"0",max:"100",value:d.intensity,onChange:b=>_("intensity",parseInt(b.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"èº«ä½“éƒ¨ä½"}),e.jsx("input",{type:"text",value:d.bodyPart,onChange:b=>_("bodyPart",b.target.value),placeholder:"ä¾‹å¦‚ï¼šæ‰‹ã€è…¿ã€å¤´",className:"input"})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:d.isStealthy,onChange:b=>_("isStealthy",b.target.checked),className:"mr-2"}),e.jsx("span",{children:"éšè”½è¡ŒåŠ¨ï¼ˆå…¶ä»–è§’è‰²å¯èƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼‰"})]})})]});case S.ITEM:return e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"é¢„æœŸæ•ˆæœ"}),e.jsx("input",{type:"text",value:d.effect,onChange:b=>_("effect",b.target.value),placeholder:"ä¾‹å¦‚ï¼šæ²»ç–—ã€ä¼¤å®³ã€å¢ç›Š",className:"input"})]});default:return null}},w=()=>{switch(a){case S.DIALOGUE:return'è¾“å…¥å¯¹è¯å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨å¼•å·ï¼š"ä½ å¥½ï¼Œæˆ‘æ˜¯ç©å®¶"';case S.ACTION:return"è¾“å…¥åŠ¨ä½œæè¿°ï¼Œå¯ä»¥ä½¿ç”¨æ–¹æ‹¬å·ï¼šã€å‘å‰èµ°äº†å‡ æ­¥ã€‘";case S.ITEM:return"è¾“å…¥ç‰©å“ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨èŠ±æ‹¬å·ï¼šã€Œä½¿ç”¨æ²»ç–—è¯æ°´ã€";default:return"è¾“å…¥è¡Œä¸ºå†…å®¹..."}};return e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"mb-4",children:"è¡Œä¸ºè¾“å…¥"}),e.jsxs("form",{onSubmit:E,children:[Y(),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"å†…å®¹"}),e.jsx("textarea",{ref:T,value:r,onChange:O,placeholder:w(),className:"textarea",rows:"3",required:!0})]}),P(),e.jsx("div",{className:"mb-4",children:e.jsx("button",{type:"button",className:"text-sm text-primary-600 dark:text-primary-400 hover:underline",onClick:()=>x(!g),children:g?"éšè—é«˜çº§é€‰é¡¹ â–²":"æ˜¾ç¤ºé«˜çº§é€‰é¡¹ â–¼"})}),z(),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!r.trim(),children:"å‘é€"})})]})]})},le={SETUP:"setup",PLANNING:"planning",ACTION:"action",RESOLUTION:"resolution",END:"end"},Ie={DAWN:"dawn",MORNING:"morning",NOON:"noon",AFTERNOON:"afternoon",EVENING:"evening",NIGHT:"night",MIDNIGHT:"midnight"},Ce={CLEAR:"clear",CLOUDY:"cloudy",RAINY:"rainy",STORMY:"stormy",SNOWY:"snowy",FOGGY:"foggy",WINDY:"windy"};class Te{constructor(){this.reset()}reset(){this.state={gameId:this._generateGameId(),sessionId:this._generateSessionId(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),turn:0,phase:le.SETUP,player:{id:"player",name:"ç©å®¶",description:"",attributes:{},inventory:[],status:[]},agents:[],activeAgentId:null,environment:{name:"æœªå‘½ååœºæ™¯",description:"è¿™æ˜¯ä¸€ä¸ªæœªæè¿°çš„åœºæ™¯",currentLocation:"default",locations:{default:{id:"default",name:"é»˜è®¤ä½ç½®",description:"ä¸€ä¸ªé»˜è®¤çš„èµ·å§‹ä½ç½®",connections:[],objects:[]}},time:{day:1,cycle:Ie.MORNING,hour:9,minute:0},weather:Ce.CLEAR,ambience:"",flags:{}},worldbook:[],flags:{},variables:{},llmConfig:{temperature:.7,maxTokens:500,useMemory:!0,contextWeight:.5}}}getState(){return this.state}updateState(t){return this.state={...this.state,...t,updatedAt:new Date().toISOString()},this.state}getPhase(){return this.state.phase}setPhase(t){if(!Object.values(le).includes(t))throw new Error(`æ— æ•ˆçš„æ¸¸æˆé˜¶æ®µ: ${t}`);this.state.phase=t,this.state.updatedAt=new Date().toISOString()}getTurn(){return this.state.turn}incrementTurn(t=1){return this.state.turn+=t,this.state.updatedAt=new Date().toISOString(),this.state.turn}getPlayer(){return this.state.player}updatePlayer(t){return this.state.player={...this.state.player,...t},this.state.updatedAt=new Date().toISOString(),this.state.player}getAgents(){return this.state.agents}getAgent(t){return this.state.agents.find(s=>s.id===t)||null}addAgent(t){if(!t.id)throw new Error("ä»£ç†å¿…é¡»æœ‰ID");const s=this.state.agents.findIndex(r=>r.id===t.id);return s>=0?this.state.agents[s]={...this.state.agents[s],...t}:this.state.agents.push(t),this.state.updatedAt=new Date().toISOString(),this.state.agents}updateAgent(t,s){const r=this.state.agents.findIndex(n=>n.id===t);return r<0?null:(this.state.agents[r]={...this.state.agents[r],...s},this.state.updatedAt=new Date().toISOString(),this.state.agents[r])}removeAgent(t){const s=this.state.agents.length;this.state.agents=this.state.agents.filter(n=>n.id!==t);const r=s>this.state.agents.length;return r&&(this.state.updatedAt=new Date().toISOString(),this.state.activeAgentId===t&&(this.state.activeAgentId=null)),r}setActiveAgent(t){return t?this.state.agents.some(r=>r.id===t)?(this.state.activeAgentId=t,this.state.updatedAt=new Date().toISOString(),!0):!1:(this.state.activeAgentId=null,this.state.updatedAt=new Date().toISOString(),!0)}getEnvironment(){return this.state.environment}updateEnvironment(t){return this.state.environment={...this.state.environment,...t},this.state.updatedAt=new Date().toISOString(),this.state.environment}getLocation(t){return this.state.environment.locations[t]||null}addLocation(t){if(!t.id)throw new Error("ä½ç½®å¿…é¡»æœ‰ID");return this.state.environment.locations[t.id]={...this.state.environment.locations[t.id]||{},...t},this.state.updatedAt=new Date().toISOString(),this.state.environment.locations[t.id]}removeLocation(t){return this.state.environment.locations[t]?(this.state.environment.currentLocation===t&&(this.state.environment.currentLocation="default"),delete this.state.environment.locations[t],this.state.updatedAt=new Date().toISOString(),!0):!1}setCurrentLocation(t){return this.state.environment.locations[t]?(this.state.environment.currentLocation=t,this.state.updatedAt=new Date().toISOString(),!0):!1}getWorldbook(){return this.state.worldbook}addWorldbookEntry(t){t.id||(t.id=`entry_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const s=this.state.worldbook.findIndex(r=>r.id===t.id);return s>=0?this.state.worldbook[s]={...this.state.worldbook[s],...t}:this.state.worldbook.push(t),this.state.updatedAt=new Date().toISOString(),this.state.worldbook}removeWorldbookEntry(t){const s=this.state.worldbook.length;this.state.worldbook=this.state.worldbook.filter(n=>n.id!==t);const r=s>this.state.worldbook.length;return r&&(this.state.updatedAt=new Date().toISOString()),r}getLLMConfig(){return this.state.llmConfig}updateLLMConfig(t){return this.state.llmConfig={...this.state.llmConfig,...t},this.state.updatedAt=new Date().toISOString(),this.state.llmConfig}saveToLocalStorage(t="ai_trpg_game_state"){try{const s=JSON.stringify(this.state);return localStorage.setItem(t,s),!0}catch(s){return console.error("ä¿å­˜æ¸¸æˆçŠ¶æ€å¤±è´¥:",s),!1}}loadFromLocalStorage(t="ai_trpg_game_state"){try{const s=localStorage.getItem(t);if(!s)return!1;const r=JSON.parse(s);return this.state=r,!0}catch(s){return console.error("åŠ è½½æ¸¸æˆçŠ¶æ€å¤±è´¥:",s),!1}}exportState(){return JSON.stringify(this.state,null,2)}importState(t){try{const s=JSON.parse(t);return this.state=s,!0}catch(s){return console.error("å¯¼å…¥æ¸¸æˆçŠ¶æ€å¤±è´¥:",s),!1}}_generateGameId(){return`game_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}const N=new Te,$={ACTION:"action",STATE_CHANGE:"state_change",SYSTEM:"system",NPC_RESPONSE:"npc_response",ENVIRONMENT:"environment"};class Re{constructor(){this.history=[],this.maxHistoryLength=1e3}addEntry(t){const s={id:this._generateEntryId(),timestamp:Date.now(),...t};return this.history.push(s),this.history.length>this.maxHistoryLength&&this.history.shift(),s}addActionEntry(t,s=null){return this.addEntry({type:$.ACTION,action:t,result:s,actorId:t.actorId,content:t.content})}addStateChangeEntry(t,s,r=null){const n=this._calculateStateDiff(t,s);return this.addEntry({type:$.STATE_CHANGE,changes:n,cause:r})}addSystemEntry(t,s,r=null){return this.addEntry({type:$.SYSTEM,eventType:t,message:s,data:r})}addNPCResponseEntry(t,s,r=null){return this.addEntry({type:$.NPC_RESPONSE,npcId:t,content:s,metadata:r})}addEnvironmentEntry(t,s,r=null){return this.addEntry({type:$.ENVIRONMENT,locationId:t,description:s,metadata:r})}getHistory(){return this.history}getRecentHistory(t){return this.history.slice(-t)}getHistoryByType(t,s=null){const r=this.history.filter(n=>n.type===t);return s!==null?r.slice(-s):r}getHistoryByActor(t,s=null){const r=this.history.filter(n=>n.actorId===t||n.type===$.NPC_RESPONSE&&n.npcId===t);return s!==null?r.slice(-s):r}getHistoryByTimeRange(t,s){return this.history.filter(r=>r.timestamp>=t&&r.timestamp<=s)}clearHistory(){this.history=[]}exportHistory(){return JSON.stringify(this.history,null,2)}importHistory(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("å¯¼å…¥çš„å†å²è®°å½•ä¸æ˜¯æ•°ç»„");return this.history=s,!0}catch(s){return console.error("å¯¼å…¥å†å²è®°å½•å¤±è´¥:",s),!1}}saveToLocalStorage(t="ai_trpg_history"){try{const s=JSON.stringify(this.history);return localStorage.setItem(t,s),!0}catch(s){return console.error("ä¿å­˜å†å²è®°å½•å¤±è´¥:",s),!1}}loadFromLocalStorage(t="ai_trpg_history"){try{const s=localStorage.getItem(t);if(!s)return!1;const r=JSON.parse(s);return this.history=r,!0}catch(s){return console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:",s),!1}}_generateEntryId(){return`entry_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_calculateStateDiff(t,s){const r={};for(const n in s)JSON.stringify(t[n])!==JSON.stringify(s[n])&&(r[n]={previous:t[n],current:s[n]});return r}getHistorySummaryForPrompt(t=500){let r=this.getRecentHistory(10).map(n=>{switch(n.type){case $.ACTION:return`[è¡Œä¸º] ${n.actorId}: ${n.content}`;case $.NPC_RESPONSE:return`[NPC] ${n.npcId}: ${n.content}`;case $.ENVIRONMENT:return`[ç¯å¢ƒ] ${n.description}`;case $.SYSTEM:return`[ç³»ç»Ÿ] ${n.message}`;default:return null}}).filter(n=>n!==null).join(`
`);return r.length>t&&(r=r.substring(r.length-t),r=r.substring(r.indexOf(`
`)+1)),r}}const U=new Re,Oe=({history:m=[]})=>{const t=y.useRef(null);y.useEffect(()=>{t.current&&t.current.scrollIntoView({behavior:"smooth"})},[m]);const s=a=>{switch(a){case $.ACTION:return"bg-blue-50 dark:bg-blue-900 border-blue-200 dark:border-blue-700";case $.NPC_RESPONSE:return"bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700";case $.SYSTEM:return"bg-purple-50 dark:bg-purple-900 border-purple-200 dark:border-purple-700";case $.ENVIRONMENT:return"bg-amber-50 dark:bg-amber-900 border-amber-200 dark:border-amber-700";default:return"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700"}},r=a=>{switch(a){case"happy":return"text-yellow-600 dark:text-yellow-400";case"sad":return"text-blue-600 dark:text-blue-400";case"angry":return"text-red-600 dark:text-red-400";case"fearful":return"text-purple-600 dark:text-purple-400";case"disgusted":return"text-green-600 dark:text-green-400";case"surprised":return"text-pink-600 dark:text-pink-400";default:return"text-gray-600 dark:text-gray-400"}},n=(a,i)=>{var c,h;const o=a.timestamp?new Date(a.timestamp).toLocaleTimeString():"",l=s(a.type);switch(a.type){case $.ACTION:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:a.actorId||"æœªçŸ¥"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.content})]},i);case $.NPC_RESPONSE:const g=(c=a.metadata)!=null&&c.emotion?r(a.metadata.emotion):"";return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"font-semibold flex items-center",children:[a.npcId||"æœªçŸ¥",((h=a.metadata)==null?void 0:h.emotion)&&e.jsx("span",{className:`ml-2 text-xs ${g}`,children:a.metadata.emotion})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.content})]},i);case $.SYSTEM:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:"ç³»ç»Ÿ"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.message})]},i);case $.ENVIRONMENT:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"font-semibold",children:["ç¯å¢ƒ: ",a.locationId||"æœªçŸ¥ä½ç½®"]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.description})]},i);default:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:"æœªçŸ¥ç±»å‹"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:JSON.stringify(a)})]},i)}};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"æ¸¸æˆå†å²"}),m.length===0?e.jsx("div",{className:"text-center p-8 text-gray-500 dark:text-gray-400",children:"æ²¡æœ‰å†å²è®°å½•ã€‚å¼€å§‹ä½ çš„å†’é™©å§ï¼"}):e.jsxs("div",{className:"space-y-2",children:[m.map(n),e.jsx("div",{ref:t})]})]})},Le=({gameState:m={}})=>{const[t,s]=y.useState("player"),r=c=>{s(t===c?null:c)},n=()=>{const c=m.player||{};return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-indigo-100 dark:bg-indigo-900 rounded-md",onClick:()=>r("player"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ç©å®¶ä¿¡æ¯"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="player"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="player"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"åç§°:"})," ",c.name||"æœªå‘½å"]}),c.description&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"æè¿°:"})," ",c.description]}),c.location&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"ä½ç½®:"})," ",c.location]}),c.inventory&&c.inventory.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"ç‰©å“æ :"}),e.jsx("ul",{className:"list-disc list-inside",children:c.inventory.map((h,g)=>e.jsx("li",{children:h.name||h.id},g))})]}),c.status&&c.status.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"çŠ¶æ€æ•ˆæœ:"}),e.jsx("ul",{className:"list-disc list-inside",children:c.status.map((h,g)=>e.jsxs("li",{children:[h.name,": ",h.description]},g))})]})]})]})},a=()=>{const c=m.environment||{},h=c.currentLocation,g=h&&c.locations?c.locations[h]:null;return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-green-100 dark:bg-green-900 rounded-md",onClick:()=>r("environment"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ç¯å¢ƒä¿¡æ¯"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="environment"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="environment"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[g?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"å½“å‰ä½ç½®:"})," ",g.name||h]}),g.description&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"æè¿°:"})," ",g.description]}),g.objects&&g.objects.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"ç‰©ä½“:"}),e.jsx("ul",{className:"list-disc list-inside",children:g.objects.map((x,d)=>e.jsx("li",{children:x.name||x.id},d))})]}),g.exits&&Object.keys(g.exits).length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"å‡ºå£:"}),e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(g.exits).map(([x,d])=>e.jsxs("li",{children:[x,": ",typeof d=="string"?d:d.target]},x))})]})]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"æ²¡æœ‰å½“å‰ä½ç½®ä¿¡æ¯"}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"æ—¶é—´:"})," ",c.currentTime||"æœªçŸ¥"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"å¤©æ°”:"})," ",c.currentWeather||"æœªçŸ¥"]})]})]})]})},i=()=>{var x;const c=m.agents||[],h=(x=m.environment)==null?void 0:x.currentLocation,g=h?c.filter(d=>d.location===h):c;return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-amber-100 dark:bg-amber-900 rounded-md",onClick:()=>r("npcs"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"NPCä¿¡æ¯"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="npcs"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="npcs"&&e.jsx("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:g.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"å½“å‰ä½ç½®çš„è§’è‰²:"}),g.map((d,R)=>e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[e.jsx("div",{className:"font-semibold",children:d.name||d.id}),d.description&&e.jsx("div",{className:"text-sm mt-1",children:d.description}),d.currentEmotion&&e.jsxs("div",{className:"text-sm mt-1",children:[e.jsx("span",{className:"font-semibold",children:"æƒ…ç»ª:"})," ",d.currentEmotion,d.emotionIntensity&&` (${d.emotionIntensity})`]})]},R))]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"å½“å‰ä½ç½®æ²¡æœ‰NPC"})})]})},o=()=>{const c=m.worldBook||{},h=c.entries||[];return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-purple-100 dark:bg-purple-900 rounded-md",onClick:()=>r("worldbook"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ä¸–ç•Œä¹¦"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="worldbook"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="worldbook"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[c.mainSetting&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"ä¸»è¦è®¾å®š:"}),e.jsx("p",{children:c.mainSetting})]}),h.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"æ¡ç›®:"}),h.map((g,x)=>e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[e.jsx("div",{className:"font-semibold",children:g.name||g.id}),g.content&&e.jsx("div",{className:"text-sm mt-1",children:g.content}),g.category&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["åˆ†ç±»: ",g.category]})]},x))]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"æ²¡æœ‰ä¸–ç•Œä¹¦æ¡ç›®"})]})]})},l=()=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-blue-100 dark:bg-blue-900 rounded-md",onClick:()=>r("game"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"æ¸¸æˆä¿¡æ¯"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="game"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="game"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"æ¸¸æˆID:"})," ",m.gameId||"æœªçŸ¥"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"å›åˆ:"})," ",m.turn||0]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"é˜¶æ®µ:"})," ",m.phase||"æœªçŸ¥"]}),m.storyInfo&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"æ•…äº‹ä¿¡æ¯:"}),m.storyInfo.title&&e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"æ ‡é¢˜:"})," ",m.storyInfo.title]}),m.storyInfo.currentPlot&&e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"å½“å‰æƒ…èŠ‚:"})," ",m.storyInfo.currentPlot]})]}),e.jsxs("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:["åˆ›å»ºæ—¶é—´: ",m.createdAt?new Date(m.createdAt).toLocaleString():"æœªçŸ¥",e.jsx("br",{}),"æ›´æ–°æ—¶é—´: ",m.updatedAt?new Date(m.updatedAt).toLocaleString():"æœªçŸ¥"]})]})]});return e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"æ¸¸æˆçŠ¶æ€"}),n(),a(),i(),o(),l()]})},M={PLAYER:"player",NPC:"npc",GM:"gm",ENVIRONMENT:"environment"},C={OPENNESS:"openness",CONSCIENTIOUSNESS:"conscientiousness",EXTRAVERSION:"extraversion",AGREEABLENESS:"agreeableness",NEUROTICISM:"neuroticism"},k={HAPPY:"happy",SAD:"sad",ANGRY:"angry",FEARFUL:"fearful",DISGUSTED:"disgusted",SURPRISED:"surprised",NEUTRAL:"neutral"},re={id:"",name:"",type:M.NPC,description:"",background:"",appearance:"",personality:{[C.OPENNESS]:50,[C.CONSCIENTIOUSNESS]:50,[C.EXTRAVERSION]:50,[C.AGREEABLENESS]:50,[C.NEUROTICISM]:50},goals:[],motivations:[],fears:[],relationships:{},skills:{},inventory:[],status:[],currentEmotion:k.NEUTRAL,emotionIntensity:50,location:"default",dialogueStyle:"",responsePreferences:{},memoryIds:[],createdAt:"",updatedAt:""};class $e{constructor(){this.agents=new Map,this.templates=new Map}initialize(){const t=N.getState();t.player&&this.registerAgent({...re,...t.player,type:M.PLAYER,id:"player"}),t.agents&&Array.isArray(t.agents)&&t.agents.forEach(s=>{this.registerAgent({...re,...s})}),this.registerAgent({...re,id:"gm",name:"æ¸¸æˆä¸»æŒäºº",type:M.GM,description:"æ¸¸æˆä¸»æŒäººï¼Œè´Ÿè´£è®²è¿°æ•…äº‹å’Œç®¡ç†æ¸¸æˆè¿›ç¨‹",personality:{[C.OPENNESS]:80,[C.CONSCIENTIOUSNESS]:90,[C.EXTRAVERSION]:70,[C.AGREEABLENESS]:85,[C.NEUROTICISM]:20}})}registerAgent(t){return t.id||(t.id=this._generateAgentId()),t.createdAt||(t.createdAt=new Date().toISOString()),t.updatedAt=new Date().toISOString(),this.agents.set(t.id,t),t}registerTemplate(t,s){return this.templates.set(t,{...re,...s}),this.templates.get(t)}createAgentFromTemplate(t,s={}){const r=this.templates.get(t);if(!r)throw new Error(`æ¨¡æ¿ä¸å­˜åœ¨: ${t}`);const n={...r,...s,id:s.id||this._generateAgentId(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.registerAgent(n)}getAllAgents(){return Array.from(this.agents.values())}getAgentsByType(t){return this.getAllAgents().filter(s=>s.type===t)}getAgent(t){return this.agents.get(t)||null}updateAgent(t,s){const r=this.agents.get(t);if(!r)return null;const n={...r,...s,updatedAt:new Date().toISOString()};if(this.agents.set(t,n),t==="player")N.updatePlayer(n);else if(r.type===M.NPC){const i=N.getState().agents||[],o=i.findIndex(l=>l.id===t);o>=0?i[o]=n:i.push(n),N.updateState({agents:i})}return n}removeAgent(t){if(t==="player"||t==="gm")return!1;const s=this.agents.delete(t);if(s){const a=(N.getState().agents||[]).filter(i=>i.id!==t);N.updateState({agents:a})}return s}updateAgentEmotion(t,s,r=50){return this.updateAgent(t,{currentEmotion:s,emotionIntensity:r})}updateAgentLocation(t,s){return this.updateAgent(t,{location:s})}addItemToInventory(t,s){const r=this.agents.get(t);if(!r)return null;const n=[...r.inventory||[]];return n.push(s),this.updateAgent(t,{inventory:n})}removeItemFromInventory(t,s){const r=this.agents.get(t);if(!r)return null;const n=(r.inventory||[]).filter(a=>a.id!==s);return this.updateAgent(t,{inventory:n})}addStatusEffect(t,s){const r=this.agents.get(t);if(!r)return null;const n=[...r.status||[]];return n.push(s),this.updateAgent(t,{status:n})}removeStatusEffect(t,s){const r=this.agents.get(t);if(!r)return null;const n=(r.status||[]).filter(a=>a.id!==s);return this.updateAgent(t,{status:n})}saveAgentsToGameState(){const t=this.getAgent("player"),s=this.getAgentsByType(M.NPC);N.updateState({player:t,agents:s})}exportAgents(){return JSON.stringify(Array.from(this.agents.values()),null,2)}importAgents(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("å¯¼å…¥çš„è§’è‰²ä¸æ˜¯æ•°ç»„");return this.agents.forEach((r,n)=>{n!=="player"&&n!=="gm"&&this.agents.delete(n)}),s.forEach(r=>{if(r.id==="player"||r.id==="gm"){const n=this.agents.get(r.id);this.agents.set(r.id,{...n,...r,updatedAt:new Date().toISOString()})}else this.registerAgent(r)}),this.saveAgentsToGameState(),!0}catch(s){return console.error("å¯¼å…¥è§’è‰²å¤±è´¥:",s),!1}}_generateAgentId(){return`agent_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}createAgentCard(t){const s=this.getAgent(t);if(!s)throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${t}`);return{id:s.id,name:s.name,type:s.type,description:s.description,background:s.background,appearance:s.appearance,personality:s.personality,goals:s.goals,dialogueStyle:s.dialogueStyle}}}const A=new $e,_e={FRIEND:"friend",ENEMY:"enemy",FAMILY:"family",LOVER:"lover",ALLY:"ally",RIVAL:"rival",STRANGER:"stranger",MENTOR:"mentor",STUDENT:"student",EMPLOYER:"employer",EMPLOYEE:"employee"},V={TRUST:"trust",INTIMACY:"intimacy",RESPECT:"respect",LOYALTY:"loyalty",DEPENDENCY:"dependency"},ce={type:_e.STRANGER,factors:{[V.TRUST]:50,[V.INTIMACY]:0,[V.RESPECT]:50,[V.LOYALTY]:0,[V.DEPENDENCY]:0},history:[],notes:"",createdAt:"",updatedAt:""};class Pe{constructor(){this.relationships=new Map}initialize(){N.getState();const t=A.getAllAgents();t.forEach(s=>{t.forEach(r=>{if(s.id!==r.id){const n=s.relationships&&s.relationships[r.id];n?this.setRelationship(s.id,r.id,n):this.setRelationship(s.id,r.id,{...ce,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}})})}_getRelationshipKey(t,s){return[t,s].sort().join("_")}setRelationship(t,s,r){if(t===s)throw new Error("ä¸èƒ½è®¾ç½®è§’è‰²ä¸è‡ªèº«çš„å…³ç³»");const n=this._getRelationshipKey(t,s),a=new Date().toISOString(),i={...ce,...r,updatedAt:a};return i.createdAt||(i.createdAt=a),this.relationships.set(n,i),this._updateAgentRelationships(t,s,i),i}getRelationship(t,s){if(t===s)return null;const r=this._getRelationshipKey(t,s);return this.relationships.get(r)||null}getAgentRelationships(t){const s={};return A.getAllAgents().forEach(n=>{if(n.id!==t){const a=this.getRelationship(t,n.id);a&&(s[n.id]=a)}}),s}updateRelationshipFactor(t,s,r,n){const a=this.getRelationship(t,s);if(!a)return null;const i=Math.max(0,Math.min(100,n)),o={...a,factors:{...a.factors,[r]:i},updatedAt:new Date().toISOString()};return this.setRelationship(t,s,o)}adjustRelationshipFactor(t,s,r,n){const a=this.getRelationship(t,s);if(!a)return null;const i=a.factors[r]||0,o=Math.max(0,Math.min(100,i+n));return this.updateRelationshipFactor(t,s,r,o)}updateRelationshipType(t,s,r){const n=this.getRelationship(t,s);if(!n)return null;const a={...n,type:r,updatedAt:new Date().toISOString()};return this.setRelationship(t,s,a)}addRelationshipHistory(t,s,r){const n=this.getRelationship(t,s);if(!n)return null;const a=[...n.history||[]],i={...r,timestamp:r.timestamp||new Date().toISOString()};a.push(i);const o={...n,history:a,updatedAt:new Date().toISOString()};return this.setRelationship(t,s,o)}processActionEffect(t){if(t.targetType!==D.CHARACTER||!t.targetId)return null;const s=t.actorId,r=t.targetId;if(s===r||!this.getRelationship(s,r))return null;let a=0,i=0,o=0;switch(t.type){case S.DIALOGUE:t.content.includes("æ„Ÿè°¢")||t.content.includes("è°¢è°¢")?(a=2,o=1):t.content.includes("æŠ±æ­‰")||t.content.includes("å¯¹ä¸èµ·")?(a=1,o=2):t.content.includes("å–œæ¬¢")||t.content.includes("çˆ±")?(i=3,a=1):(t.content.includes("è®¨åŒ")||t.content.includes("æ¨"))&&(i=-3,a=-1);break;case S.ACTION:t.content.includes("å¸®åŠ©")||t.content.includes("æ´åŠ©")?(a=3,o=2):t.content.includes("æ”»å‡»")||t.content.includes("ä¼¤å®³")?(a=-5,o=-3):(t.content.includes("æ‹¥æŠ±")||t.content.includes("äº²å»"))&&(i=4);break;case S.ITEM:t.content.includes("èµ é€")||t.content.includes("ç»™äºˆ")?(a=2,i=1):(t.content.includes("å·çªƒ")||t.content.includes("æŠ¢å¤º"))&&(a=-4,o=-2);break}return a!==0&&this.adjustRelationshipFactor(s,r,V.TRUST,a),i!==0&&this.adjustRelationshipFactor(s,r,V.INTIMACY,i),o!==0&&this.adjustRelationshipFactor(s,r,V.RESPECT,o),this.addRelationshipHistory(s,r,{actionType:t.type,content:t.content,effect:{trust:a,intimacy:i,respect:o}}),this.getRelationship(s,r)}_updateAgentRelationships(t,s,r){const n=A.getAgent(t),a=A.getAgent(s);if(n){const i={...n.relationships||{}};i[s]=r,A.updateAgent(t,{relationships:i})}if(a){const i={...a.relationships||{}};i[t]=r,A.updateAgent(s,{relationships:i})}}analyzeRelationship(t,s){const r=this.getRelationship(t,s);if(!r)return{status:"æœªçŸ¥",description:"æ²¡æœ‰å…³ç³»æ•°æ®"};const{trust:n,intimacy:a,respect:i}=r.factors;let o="",l="";return n>=80&&a>=80?(o="äº²å¯†",l="å…³ç³»éå¸¸äº²å¯†ï¼Œäº’ç›¸ä¿¡ä»»"):n>=70?(o="ä¿¡ä»»",l="å½¼æ­¤ä¿¡ä»»ï¼Œå…³ç³»è‰¯å¥½"):n<=20&&i<=30?(o="æ•Œå¯¹",l="å…³ç³»æ¶åŠ£ï¼Œäº’ä¸ä¿¡ä»»"):n<=40?(o="è­¦æƒ•",l="ä¿æŒè·ç¦»ï¼Œç¼ºä¹ä¿¡ä»»"):a>=70&&i>=60?(o="å‹å¥½",l="å…³ç³»å‹å¥½ï¼Œäº’ç›¸å°Šé‡"):(o="ä¸€èˆ¬",l="å…³ç³»ä¸€èˆ¬ï¼Œæ²¡æœ‰ç‰¹åˆ«äº²è¿‘æˆ–ç–è¿œ"),{status:o,description:l,type:r.type,factors:r.factors}}getSocialNetwork(t){if(!A.getAgent(t))return[];const r=[];return A.getAllAgents().forEach(a=>{a.id!==t&&this.getRelationship(t,a.id)&&r.push({agentId:a.id,name:a.name,type:a.type,relationship:this.analyzeRelationship(t,a.id)})}),r}exportRelationships(){return JSON.stringify(Array.from(this.relationships.entries()),null,2)}importRelationships(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("å¯¼å…¥çš„å…³ç³»ä¸æ˜¯æ•°ç»„");this.relationships.clear(),s.forEach(([n,a])=>{this.relationships.set(n,a)});const r=A.getAllAgents();return r.forEach(n=>{const a={};r.forEach(i=>{if(n.id!==i.id){const o=this.getRelationship(n.id,i.id);o&&(a[i.id]=o)}}),A.updateAgent(n.id,{relationships:a})}),!0}catch(s){return console.error("å¯¼å…¥å…³ç³»å¤±è´¥:",s),!1}}}const te=new Pe,De=()=>{const[m,t]=y.useState([]),[s,r]=y.useState(null),[n,a]=y.useState(!1),[i,o]=y.useState(!1),[l,c]=y.useState({}),[h,g]=y.useState("info");y.useEffect(()=>{x()},[]);const x=()=>{const u=A.getAllAgents();t(u),!s&&u.length>0&&r(u[0].id)},d=s?m.find(u=>u.id===s):null,R=u=>{r(u),a(!1),o(!1),g("info")},T=()=>{o(!0),a(!1),r(null),c({name:"",type:M.NPC,description:"",background:"",appearance:"",personality:{[C.OPENNESS]:50,[C.CONSCIENTIOUSNESS]:50,[C.EXTRAVERSION]:50,[C.AGREEABLENESS]:50,[C.NEUROTICISM]:50},goals:[],motivations:[],fears:[],dialogueStyle:"",location:"default"})},O=()=>{d&&(a(!0),o(!1),c({...d}))},v=()=>{d&&window.confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰² "${d.name}" å—ï¼Ÿ`)&&(A.removeAgent(s),x(),r(null))},j=u=>{const{name:f,value:H}=u.target;if(f.startsWith("personality.")){const Q=f.split(".")[1];c({...l,personality:{...l.personality,[Q]:parseInt(H,10)}})}else c({...l,[f]:H})},G=u=>{u.preventDefault();try{i?A.registerAgent(l):n&&A.updateAgent(s,l),x(),o(!1),a(!1)}catch(f){console.error("ä¿å­˜è§’è‰²å¤±è´¥:",f),alert(`ä¿å­˜è§’è‰²å¤±è´¥: ${f.message}`)}},_=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"è§’è‰²åˆ—è¡¨"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:T,children:"åˆ›å»ºè§’è‰²"})]}),m.length===0?e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:'æ²¡æœ‰è§’è‰²ã€‚ç‚¹å‡»"åˆ›å»ºè§’è‰²"æŒ‰é’®æ·»åŠ ä¸€ä¸ªã€‚'}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:m.map(u=>e.jsx("li",{className:"py-2",children:e.jsxs("button",{className:`w-full text-left px-3 py-2 rounded ${s===u.id?"bg-indigo-100 dark:bg-indigo-900":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,onClick:()=>R(u.id),children:[e.jsx("div",{className:"font-medium",children:u.name||u.id}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[u.type," ",u.location&&`Â· ${u.location}`]})]})},u.id))})]}),E=()=>d?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:d.name||d.id}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:[d.type," Â· ",d.location||"æ— ä½ç½®"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:O,children:"ç¼–è¾‘"}),d.id!=="player"&&d.id!=="gm"&&e.jsx("button",{className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",onClick:v,children:"åˆ é™¤"})]})]})}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:e.jsxs("nav",{className:"flex",children:[e.jsx("button",{className:`px-4 py-2 ${h==="info"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("info"),children:"åŸºæœ¬ä¿¡æ¯"}),e.jsx("button",{className:`px-4 py-2 ${h==="relationships"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("relationships"),children:"å…³ç³»"}),e.jsx("button",{className:`px-4 py-2 ${h==="inventory"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("inventory"),children:"ç‰©å“æ "}),e.jsx("button",{className:`px-4 py-2 ${h==="status"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("status"),children:"çŠ¶æ€"})]})}),e.jsxs("div",{className:"p-4",children:[h==="info"&&W(),h==="relationships"&&Y(),h==="inventory"&&P(),h==="status"&&z()]})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"è¯·é€‰æ‹©ä¸€ä¸ªè§’è‰²æŸ¥çœ‹è¯¦æƒ…"})}),W=()=>e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"æè¿°"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.description||"æ— æè¿°"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"èƒŒæ™¯"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.background||"æ— èƒŒæ™¯ä¿¡æ¯"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"å¤–è²Œ"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.appearance||"æ— å¤–è²Œæè¿°"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"æ€§æ ¼ç‰¹è´¨"}),d.personality?e.jsx("div",{className:"space-y-2",children:Object.entries(d.personality).map(([u,f])=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"w-32 font-medium",children:[b(u),":"]}),e.jsx("div",{className:"flex-grow",children:e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5",children:e.jsx("div",{className:"bg-indigo-500 h-2.5 rounded-full",style:{width:`${f}%`}})})}),e.jsx("div",{className:"w-8 text-right",children:f})]},u))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ— æ€§æ ¼ç‰¹è´¨æ•°æ®"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"ç›®æ ‡"}),d.goals&&d.goals.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.goals.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ— ç›®æ ‡"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"åŠ¨æœº"}),d.motivations&&d.motivations.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.motivations.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ— åŠ¨æœº"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"ææƒ§"}),d.fears&&d.fears.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.fears.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ— ææƒ§"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"å¯¹è¯é£æ ¼"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.dialogueStyle||"æ— ç‰¹å®šå¯¹è¯é£æ ¼"})]})]}),Y=()=>{const u=te.getAgentRelationships(s);return e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"è§’è‰²å…³ç³»"}),Object.keys(u).length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ²¡æœ‰ä¸å…¶ä»–è§’è‰²çš„å…³ç³»"}):e.jsx("div",{className:"space-y-4",children:Object.entries(u).map(([f,H])=>{const Q=m.find(X=>X.id===f);return Q?e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:Q.name||f}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["å…³ç³»ç±»å‹: ",H.type||"æœªå®šä¹‰"]})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600",onClick:()=>{alert("ç¼–è¾‘å…³ç³»åŠŸèƒ½å°šæœªå®ç°")},children:"ç¼–è¾‘"})]}),H.factors&&e.jsx("div",{className:"mt-3 space-y-2",children:Object.entries(H.factors).map(([X,se])=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"w-20 font-medium",children:[F(X),":"]}),e.jsx("div",{className:"flex-grow",children:e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5",children:e.jsx("div",{className:"bg-indigo-500 h-2.5 rounded-full",style:{width:`${se}%`}})})}),e.jsx("div",{className:"w-8 text-right",children:se})]},X))})]},f):null})})]})},P=()=>{const u=d.inventory||[];return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ç‰©å“æ "}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:()=>{alert("æ·»åŠ ç‰©å“åŠŸèƒ½å°šæœªå®ç°")},children:"æ·»åŠ ç‰©å“"})]}),u.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"ç‰©å“æ ä¸ºç©º"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:u.map((f,H)=>e.jsxs("li",{className:"py-3 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f.name||f.id}),f.description&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:f.description})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{alert("ç§»é™¤ç‰©å“åŠŸèƒ½å°šæœªå®ç°")},children:"ç§»é™¤"})]},H))})]})},z=()=>{const u=d.status||[];return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"çŠ¶æ€æ•ˆæœ"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:()=>{alert("æ·»åŠ çŠ¶æ€åŠŸèƒ½å°šæœªå®ç°")},children:"æ·»åŠ çŠ¶æ€"})]}),u.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"æ²¡æœ‰çŠ¶æ€æ•ˆæœ"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:u.map((f,H)=>e.jsxs("li",{className:"py-3 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f.name||f.id}),f.description&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:f.description}),f.duration&&e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["æŒç»­æ—¶é—´: ",f.duration]})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{alert("ç§»é™¤çŠ¶æ€åŠŸèƒ½å°šæœªå®ç°")},children:"ç§»é™¤"})]},H))})]})},w=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:i?"åˆ›å»ºè§’è‰²":"ç¼–è¾‘è§’è‰²"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"åç§°"}),e.jsx("input",{type:"text",name:"name",value:l.name||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ç±»å‹"}),e.jsxs("select",{name:"type",value:l.type||M.NPC,onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:M.NPC,children:"NPC"}),e.jsx("option",{value:M.PLAYER,children:"ç©å®¶"}),e.jsx("option",{value:M.GM,children:"æ¸¸æˆä¸»æŒäºº"}),e.jsx("option",{value:M.ENVIRONMENT,children:"ç¯å¢ƒ"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æè¿°"}),e.jsx("textarea",{name:"description",value:l.description||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"èƒŒæ™¯"}),e.jsx("textarea",{name:"background",value:l.background||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"å¤–è²Œ"}),e.jsx("textarea",{name:"appearance",value:l.appearance||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"å¯¹è¯é£æ ¼"}),e.jsx("textarea",{name:"dialogueStyle",value:l.dialogueStyle||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ä½ç½®"}),e.jsx("input",{type:"text",name:"location",value:l.location||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æ€§æ ¼ç‰¹è´¨"}),l.personality&&e.jsx("div",{className:"space-y-4",children:Object.entries(l.personality).map(([u,f])=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx("label",{className:"text-gray-700 dark:text-gray-300",children:b(u)}),e.jsx("span",{children:f})]}),e.jsx("input",{type:"range",name:`personality.${u}`,value:f,onChange:j,min:"0",max:"100",className:"w-full"})]},u))})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500",onClick:()=>{o(!1),a(!1)},children:"å–æ¶ˆ"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",children:"ä¿å­˜"})]})]})]}),b=u=>{switch(u){case C.OPENNESS:return"å¼€æ”¾æ€§";case C.CONSCIENTIOUSNESS:return"å°½è´£æ€§";case C.EXTRAVERSION:return"å¤–å‘æ€§";case C.AGREEABLENESS:return"äº²å’Œæ€§";case C.NEUROTICISM:return"ç¥ç»è´¨";default:return u}},F=u=>{switch(u){case"trust":return"ä¿¡ä»»åº¦";case"intimacy":return"äº²å¯†åº¦";case"respect":return"å°Šé‡åº¦";case"loyalty":return"å¿ è¯šåº¦";case"dependency":return"ä¾èµ–åº¦";default:return u}};return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"è§’è‰²ç®¡ç†"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-1",children:_()}),e.jsx("div",{className:"md:col-span-2",children:i||n?w():E()})]})]})},K={AGENT_RESPONSE:"agent_response",ENVIRONMENT_DESCRIPTION:"environment_description",STORY_PROGRESSION:"story_progression",DIALOGUE_GENERATION:"dialogue_generation",ACTION_RESULT:"action_result",WORLD_BUILDING:"world_building",CHARACTER_CREATION:"character_creation"};class Me{constructor(){this.templates={[K.AGENT_RESPONSE]:this._agentResponseTemplate,[K.ENVIRONMENT_DESCRIPTION]:this._environmentDescriptionTemplate,[K.STORY_PROGRESSION]:this._storyProgressionTemplate,[K.DIALOGUE_GENERATION]:this._dialogueGenerationTemplate,[K.ACTION_RESULT]:this._actionResultTemplate,[K.WORLD_BUILDING]:this._worldBuildingTemplate,[K.CHARACTER_CREATION]:this._characterCreationTemplate}}buildPrompt(t,s){const r=this.templates[t];if(!r)throw new Error(`æœªçŸ¥çš„æç¤ºç±»å‹: ${t}`);const n=N.getState(),a={...s,gameState:n,currentTurn:n.turn,currentPhase:n.phase};return{text:r.call(this,a),type:t,timestamp:new Date().toISOString(),context:a}}_agentResponseTemplate(t){var g,x,d;const{agent:s,action:r,history:n}=t;if(!s)throw new Error("ç¼ºå°‘è§’è‰²ä¿¡æ¯");const a=typeof s=="string"?A.getAgent(s):s;if(!a)throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${s}`);let i=null;r&&r.actorId&&r.actorId!==a.id&&(i=te.getRelationship(a.id,r.actorId));const o=n||U.getRecentHistory(10),l=this._formatHistoryForPrompt(o),c=this._buildCharacterCardPrompt(a),h=this._buildSceneInfoPrompt(t);return`ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”AIï¼Œç°åœ¨ä½ å°†æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š

${c}

å½“å‰åœºæ™¯ï¼š
${h}

å†å²è®°å½•ï¼š
${l}

${r?`æœ€è¿‘çš„è¡Œä¸ºï¼š
ç±»å‹ï¼š${r.type}
æ‰§è¡Œè€…ï¼š${r.actorName||r.actorId||"æœªçŸ¥"}
å†…å®¹ï¼š${r.content}
${r.targetId===a.id?"è¿™ä¸ªè¡Œä¸ºç›´æ¥é’ˆå¯¹ä½ ã€‚":""}`:""}

${i?`ä¸è¡Œä¸ºæ‰§è¡Œè€…çš„å…³ç³»ï¼š
ç±»å‹ï¼š${i.type}
ä¿¡ä»»åº¦ï¼š${((g=i.factors)==null?void 0:g.trust)||50}/100
äº²å¯†åº¦ï¼š${((x=i.factors)==null?void 0:x.intimacy)||0}/100
å°Šé‡åº¦ï¼š${((d=i.factors)==null?void 0:d.respect)||50}/100`:""}

è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šã€å½“å‰æƒ…ç»ªçŠ¶æ€ã€ä¸å…¶ä»–è§’è‰²çš„å…³ç³»ä»¥åŠåœºæ™¯ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸€ä¸ªåˆé€‚çš„å“åº”ã€‚
å“åº”åº”è¯¥åæ˜ ä½ çš„æ€§æ ¼ç‰¹ç‚¹ã€å½“å‰æƒ…ç»ªå’Œå¯¹äº‹ä»¶çš„æ€åº¦ã€‚

è¯·ç”¨ç¬¬ä¸€äººç§°å›åº”ï¼Œä¸è¦åœ¨å›åº”ä¸­åŒ…å«æ—ç™½æˆ–åŠ¨ä½œæè¿°ã€‚`}_environmentDescriptionTemplate(t){var o,l,c,h,g,x,d,R;const{locationId:s,details:r}=t,n=N.getState(),a=s?(l=(o=n.environment)==null?void 0:o.locations)==null?void 0:l[s]:(g=(c=n.environment)==null?void 0:c.locations)==null?void 0:g[(h=n.environment)==null?void 0:h.currentLocation];if(!a)throw new Error(`ä½ç½®ä¸å­˜åœ¨: ${s||((x=n.environment)==null?void 0:x.currentLocation)}`);const i=A.getAllAgents().filter(T=>{var O;return T.location===(s||((O=n.environment)==null?void 0:O.currentLocation))}).map(T=>({id:T.id,name:T.name,type:T.type,description:T.description}));return`è¯·ä¸ºä»¥ä¸‹æ¸¸æˆåœºæ™¯ç”Ÿæˆä¸€æ®µè¯¦ç»†çš„ç¯å¢ƒæè¿°ï¼š

ä½ç½®åç§°ï¼š${a.name}
åŸºæœ¬æè¿°ï¼š${a.description||"æ— æè¿°"}
æ—¶é—´ï¼š${((d=n.environment)==null?void 0:d.currentTime)||"æœªçŸ¥"}
å¤©æ°”ï¼š${((R=n.environment)==null?void 0:R.currentWeather)||"æœªçŸ¥"}

${r?`é¢å¤–ç»†èŠ‚ï¼š${r}`:""}

è¯¥ä½ç½®çš„è§’è‰²ï¼š
${i.length>0?i.map(T=>`- ${T.name}ï¼š${T.description||"æ— æè¿°"}`).join(`
`):"æ²¡æœ‰è§’è‰²åœ¨æ­¤ä½ç½®"}

è¯·ç”Ÿæˆä¸€æ®µç”ŸåŠ¨ã€è¯¦ç»†çš„ç¯å¢ƒæè¿°ï¼ŒåŒ…æ‹¬è§†è§‰ã€å¬è§‰ã€å—…è§‰ç­‰æ„Ÿå®˜ç»†èŠ‚ï¼Œä»¥åŠç¯å¢ƒçš„æ°›å›´å’Œæƒ…ç»ªã€‚
æè¿°åº”è¯¥æœ‰åŠ©äºç©å®¶æƒ³è±¡è‡ªå·±èº«å¤„å…¶ä¸­çš„æ„Ÿè§‰ã€‚
ä¸è¦åŒ…å«è§’è‰²çš„å¯¹è¯æˆ–è¡ŒåŠ¨ï¼Œåªæè¿°ç¯å¢ƒæœ¬èº«ã€‚`}_storyProgressionTemplate(t){var l,c;const{currentPlot:s,direction:r,intensity:n}=t,a=N.getState(),i=U.getRecentHistory(15),o=this._formatHistoryForPrompt(i);return`ä½œä¸ºæ¸¸æˆä¸»æŒäººï¼Œè¯·æ ¹æ®å½“å‰æ•…äº‹æƒ…å†µï¼Œç”Ÿæˆä¸‹ä¸€æ­¥çš„æ•…äº‹å‘å±•ï¼š

å½“å‰æ•…äº‹æ¦‚è¦ï¼š
${s||((l=a.storyInfo)==null?void 0:l.currentPlot)||"æ— å…·ä½“æƒ…èŠ‚"}

ä¸–ç•ŒèƒŒæ™¯ï¼š
${((c=a.worldBook)==null?void 0:c.mainSetting)||"æ— å…·ä½“èƒŒæ™¯"}

æœ€è¿‘çš„äº‹ä»¶ï¼š
${o}

${r?`æœŸæœ›çš„å‘å±•æ–¹å‘ï¼š${r}`:""}
${n?`äº‹ä»¶å¼ºåº¦ï¼ˆ1-10ï¼‰ï¼š${n}`:""}

è¯·ç”Ÿæˆæ¥ä¸‹æ¥çš„æ•…äº‹å‘å±•ï¼ŒåŒ…æ‹¬ï¼š
1. æ–°çš„äº‹ä»¶æˆ–è½¬æŠ˜
2. å¯èƒ½å‡ºç°çš„å†²çªæˆ–æŒ‘æˆ˜
3. NPCçš„å¯èƒ½ååº”
4. ç¯å¢ƒæˆ–åœºæ™¯çš„å˜åŒ–

æ•…äº‹å‘å±•åº”è¯¥ç¬¦åˆå½“å‰çš„æƒ…å¢ƒå’Œè§’è‰²è®¾å®šï¼Œå¹¶ä¸ºç©å®¶æä¾›æœ‰è¶£çš„äº’åŠ¨æœºä¼šã€‚
è¯·é¿å…ç›´æ¥è§£å†³æ‰€æœ‰é—®é¢˜æˆ–åˆ›é€ æ— æ³•å…‹æœçš„éšœç¢ã€‚`}_dialogueGenerationTemplate(t){var l;const{characters:s,topic:r,tone:n,length:a}=t,i=[];if(Array.isArray(s))for(const c of s){const h=A.getAgent(c);h&&i.push({id:h.id,name:h.name,description:h.description,personality:h.personality,dialogueStyle:h.dialogueStyle})}const o=[];for(let c=0;c<i.length;c++)for(let h=c+1;h<i.length;h++){const g=i[c],x=i[h],d=te.getRelationship(g.id,x.id);d&&o.push({character1:g.name,character2:x.name,type:d.type,trust:((l=d.factors)==null?void 0:l.trust)||50})}return`è¯·ä¸ºä»¥ä¸‹è§’è‰²ç”Ÿæˆä¸€æ®µå¯¹è¯ï¼š

å‚ä¸è§’è‰²ï¼š
${i.map(c=>`- ${c.name}ï¼š${c.description||"æ— æè¿°"}
   å¯¹è¯é£æ ¼ï¼š${c.dialogueStyle||"æ— ç‰¹å®šé£æ ¼"}`).join(`
`)}

${o.length>0?`è§’è‰²å…³ç³»ï¼š
${o.map(c=>`- ${c.character1} å’Œ ${c.character2}ï¼š${c.type}å…³ç³»ï¼Œä¿¡ä»»åº¦ ${c.trust}/100`).join(`
`)}`:""}

å¯¹è¯ä¸»é¢˜ï¼š${r||"è‡ªç”±å‘æŒ¥"}
å¯¹è¯è¯­æ°”ï¼š${n||"æ ¹æ®è§’è‰²æ€§æ ¼å†³å®š"}
å¯¹è¯é•¿åº¦ï¼š${a||"é€‚ä¸­"}

è¯·æ ¹æ®è§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹å’Œå½¼æ­¤çš„å…³ç³»ï¼Œç”Ÿæˆä¸€æ®µè‡ªç„¶ã€ç¬¦åˆäººç‰©è®¾å®šçš„å¯¹è¯ã€‚
å¯¹è¯åº”è¯¥å±•ç°è§’è‰²çš„ä¸ªæ€§å’Œä»–ä»¬ä¹‹é—´çš„å…³ç³»åŠ¨æ€ã€‚
è¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

è§’è‰²åï¼šå¯¹è¯å†…å®¹`}_actionResultTemplate(t){const{action:s,actor:r,difficulty:n,randomFactor:a}=t;if(!s)throw new Error("ç¼ºå°‘è¡Œä¸ºä¿¡æ¯");const i=r?typeof r=="string"?A.getAgent(r):r:null;return`è¯·ä¸ºä»¥ä¸‹æ¸¸æˆè¡Œä¸ºç”Ÿæˆä¸€ä¸ªç»“æœæè¿°ï¼š

è¡Œä¸ºç±»å‹ï¼š${s.type}
è¡Œä¸ºå†…å®¹ï¼š${s.content}
æ‰§è¡Œè€…ï¼š${i?i.name:s.actorName||s.actorId||"æœªçŸ¥"}
${s.targetId?`ç›®æ ‡ï¼š${s.targetName||s.targetId}`:""}

${i?`æ‰§è¡Œè€…ä¿¡æ¯ï¼š
- æè¿°ï¼š${i.description||"æ— æè¿°"}
- ç›¸å…³æŠ€èƒ½ï¼š${JSON.stringify(i.skills||{})}`:""}

${n?`éš¾åº¦ç­‰çº§ï¼ˆ1-10ï¼‰ï¼š${n}`:""}
${a?`éšæœºå› ç´ ï¼ˆ1-10ï¼‰ï¼š${a}`:""}

è¯·ç”Ÿæˆè¿™ä¸ªè¡Œä¸ºçš„ç»“æœæè¿°ï¼ŒåŒ…æ‹¬ï¼š
1. è¡Œä¸ºçš„ç›´æ¥æ•ˆæœ
2. å¯èƒ½çš„å‰¯ä½œç”¨æˆ–æ„å¤–æƒ…å†µ
3. å¯¹å‘¨å›´ç¯å¢ƒæˆ–è§’è‰²çš„å½±å“

ç»“æœåº”è¯¥ç¬¦åˆé€»è¾‘ï¼Œå¹¶è€ƒè™‘è§’è‰²çš„èƒ½åŠ›å’Œè¡Œä¸ºçš„éš¾åº¦ã€‚
å¦‚æœæœ‰éšæœºå› ç´ ï¼Œè¯·é€‚å½“å¼•å…¥ä¸€äº›ä¸ç¡®å®šæ€§ã€‚
æè¿°åº”è¯¥ç”ŸåŠ¨å…·ä½“ï¼Œé¿å…æ¨¡ç³Šæˆ–è¿‡äºæ¦‚æ‹¬çš„è¡¨è¿°ã€‚`}_worldBuildingTemplate(t){const{theme:s,elements:r,tone:n,detail:a}=t,o=N.getState().worldBook||{};return`è¯·ä¸ºä¸€ä¸ªTRPGæ¸¸æˆåˆ›å»ºæˆ–æ‰©å±•ä»¥ä¸‹ä¸–ç•Œè®¾å®šï¼š

${o.mainSetting?`ç°æœ‰ä¸–ç•ŒèƒŒæ™¯ï¼š
${o.mainSetting}`:""}

ä¸»é¢˜ï¼š${s||"æœªæŒ‡å®š"}
${r?`éœ€è¦åŒ…å«çš„å…ƒç´ ï¼š${r}`:""}
è¯­è°ƒï¼š${n||"é€‚ä¸­"}
ç»†èŠ‚ç¨‹åº¦ï¼š${a||"ä¸­ç­‰"}

è¯·åˆ›å»ºä»¥ä¸‹å†…å®¹ï¼š

1. ä¸–ç•Œæ¦‚è¿°
   - åŸºæœ¬è®¾å®šå’ŒèƒŒæ™¯
   - ä¸–ç•Œå†å²çš„å…³é”®äº‹ä»¶
   - å½“å‰ä¸–ç•ŒçŠ¶æ€

2. åœ°ç†ç¯å¢ƒ
   - ä¸»è¦åœ°åŒºæˆ–ä½ç½®æè¿°
   - ç‰¹æ®Šåœ°æ ‡æˆ–é‡è¦åœºæ‰€
   - ç¯å¢ƒç‰¹å¾å’Œæ°”å€™

3. ç¤¾ä¼šç»“æ„
   - ä¸»è¦ç§æ—æˆ–ç¾¤ä½“
   - æ”¿æ²»ä½“ç³»å’ŒæƒåŠ›ç»“æ„
   - ç»æµç³»ç»Ÿå’Œè´¸æ˜“

4. æ–‡åŒ–ä¸ä¿¡ä»°
   - ä¸»è¦å®—æ•™æˆ–ä¿¡ä»°ç³»ç»Ÿ
   - æ–‡åŒ–ä¹ ä¿—å’Œä¼ ç»Ÿ
   - è‰ºæœ¯ã€éŸ³ä¹å’Œæ–‡å­¦

5. é­”æ³•æˆ–ç§‘æŠ€ç³»ç»Ÿ
   - åŸºæœ¬åŸç†å’Œé™åˆ¶
   - å¸¸è§åº”ç”¨å’Œå½±å“
   - ç‰¹æ®Šèƒ½åŠ›æˆ–è£…ç½®

è¯·ç¡®ä¿è®¾å®šå…·æœ‰å†…éƒ¨ä¸€è‡´æ€§ï¼Œå¹¶ä¸ºç©å®¶æä¾›è¶³å¤Ÿçš„æ¢ç´¢å’Œäº’åŠ¨ç©ºé—´ã€‚
é¿å…è¿‡äºå¤æ‚æˆ–éš¾ä»¥ç†è§£çš„è®¾å®šï¼Œä¿æŒå¯ç©æ€§å’Œè¶£å‘³æ€§ã€‚`}_characterCreationTemplate(t){var l;const{type:s,role:r,traits:n,background:a}=t,o=((l=N.getState().worldBook)==null?void 0:l.mainSetting)||"æ— ç‰¹å®šä¸–ç•Œè®¾å®š";return`è¯·ä¸ºTRPGæ¸¸æˆåˆ›å»ºä¸€ä¸ªè¯¦ç»†çš„è§’è‰²è®¾å®šï¼š

è§’è‰²ç±»å‹ï¼š${s||M.NPC}
è§’è‰²è§’è‰²ï¼š${r||"æœªæŒ‡å®š"}
${n?`æ€§æ ¼ç‰¹ç‚¹ï¼š${n}`:""}
${a?`èƒŒæ™¯è¦ç´ ï¼š${a}`:""}

ä¸–ç•Œè®¾å®šï¼š
${o}

è¯·åˆ›å»ºä»¥ä¸‹å†…å®¹ï¼š

1. åŸºæœ¬ä¿¡æ¯
   - å§“å
   - å¹´é¾„
   - æ€§åˆ«
   - å¤–è²Œæè¿°

2. èƒŒæ™¯æ•…äº‹
   - æˆé•¿ç»å†
   - å…³é”®äº‹ä»¶
   - åŠ¨æœºå’Œç›®æ ‡

3. æ€§æ ¼ç‰¹è´¨
   - ä¸»è¦æ€§æ ¼ç‰¹ç‚¹
   - ä¼˜ç‚¹å’Œç¼ºç‚¹
   - ææƒ§å’Œå–œå¥½

4. å…³ç³»ç½‘ç»œ
   - å®¶äººå’Œæœ‹å‹
   - ç›Ÿå‹å’Œæ•Œäºº
   - ç¤¾ä¼šåœ°ä½

5. èƒ½åŠ›å’ŒæŠ€èƒ½
   - ä¸“é•¿é¢†åŸŸ
   - ç‰¹æ®Šèƒ½åŠ›
   - å¼±ç‚¹å’Œé™åˆ¶

6. å¯¹è¯é£æ ¼
   - è¯´è¯æ–¹å¼
   - å¸¸ç”¨è¯­å’Œå£å¤´ç¦…
   - è¡¨è¾¾ä¹ æƒ¯

è¯·ç¡®ä¿è§’è‰²è®¾å®šç¬¦åˆä¸–ç•ŒèƒŒæ™¯ï¼Œå¹¶å…·æœ‰æ·±åº¦å’Œå¤æ‚æ€§ã€‚
è§’è‰²åº”è¯¥æœ‰æ˜ç¡®çš„åŠ¨æœºå’Œç›®æ ‡ï¼Œä»¥åŠè¶³å¤Ÿçš„å†²çªç‚¹å’Œå‘å±•ç©ºé—´ã€‚
é¿å…åˆ›å»ºå®Œç¾æ— ç¼ºæˆ–å•ä¸€ç»´åº¦çš„è§’è‰²ï¼Œåº”è¯¥æœ‰æ˜æ˜¾çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚`}_formatHistoryForPrompt(t){return!t||t.length===0?"æ— å†å²è®°å½•":t.map(s=>{const r=s.timestamp?new Date(s.timestamp).toLocaleTimeString():"";switch(s.type){case"action":return`[${r}] ${s.actorName||s.actorId}: ${s.content}`;case"npc_response":return`[${r}] ${s.npcId}: ${s.content}`;case"environment":return`[${r}] ç¯å¢ƒ: ${s.description}`;case"system":return`[${r}] ç³»ç»Ÿ: ${s.message}`;default:return`[${r}] ${JSON.stringify(s)}`}}).join(`
`)}_buildCharacterCardPrompt(t){var s,r,n,a,i;return t?`è§’è‰²åç§°ï¼š${t.name}
è§’è‰²ç±»å‹ï¼š${t.type}
æè¿°ï¼š${t.description||"æ— æè¿°"}
èƒŒæ™¯ï¼š${t.background||"æ— èƒŒæ™¯"}
å¤–è²Œï¼š${t.appearance||"æ— å¤–è²Œæè¿°"}

æ€§æ ¼ç‰¹è´¨ï¼š
- å¼€æ”¾æ€§ï¼š${((s=t.personality)==null?void 0:s.openness)||50}/100
- å°½è´£æ€§ï¼š${((r=t.personality)==null?void 0:r.conscientiousness)||50}/100
- å¤–å‘æ€§ï¼š${((n=t.personality)==null?void 0:n.extraversion)||50}/100
- äº²å’Œæ€§ï¼š${((a=t.personality)==null?void 0:a.agreeableness)||50}/100
- ç¥ç»è´¨ï¼š${((i=t.personality)==null?void 0:i.neuroticism)||50}/100

ç›®æ ‡ï¼š${Array.isArray(t.goals)?t.goals.join(", "):t.goals||"æ— ç‰¹å®šç›®æ ‡"}
åŠ¨æœºï¼š${Array.isArray(t.motivations)?t.motivations.join(", "):t.motivations||"æ— ç‰¹å®šåŠ¨æœº"}
ææƒ§ï¼š${Array.isArray(t.fears)?t.fears.join(", "):t.fears||"æ— ç‰¹å®šææƒ§"}

å½“å‰æƒ…ç»ªï¼š${t.currentEmotion||"ä¸­æ€§"}ï¼ˆå¼ºåº¦ï¼š${t.emotionIntensity||50}/100ï¼‰
å¯¹è¯é£æ ¼ï¼š${t.dialogueStyle||"æ— ç‰¹å®šé£æ ¼"}`:"æ— è§’è‰²ä¿¡æ¯"}_buildSceneInfoPrompt(t){var i,o,l,c,h;const s=N.getState(),r=((i=s.environment)==null?void 0:i.currentLocation)||"unknown",n=((l=(o=s.environment)==null?void 0:o.locations)==null?void 0:l[r])||{name:"æœªçŸ¥ä½ç½®",description:"æ— æè¿°"},a=A.getAllAgents().filter(g=>{var x;return g.location===r&&g.id!==((x=t.agent)==null?void 0:x.id)}).map(g=>g.name).join(", ");return`ä½ç½®ï¼š${n.name}
æè¿°ï¼š${n.description}
æ—¶é—´ï¼š${((c=s.environment)==null?void 0:c.currentTime)||"æœªçŸ¥"}
å¤©æ°”ï¼š${((h=s.environment)==null?void 0:h.currentWeather)||"æœªçŸ¥"}
å…¶ä»–åœ¨åœºè§’è‰²ï¼š${a||"æ— "}`}registerCustomTemplate(t,s){if(typeof s!="function")throw new Error("æ¨¡æ¿å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°");this.templates[t]=s}getAvailablePromptTypes(){return Object.keys(this.templates)}}const Ge=new Me,B={OPENAI:"openai",LOCAL:"local",MOCK:"mock"},J={CHAT:"chat",COMPLETION:"completion",EMBEDDING:"embedding"},de={provider:B.OPENAI,model:"gpt-3.5-turbo",modelType:J.CHAT,temperature:.7,maxTokens:1e3,apiKey:"",apiEndpoint:"",useProxy:!1,proxyUrl:"",timeout:3e4,retries:3,mockResponses:{}};class He{constructor(){this.config={...de},this.mockResponses={},this.requestQueue=[],this.isProcessingQueue=!1,this.rateLimitDelay=1e3,this.lastRequestTime=0}initialize(t={}){this.config={...de,...t};const s=N.getState();s.llmConfig&&(this.config={...this.config,...s.llmConfig}),t.mockResponses&&(this.mockResponses=t.mockResponses),console.log("LLMé€‚é…å™¨å·²åˆå§‹åŒ–ï¼Œæä¾›å•†:",this.config.provider)}updateConfig(t){this.config={...this.config,...t},N.updateState({llmConfig:this.config}),console.log("LLMé€‚é…å™¨é…ç½®å·²æ›´æ–°")}async sendRequest(t,s={}){try{const r={...this.config,...s};switch(r.provider){case B.OPENAI:return await this._sendOpenAIRequest(t,r);case B.LOCAL:return await this._sendLocalRequest(t,r);case B.MOCK:return await this._sendMockRequest(t,r);default:throw new Error(`ä¸æ”¯æŒçš„LLMæä¾›å•†: ${r.provider}`)}}catch(r){if(console.error("LLMè¯·æ±‚å¤±è´¥:",r),s.retries>0)return console.log(`é‡è¯•è¯·æ±‚ï¼Œå‰©ä½™é‡è¯•æ¬¡æ•°: ${s.retries-1}`),this.sendRequest(t,{...s,retries:s.retries-1});throw r}}async queueRequest(t,s={}){return new Promise((r,n)=>{this.requestQueue.push({prompt:t,options:s,resolve:r,reject:n}),this._processQueue()})}async _processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{for(;this.requestQueue.length>0;){const{prompt:t,options:s,resolve:r,reject:n}=this.requestQueue.shift(),a=Date.now(),i=Math.max(0,this.lastRequestTime+this.rateLimitDelay-a);i>0&&await new Promise(o=>setTimeout(o,i));try{const o=await this.sendRequest(t,s);r(o)}catch(o){n(o)}this.lastRequestTime=Date.now()}}finally{this.isProcessingQueue=!1}}}async _sendOpenAIRequest(t,s){var i,o,l,c,h;if(!s.apiKey)throw new Error("ç¼ºå°‘OpenAI APIå¯†é’¥");const r=s.apiEndpoint||"https://api.openai.com/v1",n=s.modelType===J.CHAT?`${r}/chat/completions`:`${r}/completions`;let a;if(s.modelType===J.CHAT){const g=Array.isArray(t)?t:[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªTRPGæ¸¸æˆä¸­çš„AIåŠ©æ‰‹ã€‚"},{role:"user",content:t}];a={model:s.model,messages:g,temperature:s.temperature,max_tokens:s.maxTokens,top_p:s.topP||1,frequency_penalty:s.frequencyPenalty||0,presence_penalty:s.presencePenalty||0}}else a={model:s.model,prompt:Array.isArray(t)?t.map(g=>g.content).join(`
`):t,temperature:s.temperature,max_tokens:s.maxTokens,top_p:s.topP||1,frequency_penalty:s.frequencyPenalty||0,presence_penalty:s.presencePenalty||0};try{const g=s.useProxy?`${s.proxyUrl}${n}`:n,x=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify(a),signal:s.timeout?AbortSignal.timeout(s.timeout):void 0});if(!x.ok){const T=await x.json().catch(()=>({}));throw new Error(`OpenAI APIè¯·æ±‚å¤±è´¥: ${x.status} ${x.statusText}, ${JSON.stringify(T)}`)}const d=await x.json();let R;return s.modelType===J.CHAT?R={text:((o=(i=d.choices[0])==null?void 0:i.message)==null?void 0:o.content)||"",role:((c=(l=d.choices[0])==null?void 0:l.message)==null?void 0:c.role)||"assistant",usage:d.usage,model:d.model,id:d.id,provider:B.OPENAI}:R={text:((h=d.choices[0])==null?void 0:h.text)||"",usage:d.usage,model:d.model,id:d.id,provider:B.OPENAI},R}catch(g){throw console.error("OpenAI APIè¯·æ±‚é”™è¯¯:",g),g}}async _sendLocalRequest(t,s){return console.log("å‘é€è¯·æ±‚åˆ°æœ¬åœ°æ¨¡å‹ï¼Œè¿™éœ€è¦æ ¹æ®å®é™…æƒ…å†µå®ç°"),{text:"è¿™æ˜¯æœ¬åœ°æ¨¡å‹çš„å“åº”ã€‚å®é™…å®ç°éœ€è¦æ ¹æ®ä½ ä½¿ç”¨çš„æœ¬åœ°æ¨¡å‹æ¥å®šåˆ¶ã€‚",model:s.model,provider:B.LOCAL}}async _sendMockRequest(t,s){console.log("å‘é€æ¨¡æ‹Ÿè¯·æ±‚ï¼Œç”¨äºæµ‹è¯•");const r=Array.isArray(t)?t.map(a=>a.content).join(`
`):t;let n="è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå“åº”ã€‚";for(const[a,i]of Object.entries(this.mockResponses))if(r.includes(a)){n=i;break}return await new Promise(a=>setTimeout(a,500)),{text:n,model:"mock-model",provider:B.MOCK}}addMockResponse(t,s){this.mockResponses[t]=s}async chatCompletion(t,s={}){return this.sendRequest(t,{...s,modelType:J.CHAT})}async textCompletion(t,s={}){return this.sendRequest(t,{...s,modelType:J.COMPLETION})}getConfig(){return{...this.config}}async checkConnection(){try{return!!await this.sendRequest("æµ‹è¯•è¿æ¥",{maxTokens:5,temperature:.1})}catch(t){return console.error("APIè¿æ¥æ£€æŸ¥å¤±è´¥:",t),!1}}estimateTokens(t){return(t.match(/[\u4e00-\u9fa5]/g)||[]).length/t.length>.5?Math.ceil(t.length/1.5):Math.ceil(t.length/4)}}const ee=new He,Ue=()=>{const[m,t]=y.useState({mainSetting:"",entries:[]}),[s,r]=y.useState(null),[n,a]=y.useState(!1),[i,o]=y.useState(!1),[l,c]=y.useState({}),[h,g]=y.useState(""),[x,d]=y.useState([]),[R,T]=y.useState("all"),[O,v]=y.useState(!1),[j,G]=y.useState(""),[_,E]=y.useState("");y.useEffect(()=>{W()},[]);const W=()=>{const I=N.getState().worldBook||{mainSetting:"",entries:[]};t(I);const q=[...new Set(I.entries.map(ae=>ae.category))].filter(Boolean);d(q),!s&&I.entries.length>0&&r(I.entries[0].id)},Y=p=>{N.updateState({worldBook:p}),t(p)},P=s?m.entries.find(p=>p.id===s):null,z=m.entries.filter(p=>{if(R!=="all"&&p.category!==R)return!1;if(h){const I=h.toLowerCase();return p.name&&p.name.toLowerCase().includes(I)||p.content&&p.content.toLowerCase().includes(I)||p.category&&p.category.toLowerCase().includes(I)}return!0}),w=p=>{r(p),a(!1),o(!1)},b=()=>{o(!0),a(!1),r(null),c({name:"",content:"",category:"",tags:[],isActive:!0})},F=()=>{P&&(a(!0),o(!1),c({...P}))},u=()=>{if(P&&window.confirm(`ç¡®å®šè¦åˆ é™¤æ¡ç›® "${P.name}" å—ï¼Ÿ`)){const p=m.entries.filter(I=>I.id!==s);Y({...m,entries:p}),r(null)}},f=()=>{a(!0),o(!1),r(null),c({mainSetting:m.mainSetting||""})},H=p=>{const{name:I,value:q}=p.target;c({...l,[I]:q})},Q=p=>{const q=p.target.value.split(",").map(ae=>ae.trim()).filter(Boolean);c({...l,tags:q})},X=p=>{p.preventDefault();try{if(l.mainSetting!==void 0)Y({...m,mainSetting:l.mainSetting});else if(i){const I={...l,id:`entry_${Date.now()}`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};Y({...m,entries:[...m.entries,I]}),l.category&&!x.includes(l.category)&&d([...x,l.category])}else if(n&&s){const I=m.entries.map(q=>q.id===s?{...q,...l,updatedAt:new Date().toISOString()}:q);Y({...m,entries:I}),l.category&&!x.includes(l.category)&&d([...x,l.category])}o(!1),a(!1)}catch(I){console.error("ä¿å­˜æ¡ç›®å¤±è´¥:",I),alert(`ä¿å­˜å¤±è´¥: ${I.message}`)}},se=async()=>{try{v(!0);const p=Ge.buildPrompt("world_building",{theme:_,elements:j,tone:"immersive",detail:"high"}),I=await ee.sendRequest(p.text,{temperature:.7,maxTokens:1e3});Y({...m,mainSetting:I.text}),G(""),E(""),v(!1)}catch(p){console.error("ç”Ÿæˆä¸–ç•Œè®¾å®šå¤±è´¥:",p),alert(`ç”Ÿæˆå¤±è´¥: ${p.message}`),v(!1)}},ge=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ä¸–ç•Œä¹¦æ¡ç›®"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:b,children:"åˆ›å»ºæ¡ç›®"})]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"æœç´¢æ¡ç›®...",value:h,onChange:p=>g(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"}),e.jsxs("select",{value:R,onChange:p=>T(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"æ‰€æœ‰ç±»åˆ«"}),x.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),z.length===0?e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:m.entries.length===0?'æ²¡æœ‰æ¡ç›®ã€‚ç‚¹å‡»"åˆ›å»ºæ¡ç›®"æŒ‰é’®æ·»åŠ ä¸€ä¸ªã€‚':"æ²¡æœ‰åŒ¹é…çš„æ¡ç›®ã€‚"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:z.map(p=>e.jsx("li",{className:"py-2",children:e.jsxs("button",{className:`w-full text-left px-3 py-2 rounded ${s===p.id?"bg-indigo-100 dark:bg-indigo-900":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,onClick:()=>w(p.id),children:[e.jsx("div",{className:"font-medium",children:p.name||"æœªå‘½åæ¡ç›®"}),p.category&&e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:p.category})]})},p.id))})]}),ue=()=>P?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:P.name||"æœªå‘½åæ¡ç›®"}),P.category&&e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["ç±»åˆ«: ",P.category]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:F,children:"ç¼–è¾‘"}),e.jsx("button",{className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",onClick:u,children:"åˆ é™¤"})]})]})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"å†…å®¹"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded border border-gray-200 dark:border-gray-700",children:P.content||"æ— å†…å®¹"})]}),P.tags&&P.tags.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"æ ‡ç­¾"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.tags.map((p,I)=>e.jsx("span",{className:"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-sm",children:p},I))})]}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-4",children:["åˆ›å»ºæ—¶é—´: ",new Date(P.createdAt).toLocaleString(),e.jsx("br",{}),"æ›´æ–°æ—¶é—´: ",new Date(P.updatedAt).toLocaleString()]})]})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"è¯·é€‰æ‹©ä¸€ä¸ªæ¡ç›®æŸ¥çœ‹è¯¦æƒ…"})}),pe=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ä¸–ç•Œä¸»è¦è®¾å®š"}),e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:f,children:"ç¼–è¾‘"})]}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded border border-gray-200 dark:border-gray-700",children:m.mainSetting?e.jsx("div",{className:"whitespace-pre-line",children:m.mainSetting}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:'æ²¡æœ‰ä¸»è¦è®¾å®šã€‚ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®æ·»åŠ ã€‚'})})]}),xe=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"AIç”Ÿæˆä¸–ç•Œè®¾å®š"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ä¸»é¢˜"}),e.jsx("input",{type:"text",value:_,onChange:p=>E(p.target.value),placeholder:"ä¾‹å¦‚ï¼šä¸­ä¸–çºªå¥‡å¹»ã€èµ›åšæœ‹å…‹ã€å¤ªç©ºæ­Œå‰§...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"å…ƒç´ å’Œè¦æ±‚"}),e.jsx("textarea",{value:j,onChange:p=>G(p.target.value),placeholder:"æè¿°ä½ æƒ³è¦åŒ…å«çš„å…ƒç´ ã€ç‰¹ç‚¹æˆ–è¦æ±‚...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"4"})]}),e.jsx("button",{className:"w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed",onClick:se,disabled:O||!_&&!j,children:O?"ç”Ÿæˆä¸­...":"ç”Ÿæˆä¸–ç•Œè®¾å®š"}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"æ³¨æ„ï¼šç”Ÿæˆçš„å†…å®¹å°†æ›¿æ¢å½“å‰çš„ä¸»è¦è®¾å®šã€‚è¯·ç¡®ä¿åœ¨ç”Ÿæˆå‰å¤‡ä»½é‡è¦å†…å®¹ã€‚"})]})]}),ye=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:l.mainSetting!==void 0?"ç¼–è¾‘ä¸»è¦è®¾å®š":i?"åˆ›å»ºæ¡ç›®":"ç¼–è¾‘æ¡ç›®"}),e.jsxs("form",{onSubmit:X,children:[l.mainSetting!==void 0?e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ä¸»è¦è®¾å®š"}),e.jsx("textarea",{name:"mainSetting",value:l.mainSetting,onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"10"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"åç§°"}),e.jsx("input",{type:"text",name:"name",value:l.name||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"å†…å®¹"}),e.jsx("textarea",{name:"content",value:l.content||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"6"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ç±»åˆ«"}),e.jsx("input",{type:"text",name:"category",value:l.category||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",list:"categories"}),e.jsx("datalist",{id:"categories",children:x.map(p=>e.jsx("option",{value:p},p))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"}),e.jsx("input",{type:"text",value:l.tags?l.tags.join(", "):"",onChange:Q,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"isActive",checked:l.isActive!==!1,onChange:p=>c({...l,isActive:p.target.checked}),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"å¯ç”¨æ­¤æ¡ç›®"})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500",onClick:()=>{o(!1),a(!1)},children:"å–æ¶ˆ"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",children:"ä¿å­˜"})]})]})]});return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"ä¸–ç•Œä¹¦"}),i||n?ye():e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-1",children:[pe(),xe()]}),e.jsx("div",{className:"md:col-span-1",children:ge()}),e.jsx("div",{className:"md:col-span-1",children:ue()})]})]})},Fe=({onResetGame:m,onExportGame:t,onImportGame:s})=>{const[r,n]=y.useState({}),[a,i]=y.useState({}),[o,l]=y.useState("llm"),[c,h]=y.useState(!1),[g,x]=y.useState(null),[d,R]=y.useState(Date.now());y.useEffect(()=>{T()},[]);const T=()=>{const w=ee.getConfig();n(w);const b=N.getState();i({maxHistoryLength:b.maxHistoryLength||100,autoSave:b.autoSave!==!1,autoSaveInterval:b.autoSaveInterval||5,debugMode:b.debugMode||!1})},O=w=>{const{name:b,value:F,type:u,checked:f}=w.target;n({...r,[b]:u==="checkbox"?f:u==="number"?Number(F):F})},v=w=>{const{name:b,value:F,type:u,checked:f}=w.target;i({...a,[b]:u==="checkbox"?f:u==="number"?Number(F):F})},j=()=>{try{ee.updateConfig(r),alert("LLMé…ç½®å·²ä¿å­˜")}catch(w){console.error("ä¿å­˜LLMé…ç½®å¤±è´¥:",w),alert(`ä¿å­˜å¤±è´¥: ${w.message}`)}},G=()=>{try{N.updateState({maxHistoryLength:a.maxHistoryLength,autoSave:a.autoSave,autoSaveInterval:a.autoSaveInterval,debugMode:a.debugMode}),alert("æ¸¸æˆé…ç½®å·²ä¿å­˜")}catch(w){console.error("ä¿å­˜æ¸¸æˆé…ç½®å¤±è´¥:",w),alert(`ä¿å­˜å¤±è´¥: ${w.message}`)}},_=async()=>{try{h(!0),x(null);const w={...r};ee.updateConfig(w);const b=await ee.checkConnection();x(b?"success":"error")}catch(w){console.error("æµ‹è¯•è¿æ¥å¤±è´¥:",w),x("error")}finally{h(!1)}},E=w=>{s&&(s(w),R(Date.now()))},W=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"LLMè®¾ç½®"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æä¾›å•†"}),e.jsxs("select",{name:"provider",value:r.provider||B.OPENAI,onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:B.OPENAI,children:"OpenAI"}),e.jsx("option",{value:B.LOCAL,children:"æœ¬åœ°æ¨¡å‹"}),e.jsx("option",{value:B.MOCK,children:"æ¨¡æ‹Ÿæ¨¡å¼"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æ¨¡å‹"}),e.jsx("input",{type:"text",name:"model",value:r.model||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"ä¾‹å¦‚: gpt-3.5-turbo"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æ¨¡å‹ç±»å‹"}),e.jsxs("select",{name:"modelType",value:r.modelType||J.CHAT,onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:J.CHAT,children:"èŠå¤©æ¨¡å‹"}),e.jsx("option",{value:J.COMPLETION,children:"æ–‡æœ¬è¡¥å…¨æ¨¡å‹"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"APIå¯†é’¥"}),e.jsx("input",{type:"password",name:"apiKey",value:r.apiKey||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"è¾“å…¥ä½ çš„APIå¯†é’¥"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"APIç«¯ç‚¹ (å¯é€‰)"}),e.jsx("input",{type:"text",name:"apiEndpoint",value:r.apiEndpoint||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"ä¾‹å¦‚: https://api.openai.com/v1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æ¸©åº¦ (0-1)"}),e.jsx("input",{type:"range",name:"temperature",min:"0",max:"1",step:"0.1",value:r.temperature||.7,onChange:O,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:"æ›´ç¡®å®š (0)"}),e.jsx("span",{children:r.temperature||.7}),e.jsx("span",{children:"æ›´éšæœº (1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æœ€å¤§ä»¤ç‰Œæ•°"}),e.jsx("input",{type:"number",name:"maxTokens",value:r.maxTokens||1e3,onChange:O,min:"100",max:"8000",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"useProxy",checked:r.useProxy||!1,onChange:O,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"ä½¿ç”¨ä»£ç†"})]})}),r.useProxy&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ä»£ç†URL"}),e.jsx("input",{type:"text",name:"proxyUrl",value:r.proxyUrl||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"ä¾‹å¦‚: http://localhost:8080/"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",onClick:j,children:"ä¿å­˜é…ç½®"}),e.jsx("button",{className:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed",onClick:_,disabled:c,children:c?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"})]}),g&&e.jsx("div",{className:`p-3 rounded ${g==="success"?"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"}`,children:g==="success"?"è¿æ¥æˆåŠŸï¼LLM APIå¯ç”¨ã€‚":"è¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥ä½ çš„APIå¯†é’¥å’Œè®¾ç½®ã€‚"})]})]}),Y=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"æ¸¸æˆè®¾ç½®"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"æœ€å¤§å†å²è®°å½•é•¿åº¦"}),e.jsx("input",{type:"number",name:"maxHistoryLength",value:a.maxHistoryLength||100,onChange:v,min:"10",max:"1000",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"ä¿å­˜åœ¨å†…å­˜ä¸­çš„æœ€å¤§å†å²è®°å½•æ•°é‡"})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"autoSave",checked:a.autoSave!==!1,onChange:v,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"å¯ç”¨è‡ªåŠ¨ä¿å­˜"})]})}),a.autoSave!==!1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"è‡ªåŠ¨ä¿å­˜é—´éš”ï¼ˆåˆ†é’Ÿï¼‰"}),e.jsx("input",{type:"number",name:"autoSaveInterval",value:a.autoSaveInterval||5,onChange:v,min:"1",max:"60",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"debugMode",checked:a.debugMode||!1,onChange:v,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"è°ƒè¯•æ¨¡å¼"})]}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"å¯ç”¨é¢å¤–çš„æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯"})]}),e.jsx("button",{className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",onClick:G,children:"ä¿å­˜é…ç½®"})]})]}),P=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"ç•Œé¢è®¾ç½®"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"ä¸»é¢˜"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"light",checked:document.documentElement.classList.contains("dark")===!1,onChange:()=>{document.documentElement.classList.remove("dark"),localStorage.setItem("darkMode","false")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"äº®è‰²"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"dark",checked:document.documentElement.classList.contains("dark")===!0,onChange:()=>{document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"æš—è‰²"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"system",checked:localStorage.getItem("darkMode")===null,onChange:()=>{window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.removeItem("darkMode")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"è·Ÿéšç³»ç»Ÿ"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"å­—ä½“å¤§å°"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",onChange:w=>{document.documentElement.style.fontSize=w.target.value,localStorage.setItem("fontSize",w.target.value)},value:localStorage.getItem("fontSize")||"16px",children:[e.jsx("option",{value:"14px",children:"å°"}),e.jsx("option",{value:"16px",children:"ä¸­"}),e.jsx("option",{value:"18px",children:"å¤§"}),e.jsx("option",{value:"20px",children:"ç‰¹å¤§"})]})]})]})]}),z=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"æ•°æ®ç®¡ç†"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"å¯¼å‡ºæ¸¸æˆæ•°æ®"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"å¯¼å‡ºå½“å‰æ¸¸æˆçš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ¸¸æˆçŠ¶æ€ã€å†å²è®°å½•å’Œè§’è‰²ä¿¡æ¯ã€‚"}),e.jsx("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:t,children:"å¯¼å‡ºæ•°æ®"})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"å¯¼å…¥æ¸¸æˆæ•°æ®"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"ä»æ–‡ä»¶å¯¼å…¥æ¸¸æˆæ•°æ®ï¼Œå°†è¦†ç›–å½“å‰çš„æ¸¸æˆçŠ¶æ€ã€‚"}),e.jsxs("label",{className:"inline-block px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 cursor-pointer",children:["é€‰æ‹©æ–‡ä»¶",e.jsx("input",{type:"file",className:"hidden",accept:".json",onChange:E},d)]})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"é‡ç½®æ¸¸æˆ"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"é‡ç½®æ¸¸æˆåˆ°åˆå§‹çŠ¶æ€ï¼Œå°†åˆ é™¤æ‰€æœ‰è¿›åº¦ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"}),e.jsx("button",{className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",onClick:m,children:"é‡ç½®æ¸¸æˆ"})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"æ¸…é™¤æœ¬åœ°å­˜å‚¨"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"æ¸…é™¤æµè§ˆå™¨ä¸­ä¿å­˜çš„æ‰€æœ‰æ¸¸æˆæ•°æ®ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚"}),e.jsx("button",{className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{window.confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")&&(localStorage.clear(),alert("æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤ã€‚è¯·åˆ·æ–°é¡µé¢ã€‚"))},children:"æ¸…é™¤å­˜å‚¨"})]})]})]});return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"è®¾ç½®"}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:e.jsxs("nav",{className:"flex",children:[e.jsx("button",{className:`px-4 py-2 ${o==="llm"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("llm"),children:"LLMè®¾ç½®"}),e.jsx("button",{className:`px-4 py-2 ${o==="game"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("game"),children:"æ¸¸æˆè®¾ç½®"}),e.jsx("button",{className:`px-4 py-2 ${o==="interface"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("interface"),children:"ç•Œé¢è®¾ç½®"}),e.jsx("button",{className:`px-4 py-2 ${o==="data"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("data"),children:"æ•°æ®ç®¡ç†"})]})}),e.jsxs("div",{className:"p-6",children:[o==="llm"&&W(),o==="game"&&Y(),o==="interface"&&P(),o==="data"&&z()]})]})]})};class Be{processAction(t,s=null){const r=s||N.getState();switch(t.type){case S.DIALOGUE:return this._processDialogue(t,r);case S.ACTION:return this._processPhysicalAction(t,r);case S.ITEM:return this._processItemAction(t,r);default:return console.warn(`æœªçŸ¥çš„è¡Œä¸ºç±»å‹: ${t.type}`),r}}_processDialogue(t,s){const r={...s};return r.updatedAt=new Date().toISOString(),t.targetType===D.CHARACTER&&t.targetId,r}_processPhysicalAction(t,s){const r={...s};switch(r.updatedAt=new Date().toISOString(),t.targetType){case D.CHARACTER:return this._processCharacterTargetedAction(t,r);case D.ENVIRONMENT:return this._processEnvironmentTargetedAction(t,r);case D.ITEM:return this._processItemTargetedAction(t,r);default:return r}}_processItemAction(t,s){const r={...s};r.updatedAt=new Date().toISOString();const n=t.itemId;let a=!1;if(r.player&&r.player.inventory&&(a=r.player.inventory.some(i=>i.id===n)),!a&&r.environment&&r.environment.locations){const i=r.environment.currentLocation,o=r.environment.locations[i];o&&o.objects&&(a=o.objects.some(l=>l.id===n))}if(!a)return console.warn(`ç‰©å“ä¸å­˜åœ¨: ${n}`),r;switch(t.targetType){case D.CHARACTER:return this._processItemOnCharacter(t,r);case D.ENVIRONMENT:return this._processItemOnEnvironment(t,r);case D.ITEM:return this._processItemOnItem(t,r);default:return this._processItemGeneral(t,r)}}_processCharacterTargetedAction(t,s){const r=t.targetId;let n=null;return r==="player"?n=s.player:n=s.agents.find(a=>a.id===r),n||console.warn(`ç›®æ ‡è§’è‰²ä¸å­˜åœ¨: ${r}`),s}_processEnvironmentTargetedAction(t,s){const r=s.environment.currentLocation;return s.environment.locations[r]||console.warn(`å½“å‰ä½ç½®ä¸å­˜åœ¨: ${r}`),s}_processItemTargetedAction(t,s){const r=t.targetId;let n=null;if(s.player&&s.player.inventory&&(n=s.player.inventory.find(a=>a.id===r)),!n&&s.environment&&s.environment.locations){const a=s.environment.currentLocation,i=s.environment.locations[a];i&&i.objects&&(n=i.objects.find(o=>o.id===r))}return n||console.warn(`ç›®æ ‡ç‰©å“ä¸å­˜åœ¨: ${r}`),s}_processItemOnCharacter(t,s){return s}_processItemOnEnvironment(t,s){return s}_processItemOnItem(t,s){return s}_processItemGeneral(t,s){return s}applyTransition(t){const s=N.getState(),r=this.processAction(t,s);return N.updateState(r),r}applyTransitions(t){let s=N.getState();for(const r of t)s=this.processAction(r,s);return N.updateState(s),s}}const Ye=new Be,L={DIALOGUE:"dialogue",ACTION:"action",EMOTION:"emotion",DECISION:"decision",REJECTION:"rejection"},Z={COOPERATE:"cooperate",COMPETE:"compete",AVOID:"avoid",HELP:"help",ATTACK:"attack",NEUTRAL:"neutral"};class Ve{constructor(){this.responseTemplates={[k.HAPPY]:['{{name}}ç¬‘ç€è¯´ï¼Œ"{{content}}"','{{name}}æ„‰å¿«åœ°å›åº”ï¼Œ"{{content}}"','{{name}}é¢å¸¦å¾®ç¬‘ï¼Œ"{{content}}"'],[k.SAD]:['{{name}}å¹äº†å£æ°”ï¼Œ"{{content}}"','{{name}}ä½è½åœ°è¯´ï¼Œ"{{content}}"','{{name}}å£°éŸ³ä¸­å¸¦ç€æ‚²ä¼¤ï¼Œ"{{content}}"'],[k.ANGRY]:['{{name}}æ€’æ°”å†²å†²åœ°è¯´ï¼Œ"{{content}}"','{{name}}æé«˜äº†å£°éŸ³ï¼Œ"{{content}}"','{{name}}æ„¤æ€’åœ°å›åº”ï¼Œ"{{content}}"'],[k.FEARFUL]:['{{name}}ç´§å¼ åœ°è¯´ï¼Œ"{{content}}"','{{name}}å£°éŸ³é¢¤æŠ–ç€ï¼Œ"{{content}}"','{{name}}ç•ç¼©ç€å›åº”ï¼Œ"{{content}}"'],[k.DISGUSTED]:['{{name}}åŒæ¶åœ°è¯´ï¼Œ"{{content}}"','{{name}}çš±ç€çœ‰å¤´ï¼Œ"{{content}}"','{{name}}ä¸æ‚¦åœ°å›åº”ï¼Œ"{{content}}"'],[k.SURPRISED]:['{{name}}æƒŠè®¶åœ°è¯´ï¼Œ"{{content}}"','{{name}}çå¤§äº†çœ¼ç›ï¼Œ"{{content}}"','{{name}}éœ‡æƒŠåœ°å›åº”ï¼Œ"{{content}}"'],[k.NEUTRAL]:['{{name}}è¯´ï¼Œ"{{content}}"','{{name}}å›åº”é“ï¼Œ"{{content}}"','{{name}}å¹³é™åœ°è¯´ï¼Œ"{{content}}"']}}async generateResponse(t,s,r={}){try{const n=A.getAgent(t);if(!n)throw new Error(`è§’è‰²ä¸å­˜åœ¨: ${t}`);const a=A.createAgentCard(t),i=s.actorId?te.getRelationship(t,s.actorId):null,o=U.getRecentHistory(10),l=this._prepareResponseContext(n,s,i,o,r);let c;switch(n.type){case M.NPC:c=await this._generateNPCResponse(n,l,r);break;case M.GM:c=await this._generateGMResponse(n,l,r);break;case M.ENVIRONMENT:c=await this._generateEnvironmentResponse(n,l,r);break;default:throw new Error(`ä¸æ”¯æŒçš„è§’è‰²ç±»å‹: ${n.type}`)}return c.type===L.DIALOGUE&&U.addNPCResponseEntry(t,c.content,{emotion:n.currentEmotion,intensity:n.emotionIntensity}),c.emotion&&c.emotion!==n.currentEmotion&&A.updateAgentEmotion(t,c.emotion,c.emotionIntensity||n.emotionIntensity),c}catch(n){return console.error("ç”Ÿæˆè§’è‰²å“åº”å¤±è´¥:",n),{type:L.REJECTION,content:"æ— æ³•ç”Ÿæˆå“åº”",error:n.message}}}_prepareResponseContext(t,s,r,n,a){var h,g,x;const i=N.getState(),o=((h=i.environment)==null?void 0:h.currentLocation)||"unknown",l=((x=(g=i.environment)==null?void 0:g.locations)==null?void 0:x[o])||{name:"æœªçŸ¥ä½ç½®",description:""},c=te.getSocialNetwork(t.id);return{agent:{id:t.id,name:t.name,type:t.type,personality:t.personality,currentEmotion:t.currentEmotion,emotionIntensity:t.emotionIntensity,goals:t.goals,fears:t.fears,dialogueStyle:t.dialogueStyle},action:{type:s.type,content:s.content,actorId:s.actorId,actorName:this._getAgentName(s.actorId),targetId:s.targetId,targetName:this._getAgentName(s.targetId)},relationship:r?{type:r.type,trust:r.factors[V.TRUST],intimacy:r.factors[V.INTIMACY],respect:r.factors[V.RESPECT]}:null,environment:{locationId:o,locationName:l.name,locationDescription:l.description},socialNetwork:c.map(d=>({id:d.agentId,name:d.name,relationshipStatus:d.relationship.status})),history:this._formatHistoryForContext(n),options:a}}_getAgentName(t){if(!t)return"";const s=A.getAgent(t);return s?s.name:t}_formatHistoryForContext(t){return t.map(s=>{var r;switch(s.type){case $.ACTION:return{type:"action",actorName:this._getAgentName(s.actorId),content:s.content,timestamp:s.timestamp};case $.NPC_RESPONSE:return{type:"response",speakerName:this._getAgentName(s.npcId),content:s.content,emotion:(r=s.metadata)==null?void 0:r.emotion,timestamp:s.timestamp};case $.ENVIRONMENT:return{type:"environment",locationName:s.locationId,description:s.description,timestamp:s.timestamp};default:return null}}).filter(s=>s!==null)}async _generateNPCResponse(t,s,r){switch(this._determineResponseType(s)){case L.DIALOGUE:return this._generateDialogueResponse(t,s);case L.ACTION:return this._generateActionResponse(t,s);case L.EMOTION:return this._generateEmotionResponse(t,s);case L.DECISION:return this._generateDecisionResponse(t,s);case L.REJECTION:return{type:L.REJECTION,content:"æˆ‘ä¸æƒ³å›åº”è¿™ä¸ªã€‚",reason:"ä¸é€‚åˆçš„äº’åŠ¨"};default:return this._generateDialogueResponse(t,s)}}async _generateGMResponse(t,s,r){return{type:L.DIALOGUE,content:this._generateNarrativeDescription(s),emotion:k.NEUTRAL,emotionIntensity:50}}async _generateEnvironmentResponse(t,s,r){return{type:L.DIALOGUE,content:this._generateEnvironmentDescription(s),emotion:null}}_determineResponseType(t){const{agent:s,action:r,relationship:n}=t;return r.type==="dialogue"&&r.targetId===s.id?L.DIALOGUE:s.emotionIntensity>70?L.EMOTION:r.content.includes("è¯·æ±‚")||r.content.includes("å¸®åŠ©")?L.DECISION:n&&n.trust<20&&Math.random()>.7?L.REJECTION:L.DIALOGUE}_generateDialogueResponse(t,s){const{action:r,relationship:n}=s;let a="",i=t.currentEmotion;if(r.content.includes("ä½ å¥½")||r.content.includes("å—¨"))a=`ä½ å¥½ï¼Œ${r.actorName}ã€‚å¾ˆé«˜å…´è§åˆ°ä½ ã€‚`,i=k.HAPPY;else if(r.content.includes("è°¢è°¢")||r.content.includes("æ„Ÿè°¢"))a="ä¸å®¢æ°”ï¼Œè¿™æ˜¯æˆ‘åº”è¯¥åšçš„ã€‚",i=k.HAPPY;else if(r.content.includes("æŠ±æ­‰")||r.content.includes("å¯¹ä¸èµ·"))a=n&&n.trust>60?"æ²¡å…³ç³»ï¼Œæˆ‘ç†è§£ã€‚":"å—¯ï¼Œæˆ‘æ¥å—ä½ çš„é“æ­‰ã€‚",i=n&&n.trust>60?k.HAPPY:k.NEUTRAL;else if(r.content.includes("å†è§"))a="å†è§ï¼Œä¿é‡ã€‚",i=k.NEUTRAL;else{const l=["æˆ‘æ˜ç™½ä½ çš„æ„æ€ã€‚","æœ‰æ„æ€çš„è§‚ç‚¹ã€‚","è®©æˆ‘æƒ³æƒ³...","æˆ‘éœ€è¦è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªã€‚"];a=l[Math.floor(Math.random()*l.length)]}const o=this._formatResponse(t,a,i);return{type:L.DIALOGUE,content:o,rawContent:a,emotion:i,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateActionResponse(t,s){const{action:r}=s;let n="",a=t.currentEmotion;return r.content.includes("æ”»å‡»")||r.content.includes("ä¼¤å®³")?(n=`${t.name}è¿…é€Ÿèº²é¿ï¼Œè¯•å›¾ä¿æŠ¤è‡ªå·±ã€‚`,a=k.FEARFUL):r.content.includes("ç»™äºˆ")||r.content.includes("é€’ç»™")?(n=`${t.name}æ¥è¿‡ç‰©å“ï¼Œä»”ç»†æŸ¥çœ‹ã€‚`,a=k.NEUTRAL):r.content.includes("æ‹¥æŠ±")?(n=`${t.name}å›åº”äº†æ‹¥æŠ±ã€‚`,a=k.HAPPY):n=`${t.name}è§‚å¯Ÿç€æƒ…å†µï¼Œç­‰å¾…ä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚`,{type:L.ACTION,content:n,emotion:a,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateEmotionResponse(t,s){const{action:r}=s;let n="",a=t.currentEmotion;switch(t.currentEmotion){case k.HAPPY:n=`${t.name}ç¬‘å®¹æ»¡é¢ï¼Œçœ‹èµ·æ¥å¿ƒæƒ…å¾ˆå¥½ã€‚`;break;case k.SAD:n=`${t.name}ä½ä¸‹å¤´ï¼Œçœ¼ä¸­å«ç€æ³ªæ°´ã€‚`;break;case k.ANGRY:n=`${t.name}æ¡ç´§æ‹³å¤´ï¼Œæ€’è§†ç€${r.actorName}ã€‚`;break;case k.FEARFUL:n=`${t.name}é¢¤æŠ–ç€åé€€å‡ æ­¥ï¼Œè­¦æƒ•åœ°çœ‹ç€å‘¨å›´ã€‚`;break;case k.DISGUSTED:n=`${t.name}çš±èµ·çœ‰å¤´ï¼Œè¡¨æƒ…åŒæ¶ã€‚`;break;case k.SURPRISED:n=`${t.name}çå¤§çœ¼ç›ï¼Œä¸€æ—¶è¯´ä¸å‡ºè¯æ¥ã€‚`;break;default:n=`${t.name}çš„è¡¨æƒ…å˜å¾—éš¾ä»¥æ‰æ‘¸ã€‚`;break}return{type:L.EMOTION,content:n,emotion:a,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateDecisionResponse(t,s){const{relationship:r}=s,n=t.personality;let a=0;a+=(n[C.AGREEABLENESS]-50)*.5,a+=(n[C.EXTRAVERSION]-50)*.3,a+=(50-n[C.NEUROTICISM])*.2,r&&(a+=(r.trust-50)*.6,a+=(r.respect-50)*.4);let i,o="",l;return a>30?(i=Z.COOPERATE,o=`${t.name}å†³å®šåˆä½œï¼Œ"æˆ‘ä¼šå¸®åŠ©ä½ çš„ã€‚"`,l=k.HAPPY):a>10?(i=Z.HELP,o=`${t.name}ç‚¹ç‚¹å¤´ï¼Œ"æˆ‘å¯ä»¥è¯•è¯•çœ‹ã€‚"`,l=k.NEUTRAL):a>-10?(i=Z.NEUTRAL,o=`${t.name}çŠ¹è±«äº†ä¸€ä¸‹ï¼Œ"æˆ‘éœ€è¦è€ƒè™‘ä¸€ä¸‹ã€‚"`,l=k.NEUTRAL):a>-30?(i=Z.AVOID,o=`${t.name}æ‘‡æ‘‡å¤´ï¼Œ"ææ€•æˆ‘ä¸èƒ½å‚ä¸è¿™ä¸ªã€‚"`,l=k.FEARFUL):(i=Z.COMPETE,o=`${t.name}å†·ç¬‘ä¸€å£°ï¼Œ"åˆ«æŒ‡æœ›æˆ‘ä¼šå¸®ä½ ã€‚"`,l=k.ANGRY),{type:L.DECISION,content:o,decisionType:i,emotion:l,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateNarrativeDescription(t){const{action:s,environment:r}=t;return`åœ¨${r.locationName}ï¼Œ${s.actorName}${s.content}ã€‚
å‘¨å›´çš„ç¯å¢ƒ${r.locationDescription}ã€‚`}_generateEnvironmentDescription(t){const{environment:s}=t;return`${s.locationName}: ${s.locationDescription}`}_formatResponse(t,s,r){const n=this.responseTemplates[r]||this.responseTemplates[k.NEUTRAL];return n[Math.floor(Math.random()*n.length)].replace("{{name}}",t.name).replace("{{content}}",s)}_calculateEmotionIntensity(t,s){let r=t.emotionIntensity||50;const n=t.personality[C.NEUROTICISM]||50;return r=r*(1+(n-50)/100),Math.max(0,Math.min(100,r))}async generateMultipleResponses(t,s,r={}){const n=[];for(const a of t)try{const i=await this.generateResponse(a,s,r);n.push({agentId:a,response:i})}catch(i){console.error(`ç”Ÿæˆè§’è‰² ${a} çš„å“åº”å¤±è´¥:`,i),n.push({agentId:a,response:{type:L.REJECTION,content:"æ— æ³•ç”Ÿæˆå“åº”",error:i.message}})}return n}async generateSceneResponses(t,s={}){var o;const n=((o=N.getState().environment)==null?void 0:o.currentLocation)||"",i=A.getAgentsByType(M.NPC).filter(l=>l.location===n).map(l=>l.id);return i.push("gm"),this.generateMultipleResponses(i,t,s)}}const qe=new Ve,Je=()=>{const[m,t]=y.useState("game"),[s,r]=y.useState(N.getState()),[n,a]=y.useState([]),[i,o]=y.useState(!1),[l,c]=y.useState(""),[h,g]=y.useState(localStorage.getItem("darkMode")==="true"||window.matchMedia("(prefers-color-scheme: dark)").matches);y.useEffect(()=>{N.initialize(),r(N.getState()),U.loadFromLocalStorage(),a(U.getRecentHistory(20)),A.initialize();const v=()=>{r({...N.getState()})},j=()=>{a(U.getRecentHistory(20))};return window.addEventListener("gameStateChanged",v),window.addEventListener("historyChanged",j),()=>{window.removeEventListener("gameStateChanged",v),window.removeEventListener("historyChanged",j)}},[]),y.useEffect(()=>{h?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.setItem("darkMode",h)},[h]);const x=async v=>{try{o(!0),c("å¤„ç†ä¸­..."),U.addActionEntry(v);const j=Ye.applyTransition(v);(await qe.generateSceneResponses(v)).forEach(({agentId:_,response:E})=>{E.type==="dialogue"&&U.addNPCResponseEntry(_,E.content,{emotion:E.emotion,intensity:E.emotionIntensity})}),U.saveToLocalStorage(),c("")}catch(j){console.error("å¤„ç†è¡Œä¸ºå¤±è´¥:",j),c(`é”™è¯¯: ${j.message}`)}finally{o(!1)}},d=()=>{window.confirm("ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦ã€‚")&&(N.reset(),U.clearHistory(),r({...N.getState()}),a([]),c("æ¸¸æˆå·²é‡ç½®"))},R=()=>{try{N.saveToLocalStorage(),U.saveToLocalStorage(),c("æ¸¸æˆå·²ä¿å­˜"),setTimeout(()=>{c("")},3e3)}catch(v){console.error("ä¿å­˜æ¸¸æˆå¤±è´¥:",v),c(`ä¿å­˜å¤±è´¥: ${v.message}`)}},T=()=>{try{const v={gameState:N.exportState(),history:U.exportHistory(),agents:A.exportAgents()},j=JSON.stringify(v,null,2),G=`data:application/json;charset=utf-8,${encodeURIComponent(j)}`,_=`ai_trpg_save_${new Date().toISOString().slice(0,10)}.json`,E=document.createElement("a");E.setAttribute("href",G),E.setAttribute("download",_),E.click(),c("æ¸¸æˆå·²å¯¼å‡º"),setTimeout(()=>{c("")},3e3)}catch(v){console.error("å¯¼å‡ºæ¸¸æˆå¤±è´¥:",v),c(`å¯¼å‡ºå¤±è´¥: ${v.message}`)}},O=v=>{try{const j=v.target.files[0];if(!j)return;const G=new FileReader;G.onload=_=>{try{const E=JSON.parse(_.target.result);E.gameState&&(N.importState(E.gameState),r({...N.getState()})),E.history&&(U.importHistory(E.history),a(U.getRecentHistory(20))),E.agents&&A.importAgents(E.agents),c("æ¸¸æˆå·²å¯¼å…¥"),setTimeout(()=>{c("")},3e3)}catch(E){console.error("è§£æå¯¼å…¥æ•°æ®å¤±è´¥:",E),c(`å¯¼å…¥å¤±è´¥: ${E.message}`)}},G.onerror=()=>{c("è¯»å–æ–‡ä»¶å¤±è´¥")},G.readAsText(j)}catch(j){console.error("å¯¼å…¥æ¸¸æˆå¤±è´¥:",j),c(`å¯¼å…¥å¤±è´¥: ${j.message}`)}finally{v.target.value=null}};return e.jsxs("div",{className:"flex flex-col h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100",children:[e.jsx("header",{className:"bg-indigo-600 dark:bg-indigo-800 text-white p-4 shadow-md",children:e.jsxs("div",{className:"container mx-auto flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"AI TRPG ç³»ç»Ÿ"}),e.jsxs("nav",{className:"flex space-x-4",children:[e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="game"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("game"),children:"æ¸¸æˆ"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="characters"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("characters"),children:"è§’è‰²"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="worldbook"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("worldbook"),children:"ä¸–ç•Œä¹¦"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="settings"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("settings"),children:"è®¾ç½®"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{className:"p-2 rounded-full hover:bg-indigo-700 dark:hover:bg-indigo-600",onClick:()=>g(!h),title:h?"åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼":"åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼",children:h?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z",clipRule:"evenodd"})}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"})})}),e.jsx("button",{className:"p-2 rounded-full hover:bg-indigo-700 dark:hover:bg-indigo-600",onClick:R,title:"ä¿å­˜æ¸¸æˆ",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"})})})]})]})}),l&&e.jsx("div",{className:"bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-200 p-4",children:e.jsx("p",{children:l})}),e.jsxs("main",{className:"flex-grow flex overflow-hidden",children:[m==="game"&&e.jsxs("div",{className:"flex flex-col md:flex-row w-full h-full overflow-hidden",children:[e.jsx("div",{className:"w-full md:w-1/3 p-4 overflow-y-auto border-r border-gray-200 dark:border-gray-700",children:e.jsx(Le,{gameState:s})}),e.jsxs("div",{className:"w-full md:w-2/3 flex flex-col h-full",children:[e.jsx("div",{className:"flex-grow p-4 overflow-y-auto",children:e.jsx(Oe,{history:n})}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx(Ae,{onSubmit:x,disabled:i,gameState:s})})]})]}),m==="characters"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(De,{})}),m==="worldbook"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(Ue,{})}),m==="settings"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(Fe,{onResetGame:d,onExportGame:T,onImportGame:O})})]}),e.jsx("footer",{className:"bg-gray-200 dark:bg-gray-800 p-2 text-sm text-gray-600 dark:text-gray-400",children:e.jsxs("div",{className:"container mx-auto flex justify-between items-center",children:[e.jsxs("div",{children:["æ¸¸æˆID: ",s.gameId," | å›åˆ: ",s.turn," | é˜¶æ®µ: ",s.phase]}),e.jsx("div",{children:new Date().toLocaleString()})]})})]})};function ze(){const[m,t]=y.useState(localStorage.getItem("darkMode")==="true"||window.matchMedia("(prefers-color-scheme: dark)").matches),[s,r]=y.useState(!0);return y.useEffect(()=>{m?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const n=setTimeout(()=>{r(!1)},1e3);return()=>clearTimeout(n)},[m]),s?e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4",children:"AI-TRPG å™äº‹ç³»ç»Ÿ"}),e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"æ­£åœ¨åŠ è½½ç³»ç»Ÿç»„ä»¶..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100",children:e.jsx(Je,{})})}ie.createRoot(document.getElementById("root")).render(e.jsx(fe.StrictMode,{children:e.jsx(ze,{})}));
