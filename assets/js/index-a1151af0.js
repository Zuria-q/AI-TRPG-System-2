import{r as y,a as be,R as fe}from"./vendor-b1791c80.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();var me={exports:{}},ne={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ne=y,ve=Symbol.for("react.element"),je=Symbol.for("react.fragment"),ke=Object.prototype.hasOwnProperty,Se=Ne.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ee={key:!0,ref:!0,__self:!0,__source:!0};function he(m,t,s){var r,n={},a=null,i=null;s!==void 0&&(a=""+s),t.key!==void 0&&(a=""+t.key),t.ref!==void 0&&(i=t.ref);for(r in t)ke.call(t,r)&&!Ee.hasOwnProperty(r)&&(n[r]=t[r]);if(m&&m.defaultProps)for(r in t=m.defaultProps,t)n[r]===void 0&&(n[r]=t[r]);return{$$typeof:ve,type:m,key:a,ref:i,props:n,_owner:Se.current}}ne.Fragment=je;ne.jsx=he;ne.jsxs=he;me.exports=ne;var e=me.exports,ie={},oe=be;ie.createRoot=oe.createRoot,ie.hydrateRoot=oe.hydrateRoot;const S={DIALOGUE:"dialogue",ACTION:"action",ITEM:"item"},D={NONE:"none",CHARACTER:"character",ENVIRONMENT:"environment",ITEM:"item"};function we(m){let t=S.DIALOGUE,s=m;const r=/^\s*[\[【](.+?)[\]】]\s*$/,n=m.match(r);if(n)return t=S.ACTION,s=n[1],{type:t,content:s};const a=/^\s*[{「](.+?)[}」]\s*$/,i=m.match(a);if(i)return t=S.ITEM,s=i[1],{type:t,content:s};const o=/^\s*[""](.+?)[""]?\s*$/,l=m.match(o);return l&&(s=l[1]),{type:t,content:s}}const Ae=({onSubmitAction:m,availableTargets:t=[],currentActorId:s="player"})=>{const[r,n]=y.useState(""),[a,i]=y.useState(S.DIALOGUE),[o,l]=y.useState(D.NONE),[c,h]=y.useState(""),[g,x]=y.useState(!1),[d,R]=y.useState({tone:"",emotion:"",intensity:50,bodyPart:"",isStealthy:!1,effect:""}),T=y.useRef(null);y.useEffect(()=>{if(r){const{type:b,content:F}=we(r);b!==a&&i(b)}},[r]),y.useEffect(()=>{a===S.DIALOGUE&&l(c?D.CHARACTER:D.NONE)},[a,c]);const O=b=>{n(b.target.value)},v=b=>{i(b.target.value)},j=b=>{l(b.target.value),b.target.value===D.NONE&&h("")},G=b=>{h(b.target.value)},_=(b,F)=>{R(u=>({...u,[b]:F}))},E=b=>{if(b.preventDefault(),!r.trim())return;const F={type:a,actorId:s,content:r,targetType:o,targetId:c||null,timestamp:Date.now(),...W()};m(F),n(""),h(""),R({tone:"",emotion:"",intensity:50,bodyPart:"",isStealthy:!1,effect:""}),T.current&&T.current.focus()},W=()=>{switch(a){case S.DIALOGUE:return{tone:d.tone||null,emotion:d.emotion||null};case S.ACTION:return{intensity:d.intensity||50,bodyPart:d.bodyPart||null,isStealthy:d.isStealthy||!1};case S.ITEM:return{effect:d.effect||null};default:return{}}},Y=()=>e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"行为类型"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.DIALOGUE?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.DIALOGUE,checked:a===S.DIALOGUE,onChange:v,className:"sr-only"}),e.jsx("span",{children:"💬 对话"})]}),e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.ACTION?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.ACTION,checked:a===S.ACTION,onChange:v,className:"sr-only"}),e.jsx("span",{children:"🏃 动作"})]}),e.jsxs("label",{className:`flex-1 p-2 border rounded-md cursor-pointer text-center ${a===S.ITEM?"bg-primary-100 border-primary-500 dark:bg-primary-900 dark:border-primary-400":"border-gray-300 dark:border-gray-700"}`,children:[e.jsx("input",{type:"radio",name:"actionType",value:S.ITEM,checked:a===S.ITEM,onChange:v,className:"sr-only"}),e.jsx("span",{children:"🧰 物品"})]})]})]}),P=()=>e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"目标"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsxs("select",{value:o,onChange:j,className:"select",children:[e.jsx("option",{value:D.NONE,children:"无特定目标"}),e.jsx("option",{value:D.CHARACTER,children:"角色"}),e.jsx("option",{value:D.ENVIRONMENT,children:"环境/场景"}),e.jsx("option",{value:D.ITEM,children:"物品"})]})}),o!==D.NONE&&e.jsx("div",{children:e.jsxs("select",{value:c,onChange:G,className:"select",disabled:o===D.NONE,children:[e.jsx("option",{value:"",children:"选择具体目标..."}),t.filter(b=>b.type===o).map(b=>e.jsx("option",{value:b.id,children:b.name},b.id))]})})]})]}),z=()=>{if(!g)return null;switch(a){case S.DIALOGUE:return e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"语气/语调"}),e.jsx("input",{type:"text",value:d.tone,onChange:b=>_("tone",b.target.value),placeholder:"例如：愤怒、温柔、疑惑",className:"input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"情绪状态"}),e.jsx("input",{type:"text",value:d.emotion,onChange:b=>_("emotion",b.target.value),placeholder:"例如：高兴、悲伤、紧张",className:"input"})]})]});case S.ACTION:return e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["动作强度 (",d.intensity,")"]}),e.jsx("input",{type:"range",min:"0",max:"100",value:d.intensity,onChange:b=>_("intensity",parseInt(b.target.value)),className:"w-full"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"身体部位"}),e.jsx("input",{type:"text",value:d.bodyPart,onChange:b=>_("bodyPart",b.target.value),placeholder:"例如：手、腿、头",className:"input"})]}),e.jsx("div",{className:"col-span-2",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:d.isStealthy,onChange:b=>_("isStealthy",b.target.checked),className:"mr-2"}),e.jsx("span",{children:"隐蔽行动（其他角色可能不会注意到）"})]})})]});case S.ITEM:return e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"预期效果"}),e.jsx("input",{type:"text",value:d.effect,onChange:b=>_("effect",b.target.value),placeholder:"例如：治疗、伤害、增益",className:"input"})]});default:return null}},w=()=>{switch(a){case S.DIALOGUE:return'输入对话内容，可以使用引号："你好，我是玩家"';case S.ACTION:return"输入动作描述，可以使用方括号：【向前走了几步】";case S.ITEM:return"输入物品使用方式，可以使用花括号：「使用治疗药水」";default:return"输入行为内容..."}};return e.jsxs("div",{className:"card",children:[e.jsx("h3",{className:"mb-4",children:"行为输入"}),e.jsxs("form",{onSubmit:E,children:[Y(),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"内容"}),e.jsx("textarea",{ref:T,value:r,onChange:O,placeholder:w(),className:"textarea",rows:"3",required:!0})]}),P(),e.jsx("div",{className:"mb-4",children:e.jsx("button",{type:"button",className:"text-sm text-primary-600 dark:text-primary-400 hover:underline",onClick:()=>x(!g),children:g?"隐藏高级选项 ▲":"显示高级选项 ▼"})}),z(),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!r.trim(),children:"发送"})})]})]})},le={SETUP:"setup",PLANNING:"planning",ACTION:"action",RESOLUTION:"resolution",END:"end"},Ie={DAWN:"dawn",MORNING:"morning",NOON:"noon",AFTERNOON:"afternoon",EVENING:"evening",NIGHT:"night",MIDNIGHT:"midnight"},Ce={CLEAR:"clear",CLOUDY:"cloudy",RAINY:"rainy",STORMY:"stormy",SNOWY:"snowy",FOGGY:"foggy",WINDY:"windy"};class Te{constructor(){this.reset()}reset(){this.state={gameId:this._generateGameId(),sessionId:this._generateSessionId(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),turn:0,phase:le.SETUP,player:{id:"player",name:"玩家",description:"",attributes:{},inventory:[],status:[]},agents:[],activeAgentId:null,environment:{name:"未命名场景",description:"这是一个未描述的场景",currentLocation:"default",locations:{default:{id:"default",name:"默认位置",description:"一个默认的起始位置",connections:[],objects:[]}},time:{day:1,cycle:Ie.MORNING,hour:9,minute:0},weather:Ce.CLEAR,ambience:"",flags:{}},worldbook:[],flags:{},variables:{},llmConfig:{temperature:.7,maxTokens:500,useMemory:!0,contextWeight:.5}}}getState(){return this.state}updateState(t){return this.state={...this.state,...t,updatedAt:new Date().toISOString()},this.state}getPhase(){return this.state.phase}setPhase(t){if(!Object.values(le).includes(t))throw new Error(`无效的游戏阶段: ${t}`);this.state.phase=t,this.state.updatedAt=new Date().toISOString()}getTurn(){return this.state.turn}incrementTurn(t=1){return this.state.turn+=t,this.state.updatedAt=new Date().toISOString(),this.state.turn}getPlayer(){return this.state.player}updatePlayer(t){return this.state.player={...this.state.player,...t},this.state.updatedAt=new Date().toISOString(),this.state.player}getAgents(){return this.state.agents}getAgent(t){return this.state.agents.find(s=>s.id===t)||null}addAgent(t){if(!t.id)throw new Error("代理必须有ID");const s=this.state.agents.findIndex(r=>r.id===t.id);return s>=0?this.state.agents[s]={...this.state.agents[s],...t}:this.state.agents.push(t),this.state.updatedAt=new Date().toISOString(),this.state.agents}updateAgent(t,s){const r=this.state.agents.findIndex(n=>n.id===t);return r<0?null:(this.state.agents[r]={...this.state.agents[r],...s},this.state.updatedAt=new Date().toISOString(),this.state.agents[r])}removeAgent(t){const s=this.state.agents.length;this.state.agents=this.state.agents.filter(n=>n.id!==t);const r=s>this.state.agents.length;return r&&(this.state.updatedAt=new Date().toISOString(),this.state.activeAgentId===t&&(this.state.activeAgentId=null)),r}setActiveAgent(t){return t?this.state.agents.some(r=>r.id===t)?(this.state.activeAgentId=t,this.state.updatedAt=new Date().toISOString(),!0):!1:(this.state.activeAgentId=null,this.state.updatedAt=new Date().toISOString(),!0)}getEnvironment(){return this.state.environment}updateEnvironment(t){return this.state.environment={...this.state.environment,...t},this.state.updatedAt=new Date().toISOString(),this.state.environment}getLocation(t){return this.state.environment.locations[t]||null}addLocation(t){if(!t.id)throw new Error("位置必须有ID");return this.state.environment.locations[t.id]={...this.state.environment.locations[t.id]||{},...t},this.state.updatedAt=new Date().toISOString(),this.state.environment.locations[t.id]}removeLocation(t){return this.state.environment.locations[t]?(this.state.environment.currentLocation===t&&(this.state.environment.currentLocation="default"),delete this.state.environment.locations[t],this.state.updatedAt=new Date().toISOString(),!0):!1}setCurrentLocation(t){return this.state.environment.locations[t]?(this.state.environment.currentLocation=t,this.state.updatedAt=new Date().toISOString(),!0):!1}getWorldbook(){return this.state.worldbook}addWorldbookEntry(t){t.id||(t.id=`entry_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const s=this.state.worldbook.findIndex(r=>r.id===t.id);return s>=0?this.state.worldbook[s]={...this.state.worldbook[s],...t}:this.state.worldbook.push(t),this.state.updatedAt=new Date().toISOString(),this.state.worldbook}removeWorldbookEntry(t){const s=this.state.worldbook.length;this.state.worldbook=this.state.worldbook.filter(n=>n.id!==t);const r=s>this.state.worldbook.length;return r&&(this.state.updatedAt=new Date().toISOString()),r}getLLMConfig(){return this.state.llmConfig}updateLLMConfig(t){return this.state.llmConfig={...this.state.llmConfig,...t},this.state.updatedAt=new Date().toISOString(),this.state.llmConfig}saveToLocalStorage(t="ai_trpg_game_state"){try{const s=JSON.stringify(this.state);return localStorage.setItem(t,s),!0}catch(s){return console.error("保存游戏状态失败:",s),!1}}loadFromLocalStorage(t="ai_trpg_game_state"){try{const s=localStorage.getItem(t);if(!s)return!1;const r=JSON.parse(s);return this.state=r,!0}catch(s){return console.error("加载游戏状态失败:",s),!1}}exportState(){return JSON.stringify(this.state,null,2)}importState(t){try{const s=JSON.parse(t);return this.state=s,!0}catch(s){return console.error("导入游戏状态失败:",s),!1}}_generateGameId(){return`game_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}const N=new Te,$={ACTION:"action",STATE_CHANGE:"state_change",SYSTEM:"system",NPC_RESPONSE:"npc_response",ENVIRONMENT:"environment"};class Re{constructor(){this.history=[],this.maxHistoryLength=1e3}addEntry(t){const s={id:this._generateEntryId(),timestamp:Date.now(),...t};return this.history.push(s),this.history.length>this.maxHistoryLength&&this.history.shift(),s}addActionEntry(t,s=null){return this.addEntry({type:$.ACTION,action:t,result:s,actorId:t.actorId,content:t.content})}addStateChangeEntry(t,s,r=null){const n=this._calculateStateDiff(t,s);return this.addEntry({type:$.STATE_CHANGE,changes:n,cause:r})}addSystemEntry(t,s,r=null){return this.addEntry({type:$.SYSTEM,eventType:t,message:s,data:r})}addNPCResponseEntry(t,s,r=null){return this.addEntry({type:$.NPC_RESPONSE,npcId:t,content:s,metadata:r})}addEnvironmentEntry(t,s,r=null){return this.addEntry({type:$.ENVIRONMENT,locationId:t,description:s,metadata:r})}getHistory(){return this.history}getRecentHistory(t){return this.history.slice(-t)}getHistoryByType(t,s=null){const r=this.history.filter(n=>n.type===t);return s!==null?r.slice(-s):r}getHistoryByActor(t,s=null){const r=this.history.filter(n=>n.actorId===t||n.type===$.NPC_RESPONSE&&n.npcId===t);return s!==null?r.slice(-s):r}getHistoryByTimeRange(t,s){return this.history.filter(r=>r.timestamp>=t&&r.timestamp<=s)}clearHistory(){this.history=[]}exportHistory(){return JSON.stringify(this.history,null,2)}importHistory(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("导入的历史记录不是数组");return this.history=s,!0}catch(s){return console.error("导入历史记录失败:",s),!1}}saveToLocalStorage(t="ai_trpg_history"){try{const s=JSON.stringify(this.history);return localStorage.setItem(t,s),!0}catch(s){return console.error("保存历史记录失败:",s),!1}}loadFromLocalStorage(t="ai_trpg_history"){try{const s=localStorage.getItem(t);if(!s)return!1;const r=JSON.parse(s);return this.history=r,!0}catch(s){return console.error("加载历史记录失败:",s),!1}}_generateEntryId(){return`entry_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}_calculateStateDiff(t,s){const r={};for(const n in s)JSON.stringify(t[n])!==JSON.stringify(s[n])&&(r[n]={previous:t[n],current:s[n]});return r}getHistorySummaryForPrompt(t=500){let r=this.getRecentHistory(10).map(n=>{switch(n.type){case $.ACTION:return`[行为] ${n.actorId}: ${n.content}`;case $.NPC_RESPONSE:return`[NPC] ${n.npcId}: ${n.content}`;case $.ENVIRONMENT:return`[环境] ${n.description}`;case $.SYSTEM:return`[系统] ${n.message}`;default:return null}}).filter(n=>n!==null).join(`
`);return r.length>t&&(r=r.substring(r.length-t),r=r.substring(r.indexOf(`
`)+1)),r}}const U=new Re,Oe=({history:m=[]})=>{const t=y.useRef(null);y.useEffect(()=>{t.current&&t.current.scrollIntoView({behavior:"smooth"})},[m]);const s=a=>{switch(a){case $.ACTION:return"bg-blue-50 dark:bg-blue-900 border-blue-200 dark:border-blue-700";case $.NPC_RESPONSE:return"bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700";case $.SYSTEM:return"bg-purple-50 dark:bg-purple-900 border-purple-200 dark:border-purple-700";case $.ENVIRONMENT:return"bg-amber-50 dark:bg-amber-900 border-amber-200 dark:border-amber-700";default:return"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700"}},r=a=>{switch(a){case"happy":return"text-yellow-600 dark:text-yellow-400";case"sad":return"text-blue-600 dark:text-blue-400";case"angry":return"text-red-600 dark:text-red-400";case"fearful":return"text-purple-600 dark:text-purple-400";case"disgusted":return"text-green-600 dark:text-green-400";case"surprised":return"text-pink-600 dark:text-pink-400";default:return"text-gray-600 dark:text-gray-400"}},n=(a,i)=>{var c,h;const o=a.timestamp?new Date(a.timestamp).toLocaleTimeString():"",l=s(a.type);switch(a.type){case $.ACTION:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:a.actorId||"未知"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.content})]},i);case $.NPC_RESPONSE:const g=(c=a.metadata)!=null&&c.emotion?r(a.metadata.emotion):"";return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"font-semibold flex items-center",children:[a.npcId||"未知",((h=a.metadata)==null?void 0:h.emotion)&&e.jsx("span",{className:`ml-2 text-xs ${g}`,children:a.metadata.emotion})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.content})]},i);case $.SYSTEM:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:"系统"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.message})]},i);case $.ENVIRONMENT:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"font-semibold",children:["环境: ",a.locationId||"未知位置"]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:a.description})]},i);default:return e.jsxs("div",{className:`p-3 mb-3 rounded-lg border ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-semibold",children:"未知类型"}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:o})]}),e.jsx("div",{className:"mt-1",children:JSON.stringify(a)})]},i)}};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"游戏历史"}),m.length===0?e.jsx("div",{className:"text-center p-8 text-gray-500 dark:text-gray-400",children:"没有历史记录。开始你的冒险吧！"}):e.jsxs("div",{className:"space-y-2",children:[m.map(n),e.jsx("div",{ref:t})]})]})},Le=({gameState:m={}})=>{const[t,s]=y.useState("player"),r=c=>{s(t===c?null:c)},n=()=>{const c=m.player||{};return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-indigo-100 dark:bg-indigo-900 rounded-md",onClick:()=>r("player"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"玩家信息"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="player"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="player"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"名称:"})," ",c.name||"未命名"]}),c.description&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"描述:"})," ",c.description]}),c.location&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"位置:"})," ",c.location]}),c.inventory&&c.inventory.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"物品栏:"}),e.jsx("ul",{className:"list-disc list-inside",children:c.inventory.map((h,g)=>e.jsx("li",{children:h.name||h.id},g))})]}),c.status&&c.status.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"状态效果:"}),e.jsx("ul",{className:"list-disc list-inside",children:c.status.map((h,g)=>e.jsxs("li",{children:[h.name,": ",h.description]},g))})]})]})]})},a=()=>{const c=m.environment||{},h=c.currentLocation,g=h&&c.locations?c.locations[h]:null;return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-green-100 dark:bg-green-900 rounded-md",onClick:()=>r("environment"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"环境信息"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="environment"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="environment"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[g?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"当前位置:"})," ",g.name||h]}),g.description&&e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"描述:"})," ",g.description]}),g.objects&&g.objects.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"物体:"}),e.jsx("ul",{className:"list-disc list-inside",children:g.objects.map((x,d)=>e.jsx("li",{children:x.name||x.id},d))})]}),g.exits&&Object.keys(g.exits).length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"出口:"}),e.jsx("ul",{className:"list-disc list-inside",children:Object.entries(g.exits).map(([x,d])=>e.jsxs("li",{children:[x,": ",typeof d=="string"?d:d.target]},x))})]})]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"没有当前位置信息"}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"时间:"})," ",c.currentTime||"未知"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"天气:"})," ",c.currentWeather||"未知"]})]})]})]})},i=()=>{var x;const c=m.agents||[],h=(x=m.environment)==null?void 0:x.currentLocation,g=h?c.filter(d=>d.location===h):c;return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-amber-100 dark:bg-amber-900 rounded-md",onClick:()=>r("npcs"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"NPC信息"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="npcs"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="npcs"&&e.jsx("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:g.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"当前位置的角色:"}),g.map((d,R)=>e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[e.jsx("div",{className:"font-semibold",children:d.name||d.id}),d.description&&e.jsx("div",{className:"text-sm mt-1",children:d.description}),d.currentEmotion&&e.jsxs("div",{className:"text-sm mt-1",children:[e.jsx("span",{className:"font-semibold",children:"情绪:"})," ",d.currentEmotion,d.emotionIntensity&&` (${d.emotionIntensity})`]})]},R))]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"当前位置没有NPC"})})]})},o=()=>{const c=m.worldBook||{},h=c.entries||[];return e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-purple-100 dark:bg-purple-900 rounded-md",onClick:()=>r("worldbook"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"世界书"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="worldbook"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="worldbook"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[c.mainSetting&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"主要设定:"}),e.jsx("p",{children:c.mainSetting})]}),h.length>0?e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"条目:"}),h.map((g,x)=>e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-200 dark:border-gray-700 last:border-0",children:[e.jsx("div",{className:"font-semibold",children:g.name||g.id}),g.content&&e.jsx("div",{className:"text-sm mt-1",children:g.content}),g.category&&e.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["分类: ",g.category]})]},x))]}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"没有世界书条目"})]})]})},l=()=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("button",{className:"flex justify-between items-center w-full p-2 bg-blue-100 dark:bg-blue-900 rounded-md",onClick:()=>r("game"),children:[e.jsx("h3",{className:"text-lg font-semibold",children:"游戏信息"}),e.jsx("svg",{className:`w-5 h-5 transition-transform ${t==="game"?"transform rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),t==="game"&&e.jsxs("div",{className:"mt-2 p-3 bg-white dark:bg-gray-800 rounded-md shadow-sm",children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"游戏ID:"})," ",m.gameId||"未知"]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"回合:"})," ",m.turn||0]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("span",{className:"font-semibold",children:"阶段:"})," ",m.phase||"未知"]}),m.storyInfo&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"故事信息:"}),m.storyInfo.title&&e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"标题:"})," ",m.storyInfo.title]}),m.storyInfo.currentPlot&&e.jsxs("div",{className:"mb-1",children:[e.jsx("span",{className:"font-semibold",children:"当前情节:"})," ",m.storyInfo.currentPlot]})]}),e.jsxs("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:["创建时间: ",m.createdAt?new Date(m.createdAt).toLocaleString():"未知",e.jsx("br",{}),"更新时间: ",m.updatedAt?new Date(m.updatedAt).toLocaleString():"未知"]})]})]});return e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"游戏状态"}),n(),a(),i(),o(),l()]})},M={PLAYER:"player",NPC:"npc",GM:"gm",ENVIRONMENT:"environment"},C={OPENNESS:"openness",CONSCIENTIOUSNESS:"conscientiousness",EXTRAVERSION:"extraversion",AGREEABLENESS:"agreeableness",NEUROTICISM:"neuroticism"},k={HAPPY:"happy",SAD:"sad",ANGRY:"angry",FEARFUL:"fearful",DISGUSTED:"disgusted",SURPRISED:"surprised",NEUTRAL:"neutral"},re={id:"",name:"",type:M.NPC,description:"",background:"",appearance:"",personality:{[C.OPENNESS]:50,[C.CONSCIENTIOUSNESS]:50,[C.EXTRAVERSION]:50,[C.AGREEABLENESS]:50,[C.NEUROTICISM]:50},goals:[],motivations:[],fears:[],relationships:{},skills:{},inventory:[],status:[],currentEmotion:k.NEUTRAL,emotionIntensity:50,location:"default",dialogueStyle:"",responsePreferences:{},memoryIds:[],createdAt:"",updatedAt:""};class $e{constructor(){this.agents=new Map,this.templates=new Map}initialize(){const t=N.getState();t.player&&this.registerAgent({...re,...t.player,type:M.PLAYER,id:"player"}),t.agents&&Array.isArray(t.agents)&&t.agents.forEach(s=>{this.registerAgent({...re,...s})}),this.registerAgent({...re,id:"gm",name:"游戏主持人",type:M.GM,description:"游戏主持人，负责讲述故事和管理游戏进程",personality:{[C.OPENNESS]:80,[C.CONSCIENTIOUSNESS]:90,[C.EXTRAVERSION]:70,[C.AGREEABLENESS]:85,[C.NEUROTICISM]:20}})}registerAgent(t){return t.id||(t.id=this._generateAgentId()),t.createdAt||(t.createdAt=new Date().toISOString()),t.updatedAt=new Date().toISOString(),this.agents.set(t.id,t),t}registerTemplate(t,s){return this.templates.set(t,{...re,...s}),this.templates.get(t)}createAgentFromTemplate(t,s={}){const r=this.templates.get(t);if(!r)throw new Error(`模板不存在: ${t}`);const n={...r,...s,id:s.id||this._generateAgentId(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.registerAgent(n)}getAllAgents(){return Array.from(this.agents.values())}getAgentsByType(t){return this.getAllAgents().filter(s=>s.type===t)}getAgent(t){return this.agents.get(t)||null}updateAgent(t,s){const r=this.agents.get(t);if(!r)return null;const n={...r,...s,updatedAt:new Date().toISOString()};if(this.agents.set(t,n),t==="player")N.updatePlayer(n);else if(r.type===M.NPC){const i=N.getState().agents||[],o=i.findIndex(l=>l.id===t);o>=0?i[o]=n:i.push(n),N.updateState({agents:i})}return n}removeAgent(t){if(t==="player"||t==="gm")return!1;const s=this.agents.delete(t);if(s){const a=(N.getState().agents||[]).filter(i=>i.id!==t);N.updateState({agents:a})}return s}updateAgentEmotion(t,s,r=50){return this.updateAgent(t,{currentEmotion:s,emotionIntensity:r})}updateAgentLocation(t,s){return this.updateAgent(t,{location:s})}addItemToInventory(t,s){const r=this.agents.get(t);if(!r)return null;const n=[...r.inventory||[]];return n.push(s),this.updateAgent(t,{inventory:n})}removeItemFromInventory(t,s){const r=this.agents.get(t);if(!r)return null;const n=(r.inventory||[]).filter(a=>a.id!==s);return this.updateAgent(t,{inventory:n})}addStatusEffect(t,s){const r=this.agents.get(t);if(!r)return null;const n=[...r.status||[]];return n.push(s),this.updateAgent(t,{status:n})}removeStatusEffect(t,s){const r=this.agents.get(t);if(!r)return null;const n=(r.status||[]).filter(a=>a.id!==s);return this.updateAgent(t,{status:n})}saveAgentsToGameState(){const t=this.getAgent("player"),s=this.getAgentsByType(M.NPC);N.updateState({player:t,agents:s})}exportAgents(){return JSON.stringify(Array.from(this.agents.values()),null,2)}importAgents(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("导入的角色不是数组");return this.agents.forEach((r,n)=>{n!=="player"&&n!=="gm"&&this.agents.delete(n)}),s.forEach(r=>{if(r.id==="player"||r.id==="gm"){const n=this.agents.get(r.id);this.agents.set(r.id,{...n,...r,updatedAt:new Date().toISOString()})}else this.registerAgent(r)}),this.saveAgentsToGameState(),!0}catch(s){return console.error("导入角色失败:",s),!1}}_generateAgentId(){return`agent_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}createAgentCard(t){const s=this.getAgent(t);if(!s)throw new Error(`角色不存在: ${t}`);return{id:s.id,name:s.name,type:s.type,description:s.description,background:s.background,appearance:s.appearance,personality:s.personality,goals:s.goals,dialogueStyle:s.dialogueStyle}}}const A=new $e,_e={FRIEND:"friend",ENEMY:"enemy",FAMILY:"family",LOVER:"lover",ALLY:"ally",RIVAL:"rival",STRANGER:"stranger",MENTOR:"mentor",STUDENT:"student",EMPLOYER:"employer",EMPLOYEE:"employee"},V={TRUST:"trust",INTIMACY:"intimacy",RESPECT:"respect",LOYALTY:"loyalty",DEPENDENCY:"dependency"},ce={type:_e.STRANGER,factors:{[V.TRUST]:50,[V.INTIMACY]:0,[V.RESPECT]:50,[V.LOYALTY]:0,[V.DEPENDENCY]:0},history:[],notes:"",createdAt:"",updatedAt:""};class Pe{constructor(){this.relationships=new Map}initialize(){N.getState();const t=A.getAllAgents();t.forEach(s=>{t.forEach(r=>{if(s.id!==r.id){const n=s.relationships&&s.relationships[r.id];n?this.setRelationship(s.id,r.id,n):this.setRelationship(s.id,r.id,{...ce,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()})}})})}_getRelationshipKey(t,s){return[t,s].sort().join("_")}setRelationship(t,s,r){if(t===s)throw new Error("不能设置角色与自身的关系");const n=this._getRelationshipKey(t,s),a=new Date().toISOString(),i={...ce,...r,updatedAt:a};return i.createdAt||(i.createdAt=a),this.relationships.set(n,i),this._updateAgentRelationships(t,s,i),i}getRelationship(t,s){if(t===s)return null;const r=this._getRelationshipKey(t,s);return this.relationships.get(r)||null}getAgentRelationships(t){const s={};return A.getAllAgents().forEach(n=>{if(n.id!==t){const a=this.getRelationship(t,n.id);a&&(s[n.id]=a)}}),s}updateRelationshipFactor(t,s,r,n){const a=this.getRelationship(t,s);if(!a)return null;const i=Math.max(0,Math.min(100,n)),o={...a,factors:{...a.factors,[r]:i},updatedAt:new Date().toISOString()};return this.setRelationship(t,s,o)}adjustRelationshipFactor(t,s,r,n){const a=this.getRelationship(t,s);if(!a)return null;const i=a.factors[r]||0,o=Math.max(0,Math.min(100,i+n));return this.updateRelationshipFactor(t,s,r,o)}updateRelationshipType(t,s,r){const n=this.getRelationship(t,s);if(!n)return null;const a={...n,type:r,updatedAt:new Date().toISOString()};return this.setRelationship(t,s,a)}addRelationshipHistory(t,s,r){const n=this.getRelationship(t,s);if(!n)return null;const a=[...n.history||[]],i={...r,timestamp:r.timestamp||new Date().toISOString()};a.push(i);const o={...n,history:a,updatedAt:new Date().toISOString()};return this.setRelationship(t,s,o)}processActionEffect(t){if(t.targetType!==D.CHARACTER||!t.targetId)return null;const s=t.actorId,r=t.targetId;if(s===r||!this.getRelationship(s,r))return null;let a=0,i=0,o=0;switch(t.type){case S.DIALOGUE:t.content.includes("感谢")||t.content.includes("谢谢")?(a=2,o=1):t.content.includes("抱歉")||t.content.includes("对不起")?(a=1,o=2):t.content.includes("喜欢")||t.content.includes("爱")?(i=3,a=1):(t.content.includes("讨厌")||t.content.includes("恨"))&&(i=-3,a=-1);break;case S.ACTION:t.content.includes("帮助")||t.content.includes("援助")?(a=3,o=2):t.content.includes("攻击")||t.content.includes("伤害")?(a=-5,o=-3):(t.content.includes("拥抱")||t.content.includes("亲吻"))&&(i=4);break;case S.ITEM:t.content.includes("赠送")||t.content.includes("给予")?(a=2,i=1):(t.content.includes("偷窃")||t.content.includes("抢夺"))&&(a=-4,o=-2);break}return a!==0&&this.adjustRelationshipFactor(s,r,V.TRUST,a),i!==0&&this.adjustRelationshipFactor(s,r,V.INTIMACY,i),o!==0&&this.adjustRelationshipFactor(s,r,V.RESPECT,o),this.addRelationshipHistory(s,r,{actionType:t.type,content:t.content,effect:{trust:a,intimacy:i,respect:o}}),this.getRelationship(s,r)}_updateAgentRelationships(t,s,r){const n=A.getAgent(t),a=A.getAgent(s);if(n){const i={...n.relationships||{}};i[s]=r,A.updateAgent(t,{relationships:i})}if(a){const i={...a.relationships||{}};i[t]=r,A.updateAgent(s,{relationships:i})}}analyzeRelationship(t,s){const r=this.getRelationship(t,s);if(!r)return{status:"未知",description:"没有关系数据"};const{trust:n,intimacy:a,respect:i}=r.factors;let o="",l="";return n>=80&&a>=80?(o="亲密",l="关系非常亲密，互相信任"):n>=70?(o="信任",l="彼此信任，关系良好"):n<=20&&i<=30?(o="敌对",l="关系恶劣，互不信任"):n<=40?(o="警惕",l="保持距离，缺乏信任"):a>=70&&i>=60?(o="友好",l="关系友好，互相尊重"):(o="一般",l="关系一般，没有特别亲近或疏远"),{status:o,description:l,type:r.type,factors:r.factors}}getSocialNetwork(t){if(!A.getAgent(t))return[];const r=[];return A.getAllAgents().forEach(a=>{a.id!==t&&this.getRelationship(t,a.id)&&r.push({agentId:a.id,name:a.name,type:a.type,relationship:this.analyzeRelationship(t,a.id)})}),r}exportRelationships(){return JSON.stringify(Array.from(this.relationships.entries()),null,2)}importRelationships(t){try{const s=JSON.parse(t);if(!Array.isArray(s))throw new Error("导入的关系不是数组");this.relationships.clear(),s.forEach(([n,a])=>{this.relationships.set(n,a)});const r=A.getAllAgents();return r.forEach(n=>{const a={};r.forEach(i=>{if(n.id!==i.id){const o=this.getRelationship(n.id,i.id);o&&(a[i.id]=o)}}),A.updateAgent(n.id,{relationships:a})}),!0}catch(s){return console.error("导入关系失败:",s),!1}}}const te=new Pe,De=()=>{const[m,t]=y.useState([]),[s,r]=y.useState(null),[n,a]=y.useState(!1),[i,o]=y.useState(!1),[l,c]=y.useState({}),[h,g]=y.useState("info");y.useEffect(()=>{x()},[]);const x=()=>{const u=A.getAllAgents();t(u),!s&&u.length>0&&r(u[0].id)},d=s?m.find(u=>u.id===s):null,R=u=>{r(u),a(!1),o(!1),g("info")},T=()=>{o(!0),a(!1),r(null),c({name:"",type:M.NPC,description:"",background:"",appearance:"",personality:{[C.OPENNESS]:50,[C.CONSCIENTIOUSNESS]:50,[C.EXTRAVERSION]:50,[C.AGREEABLENESS]:50,[C.NEUROTICISM]:50},goals:[],motivations:[],fears:[],dialogueStyle:"",location:"default"})},O=()=>{d&&(a(!0),o(!1),c({...d}))},v=()=>{d&&window.confirm(`确定要删除角色 "${d.name}" 吗？`)&&(A.removeAgent(s),x(),r(null))},j=u=>{const{name:f,value:H}=u.target;if(f.startsWith("personality.")){const Q=f.split(".")[1];c({...l,personality:{...l.personality,[Q]:parseInt(H,10)}})}else c({...l,[f]:H})},G=u=>{u.preventDefault();try{i?A.registerAgent(l):n&&A.updateAgent(s,l),x(),o(!1),a(!1)}catch(f){console.error("保存角色失败:",f),alert(`保存角色失败: ${f.message}`)}},_=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"角色列表"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:T,children:"创建角色"})]}),m.length===0?e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:'没有角色。点击"创建角色"按钮添加一个。'}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:m.map(u=>e.jsx("li",{className:"py-2",children:e.jsxs("button",{className:`w-full text-left px-3 py-2 rounded ${s===u.id?"bg-indigo-100 dark:bg-indigo-900":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,onClick:()=>R(u.id),children:[e.jsx("div",{className:"font-medium",children:u.name||u.id}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[u.type," ",u.location&&`· ${u.location}`]})]})},u.id))})]}),E=()=>d?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:d.name||d.id}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:[d.type," · ",d.location||"无位置"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:O,children:"编辑"}),d.id!=="player"&&d.id!=="gm"&&e.jsx("button",{className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",onClick:v,children:"删除"})]})]})}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:e.jsxs("nav",{className:"flex",children:[e.jsx("button",{className:`px-4 py-2 ${h==="info"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("info"),children:"基本信息"}),e.jsx("button",{className:`px-4 py-2 ${h==="relationships"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("relationships"),children:"关系"}),e.jsx("button",{className:`px-4 py-2 ${h==="inventory"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("inventory"),children:"物品栏"}),e.jsx("button",{className:`px-4 py-2 ${h==="status"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>g("status"),children:"状态"})]})}),e.jsxs("div",{className:"p-4",children:[h==="info"&&W(),h==="relationships"&&Y(),h==="inventory"&&P(),h==="status"&&z()]})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"请选择一个角色查看详情"})}),W=()=>e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"描述"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.description||"无描述"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"背景"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.background||"无背景信息"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"外貌"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.appearance||"无外貌描述"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"性格特质"}),d.personality?e.jsx("div",{className:"space-y-2",children:Object.entries(d.personality).map(([u,f])=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"w-32 font-medium",children:[b(u),":"]}),e.jsx("div",{className:"flex-grow",children:e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5",children:e.jsx("div",{className:"bg-indigo-500 h-2.5 rounded-full",style:{width:`${f}%`}})})}),e.jsx("div",{className:"w-8 text-right",children:f})]},u))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"无性格特质数据"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"目标"}),d.goals&&d.goals.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.goals.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"无目标"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"动机"}),d.motivations&&d.motivations.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.motivations.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"无动机"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"恐惧"}),d.fears&&d.fears.length>0?e.jsx("ul",{className:"list-disc list-inside text-gray-700 dark:text-gray-300",children:d.fears.map((u,f)=>e.jsx("li",{children:u},f))}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"无恐惧"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"对话风格"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300",children:d.dialogueStyle||"无特定对话风格"})]})]}),Y=()=>{const u=te.getAgentRelationships(s);return e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"角色关系"}),Object.keys(u).length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"没有与其他角色的关系"}):e.jsx("div",{className:"space-y-4",children:Object.entries(u).map(([f,H])=>{const Q=m.find(X=>X.id===f);return Q?e.jsxs("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg p-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:Q.name||f}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["关系类型: ",H.type||"未定义"]})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600",onClick:()=>{alert("编辑关系功能尚未实现")},children:"编辑"})]}),H.factors&&e.jsx("div",{className:"mt-3 space-y-2",children:Object.entries(H.factors).map(([X,se])=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"w-20 font-medium",children:[F(X),":"]}),e.jsx("div",{className:"flex-grow",children:e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5",children:e.jsx("div",{className:"bg-indigo-500 h-2.5 rounded-full",style:{width:`${se}%`}})})}),e.jsx("div",{className:"w-8 text-right",children:se})]},X))})]},f):null})})]})},P=()=>{const u=d.inventory||[];return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"物品栏"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:()=>{alert("添加物品功能尚未实现")},children:"添加物品"})]}),u.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"物品栏为空"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:u.map((f,H)=>e.jsxs("li",{className:"py-3 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f.name||f.id}),f.description&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:f.description})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{alert("移除物品功能尚未实现")},children:"移除"})]},H))})]})},z=()=>{const u=d.status||[];return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"状态效果"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:()=>{alert("添加状态功能尚未实现")},children:"添加状态"})]}),u.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"没有状态效果"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:u.map((f,H)=>e.jsxs("li",{className:"py-3 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f.name||f.id}),f.description&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:f.description}),f.duration&&e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["持续时间: ",f.duration]})]}),e.jsx("button",{className:"px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{alert("移除状态功能尚未实现")},children:"移除"})]},H))})]})},w=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:i?"创建角色":"编辑角色"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"名称"}),e.jsx("input",{type:"text",name:"name",value:l.name||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"类型"}),e.jsxs("select",{name:"type",value:l.type||M.NPC,onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:M.NPC,children:"NPC"}),e.jsx("option",{value:M.PLAYER,children:"玩家"}),e.jsx("option",{value:M.GM,children:"游戏主持人"}),e.jsx("option",{value:M.ENVIRONMENT,children:"环境"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"描述"}),e.jsx("textarea",{name:"description",value:l.description||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"背景"}),e.jsx("textarea",{name:"background",value:l.background||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"外貌"}),e.jsx("textarea",{name:"appearance",value:l.appearance||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"对话风格"}),e.jsx("textarea",{name:"dialogueStyle",value:l.dialogueStyle||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"3"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"位置"}),e.jsx("input",{type:"text",name:"location",value:l.location||"",onChange:j,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"性格特质"}),l.personality&&e.jsx("div",{className:"space-y-4",children:Object.entries(l.personality).map(([u,f])=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx("label",{className:"text-gray-700 dark:text-gray-300",children:b(u)}),e.jsx("span",{children:f})]}),e.jsx("input",{type:"range",name:`personality.${u}`,value:f,onChange:j,min:"0",max:"100",className:"w-full"})]},u))})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500",onClick:()=>{o(!1),a(!1)},children:"取消"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",children:"保存"})]})]})]}),b=u=>{switch(u){case C.OPENNESS:return"开放性";case C.CONSCIENTIOUSNESS:return"尽责性";case C.EXTRAVERSION:return"外向性";case C.AGREEABLENESS:return"亲和性";case C.NEUROTICISM:return"神经质";default:return u}},F=u=>{switch(u){case"trust":return"信任度";case"intimacy":return"亲密度";case"respect":return"尊重度";case"loyalty":return"忠诚度";case"dependency":return"依赖度";default:return u}};return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"角色管理"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-1",children:_()}),e.jsx("div",{className:"md:col-span-2",children:i||n?w():E()})]})]})},K={AGENT_RESPONSE:"agent_response",ENVIRONMENT_DESCRIPTION:"environment_description",STORY_PROGRESSION:"story_progression",DIALOGUE_GENERATION:"dialogue_generation",ACTION_RESULT:"action_result",WORLD_BUILDING:"world_building",CHARACTER_CREATION:"character_creation"};class Me{constructor(){this.templates={[K.AGENT_RESPONSE]:this._agentResponseTemplate,[K.ENVIRONMENT_DESCRIPTION]:this._environmentDescriptionTemplate,[K.STORY_PROGRESSION]:this._storyProgressionTemplate,[K.DIALOGUE_GENERATION]:this._dialogueGenerationTemplate,[K.ACTION_RESULT]:this._actionResultTemplate,[K.WORLD_BUILDING]:this._worldBuildingTemplate,[K.CHARACTER_CREATION]:this._characterCreationTemplate}}buildPrompt(t,s){const r=this.templates[t];if(!r)throw new Error(`未知的提示类型: ${t}`);const n=N.getState(),a={...s,gameState:n,currentTurn:n.turn,currentPhase:n.phase};return{text:r.call(this,a),type:t,timestamp:new Date().toISOString(),context:a}}_agentResponseTemplate(t){var g,x,d;const{agent:s,action:r,history:n}=t;if(!s)throw new Error("缺少角色信息");const a=typeof s=="string"?A.getAgent(s):s;if(!a)throw new Error(`角色不存在: ${s}`);let i=null;r&&r.actorId&&r.actorId!==a.id&&(i=te.getRelationship(a.id,r.actorId));const o=n||U.getRecentHistory(10),l=this._formatHistoryForPrompt(o),c=this._buildCharacterCardPrompt(a),h=this._buildSceneInfoPrompt(t);return`你是一个角色扮演AI，现在你将扮演以下角色：

${c}

当前场景：
${h}

历史记录：
${l}

${r?`最近的行为：
类型：${r.type}
执行者：${r.actorName||r.actorId||"未知"}
内容：${r.content}
${r.targetId===a.id?"这个行为直接针对你。":""}`:""}

${i?`与行为执行者的关系：
类型：${i.type}
信任度：${((g=i.factors)==null?void 0:g.trust)||50}/100
亲密度：${((x=i.factors)==null?void 0:x.intimacy)||0}/100
尊重度：${((d=i.factors)==null?void 0:d.respect)||50}/100`:""}

请根据你的角色设定、当前情绪状态、与其他角色的关系以及场景上下文，生成一个合适的响应。
响应应该反映你的性格特点、当前情绪和对事件的态度。

请用第一人称回应，不要在回应中包含旁白或动作描述。`}_environmentDescriptionTemplate(t){var o,l,c,h,g,x,d,R;const{locationId:s,details:r}=t,n=N.getState(),a=s?(l=(o=n.environment)==null?void 0:o.locations)==null?void 0:l[s]:(g=(c=n.environment)==null?void 0:c.locations)==null?void 0:g[(h=n.environment)==null?void 0:h.currentLocation];if(!a)throw new Error(`位置不存在: ${s||((x=n.environment)==null?void 0:x.currentLocation)}`);const i=A.getAllAgents().filter(T=>{var O;return T.location===(s||((O=n.environment)==null?void 0:O.currentLocation))}).map(T=>({id:T.id,name:T.name,type:T.type,description:T.description}));return`请为以下游戏场景生成一段详细的环境描述：

位置名称：${a.name}
基本描述：${a.description||"无描述"}
时间：${((d=n.environment)==null?void 0:d.currentTime)||"未知"}
天气：${((R=n.environment)==null?void 0:R.currentWeather)||"未知"}

${r?`额外细节：${r}`:""}

该位置的角色：
${i.length>0?i.map(T=>`- ${T.name}：${T.description||"无描述"}`).join(`
`):"没有角色在此位置"}

请生成一段生动、详细的环境描述，包括视觉、听觉、嗅觉等感官细节，以及环境的氛围和情绪。
描述应该有助于玩家想象自己身处其中的感觉。
不要包含角色的对话或行动，只描述环境本身。`}_storyProgressionTemplate(t){var l,c;const{currentPlot:s,direction:r,intensity:n}=t,a=N.getState(),i=U.getRecentHistory(15),o=this._formatHistoryForPrompt(i);return`作为游戏主持人，请根据当前故事情况，生成下一步的故事发展：

当前故事概要：
${s||((l=a.storyInfo)==null?void 0:l.currentPlot)||"无具体情节"}

世界背景：
${((c=a.worldBook)==null?void 0:c.mainSetting)||"无具体背景"}

最近的事件：
${o}

${r?`期望的发展方向：${r}`:""}
${n?`事件强度（1-10）：${n}`:""}

请生成接下来的故事发展，包括：
1. 新的事件或转折
2. 可能出现的冲突或挑战
3. NPC的可能反应
4. 环境或场景的变化

故事发展应该符合当前的情境和角色设定，并为玩家提供有趣的互动机会。
请避免直接解决所有问题或创造无法克服的障碍。`}_dialogueGenerationTemplate(t){var l;const{characters:s,topic:r,tone:n,length:a}=t,i=[];if(Array.isArray(s))for(const c of s){const h=A.getAgent(c);h&&i.push({id:h.id,name:h.name,description:h.description,personality:h.personality,dialogueStyle:h.dialogueStyle})}const o=[];for(let c=0;c<i.length;c++)for(let h=c+1;h<i.length;h++){const g=i[c],x=i[h],d=te.getRelationship(g.id,x.id);d&&o.push({character1:g.name,character2:x.name,type:d.type,trust:((l=d.factors)==null?void 0:l.trust)||50})}return`请为以下角色生成一段对话：

参与角色：
${i.map(c=>`- ${c.name}：${c.description||"无描述"}
   对话风格：${c.dialogueStyle||"无特定风格"}`).join(`
`)}

${o.length>0?`角色关系：
${o.map(c=>`- ${c.character1} 和 ${c.character2}：${c.type}关系，信任度 ${c.trust}/100`).join(`
`)}`:""}

对话主题：${r||"自由发挥"}
对话语气：${n||"根据角色性格决定"}
对话长度：${a||"适中"}

请根据角色的性格特点和彼此的关系，生成一段自然、符合人物设定的对话。
对话应该展现角色的个性和他们之间的关系动态。
请使用以下格式：

角色名：对话内容`}_actionResultTemplate(t){const{action:s,actor:r,difficulty:n,randomFactor:a}=t;if(!s)throw new Error("缺少行为信息");const i=r?typeof r=="string"?A.getAgent(r):r:null;return`请为以下游戏行为生成一个结果描述：

行为类型：${s.type}
行为内容：${s.content}
执行者：${i?i.name:s.actorName||s.actorId||"未知"}
${s.targetId?`目标：${s.targetName||s.targetId}`:""}

${i?`执行者信息：
- 描述：${i.description||"无描述"}
- 相关技能：${JSON.stringify(i.skills||{})}`:""}

${n?`难度等级（1-10）：${n}`:""}
${a?`随机因素（1-10）：${a}`:""}

请生成这个行为的结果描述，包括：
1. 行为的直接效果
2. 可能的副作用或意外情况
3. 对周围环境或角色的影响

结果应该符合逻辑，并考虑角色的能力和行为的难度。
如果有随机因素，请适当引入一些不确定性。
描述应该生动具体，避免模糊或过于概括的表述。`}_worldBuildingTemplate(t){const{theme:s,elements:r,tone:n,detail:a}=t,o=N.getState().worldBook||{};return`请为一个TRPG游戏创建或扩展以下世界设定：

${o.mainSetting?`现有世界背景：
${o.mainSetting}`:""}

主题：${s||"未指定"}
${r?`需要包含的元素：${r}`:""}
语调：${n||"适中"}
细节程度：${a||"中等"}

请创建以下内容：

1. 世界概述
   - 基本设定和背景
   - 世界历史的关键事件
   - 当前世界状态

2. 地理环境
   - 主要地区或位置描述
   - 特殊地标或重要场所
   - 环境特征和气候

3. 社会结构
   - 主要种族或群体
   - 政治体系和权力结构
   - 经济系统和贸易

4. 文化与信仰
   - 主要宗教或信仰系统
   - 文化习俗和传统
   - 艺术、音乐和文学

5. 魔法或科技系统
   - 基本原理和限制
   - 常见应用和影响
   - 特殊能力或装置

请确保设定具有内部一致性，并为玩家提供足够的探索和互动空间。
避免过于复杂或难以理解的设定，保持可玩性和趣味性。`}_characterCreationTemplate(t){var l;const{type:s,role:r,traits:n,background:a}=t,o=((l=N.getState().worldBook)==null?void 0:l.mainSetting)||"无特定世界设定";return`请为TRPG游戏创建一个详细的角色设定：

角色类型：${s||M.NPC}
角色角色：${r||"未指定"}
${n?`性格特点：${n}`:""}
${a?`背景要素：${a}`:""}

世界设定：
${o}

请创建以下内容：

1. 基本信息
   - 姓名
   - 年龄
   - 性别
   - 外貌描述

2. 背景故事
   - 成长经历
   - 关键事件
   - 动机和目标

3. 性格特质
   - 主要性格特点
   - 优点和缺点
   - 恐惧和喜好

4. 关系网络
   - 家人和朋友
   - 盟友和敌人
   - 社会地位

5. 能力和技能
   - 专长领域
   - 特殊能力
   - 弱点和限制

6. 对话风格
   - 说话方式
   - 常用语和口头禅
   - 表达习惯

请确保角色设定符合世界背景，并具有深度和复杂性。
角色应该有明确的动机和目标，以及足够的冲突点和发展空间。
避免创建完美无缺或单一维度的角色，应该有明显的优点和缺点。`}_formatHistoryForPrompt(t){return!t||t.length===0?"无历史记录":t.map(s=>{const r=s.timestamp?new Date(s.timestamp).toLocaleTimeString():"";switch(s.type){case"action":return`[${r}] ${s.actorName||s.actorId}: ${s.content}`;case"npc_response":return`[${r}] ${s.npcId}: ${s.content}`;case"environment":return`[${r}] 环境: ${s.description}`;case"system":return`[${r}] 系统: ${s.message}`;default:return`[${r}] ${JSON.stringify(s)}`}}).join(`
`)}_buildCharacterCardPrompt(t){var s,r,n,a,i;return t?`角色名称：${t.name}
角色类型：${t.type}
描述：${t.description||"无描述"}
背景：${t.background||"无背景"}
外貌：${t.appearance||"无外貌描述"}

性格特质：
- 开放性：${((s=t.personality)==null?void 0:s.openness)||50}/100
- 尽责性：${((r=t.personality)==null?void 0:r.conscientiousness)||50}/100
- 外向性：${((n=t.personality)==null?void 0:n.extraversion)||50}/100
- 亲和性：${((a=t.personality)==null?void 0:a.agreeableness)||50}/100
- 神经质：${((i=t.personality)==null?void 0:i.neuroticism)||50}/100

目标：${Array.isArray(t.goals)?t.goals.join(", "):t.goals||"无特定目标"}
动机：${Array.isArray(t.motivations)?t.motivations.join(", "):t.motivations||"无特定动机"}
恐惧：${Array.isArray(t.fears)?t.fears.join(", "):t.fears||"无特定恐惧"}

当前情绪：${t.currentEmotion||"中性"}（强度：${t.emotionIntensity||50}/100）
对话风格：${t.dialogueStyle||"无特定风格"}`:"无角色信息"}_buildSceneInfoPrompt(t){var i,o,l,c,h;const s=N.getState(),r=((i=s.environment)==null?void 0:i.currentLocation)||"unknown",n=((l=(o=s.environment)==null?void 0:o.locations)==null?void 0:l[r])||{name:"未知位置",description:"无描述"},a=A.getAllAgents().filter(g=>{var x;return g.location===r&&g.id!==((x=t.agent)==null?void 0:x.id)}).map(g=>g.name).join(", ");return`位置：${n.name}
描述：${n.description}
时间：${((c=s.environment)==null?void 0:c.currentTime)||"未知"}
天气：${((h=s.environment)==null?void 0:h.currentWeather)||"未知"}
其他在场角色：${a||"无"}`}registerCustomTemplate(t,s){if(typeof s!="function")throw new Error("模板必须是一个函数");this.templates[t]=s}getAvailablePromptTypes(){return Object.keys(this.templates)}}const Ge=new Me,B={OPENAI:"openai",LOCAL:"local",MOCK:"mock"},J={CHAT:"chat",COMPLETION:"completion",EMBEDDING:"embedding"},de={provider:B.OPENAI,model:"gpt-3.5-turbo",modelType:J.CHAT,temperature:.7,maxTokens:1e3,apiKey:"",apiEndpoint:"",useProxy:!1,proxyUrl:"",timeout:3e4,retries:3,mockResponses:{}};class He{constructor(){this.config={...de},this.mockResponses={},this.requestQueue=[],this.isProcessingQueue=!1,this.rateLimitDelay=1e3,this.lastRequestTime=0}initialize(t={}){this.config={...de,...t};const s=N.getState();s.llmConfig&&(this.config={...this.config,...s.llmConfig}),t.mockResponses&&(this.mockResponses=t.mockResponses),console.log("LLM适配器已初始化，提供商:",this.config.provider)}updateConfig(t){this.config={...this.config,...t},N.updateState({llmConfig:this.config}),console.log("LLM适配器配置已更新")}async sendRequest(t,s={}){try{const r={...this.config,...s};switch(r.provider){case B.OPENAI:return await this._sendOpenAIRequest(t,r);case B.LOCAL:return await this._sendLocalRequest(t,r);case B.MOCK:return await this._sendMockRequest(t,r);default:throw new Error(`不支持的LLM提供商: ${r.provider}`)}}catch(r){if(console.error("LLM请求失败:",r),s.retries>0)return console.log(`重试请求，剩余重试次数: ${s.retries-1}`),this.sendRequest(t,{...s,retries:s.retries-1});throw r}}async queueRequest(t,s={}){return new Promise((r,n)=>{this.requestQueue.push({prompt:t,options:s,resolve:r,reject:n}),this._processQueue()})}async _processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{for(;this.requestQueue.length>0;){const{prompt:t,options:s,resolve:r,reject:n}=this.requestQueue.shift(),a=Date.now(),i=Math.max(0,this.lastRequestTime+this.rateLimitDelay-a);i>0&&await new Promise(o=>setTimeout(o,i));try{const o=await this.sendRequest(t,s);r(o)}catch(o){n(o)}this.lastRequestTime=Date.now()}}finally{this.isProcessingQueue=!1}}}async _sendOpenAIRequest(t,s){var i,o,l,c,h;if(!s.apiKey)throw new Error("缺少OpenAI API密钥");const r=s.apiEndpoint||"https://api.openai.com/v1",n=s.modelType===J.CHAT?`${r}/chat/completions`:`${r}/completions`;let a;if(s.modelType===J.CHAT){const g=Array.isArray(t)?t:[{role:"system",content:"你是一个TRPG游戏中的AI助手。"},{role:"user",content:t}];a={model:s.model,messages:g,temperature:s.temperature,max_tokens:s.maxTokens,top_p:s.topP||1,frequency_penalty:s.frequencyPenalty||0,presence_penalty:s.presencePenalty||0}}else a={model:s.model,prompt:Array.isArray(t)?t.map(g=>g.content).join(`
`):t,temperature:s.temperature,max_tokens:s.maxTokens,top_p:s.topP||1,frequency_penalty:s.frequencyPenalty||0,presence_penalty:s.presencePenalty||0};try{const g=s.useProxy?`${s.proxyUrl}${n}`:n,x=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify(a),signal:s.timeout?AbortSignal.timeout(s.timeout):void 0});if(!x.ok){const T=await x.json().catch(()=>({}));throw new Error(`OpenAI API请求失败: ${x.status} ${x.statusText}, ${JSON.stringify(T)}`)}const d=await x.json();let R;return s.modelType===J.CHAT?R={text:((o=(i=d.choices[0])==null?void 0:i.message)==null?void 0:o.content)||"",role:((c=(l=d.choices[0])==null?void 0:l.message)==null?void 0:c.role)||"assistant",usage:d.usage,model:d.model,id:d.id,provider:B.OPENAI}:R={text:((h=d.choices[0])==null?void 0:h.text)||"",usage:d.usage,model:d.model,id:d.id,provider:B.OPENAI},R}catch(g){throw console.error("OpenAI API请求错误:",g),g}}async _sendLocalRequest(t,s){return console.log("发送请求到本地模型，这需要根据实际情况实现"),{text:"这是本地模型的响应。实际实现需要根据你使用的本地模型来定制。",model:s.model,provider:B.LOCAL}}async _sendMockRequest(t,s){console.log("发送模拟请求，用于测试");const r=Array.isArray(t)?t.map(a=>a.content).join(`
`):t;let n="这是一个模拟响应。";for(const[a,i]of Object.entries(this.mockResponses))if(r.includes(a)){n=i;break}return await new Promise(a=>setTimeout(a,500)),{text:n,model:"mock-model",provider:B.MOCK}}addMockResponse(t,s){this.mockResponses[t]=s}async chatCompletion(t,s={}){return this.sendRequest(t,{...s,modelType:J.CHAT})}async textCompletion(t,s={}){return this.sendRequest(t,{...s,modelType:J.COMPLETION})}getConfig(){return{...this.config}}async checkConnection(){try{return!!await this.sendRequest("测试连接",{maxTokens:5,temperature:.1})}catch(t){return console.error("API连接检查失败:",t),!1}}estimateTokens(t){return(t.match(/[\u4e00-\u9fa5]/g)||[]).length/t.length>.5?Math.ceil(t.length/1.5):Math.ceil(t.length/4)}}const ee=new He,Ue=()=>{const[m,t]=y.useState({mainSetting:"",entries:[]}),[s,r]=y.useState(null),[n,a]=y.useState(!1),[i,o]=y.useState(!1),[l,c]=y.useState({}),[h,g]=y.useState(""),[x,d]=y.useState([]),[R,T]=y.useState("all"),[O,v]=y.useState(!1),[j,G]=y.useState(""),[_,E]=y.useState("");y.useEffect(()=>{W()},[]);const W=()=>{const I=N.getState().worldBook||{mainSetting:"",entries:[]};t(I);const q=[...new Set(I.entries.map(ae=>ae.category))].filter(Boolean);d(q),!s&&I.entries.length>0&&r(I.entries[0].id)},Y=p=>{N.updateState({worldBook:p}),t(p)},P=s?m.entries.find(p=>p.id===s):null,z=m.entries.filter(p=>{if(R!=="all"&&p.category!==R)return!1;if(h){const I=h.toLowerCase();return p.name&&p.name.toLowerCase().includes(I)||p.content&&p.content.toLowerCase().includes(I)||p.category&&p.category.toLowerCase().includes(I)}return!0}),w=p=>{r(p),a(!1),o(!1)},b=()=>{o(!0),a(!1),r(null),c({name:"",content:"",category:"",tags:[],isActive:!0})},F=()=>{P&&(a(!0),o(!1),c({...P}))},u=()=>{if(P&&window.confirm(`确定要删除条目 "${P.name}" 吗？`)){const p=m.entries.filter(I=>I.id!==s);Y({...m,entries:p}),r(null)}},f=()=>{a(!0),o(!1),r(null),c({mainSetting:m.mainSetting||""})},H=p=>{const{name:I,value:q}=p.target;c({...l,[I]:q})},Q=p=>{const q=p.target.value.split(",").map(ae=>ae.trim()).filter(Boolean);c({...l,tags:q})},X=p=>{p.preventDefault();try{if(l.mainSetting!==void 0)Y({...m,mainSetting:l.mainSetting});else if(i){const I={...l,id:`entry_${Date.now()}`,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};Y({...m,entries:[...m.entries,I]}),l.category&&!x.includes(l.category)&&d([...x,l.category])}else if(n&&s){const I=m.entries.map(q=>q.id===s?{...q,...l,updatedAt:new Date().toISOString()}:q);Y({...m,entries:I}),l.category&&!x.includes(l.category)&&d([...x,l.category])}o(!1),a(!1)}catch(I){console.error("保存条目失败:",I),alert(`保存失败: ${I.message}`)}},se=async()=>{try{v(!0);const p=Ge.buildPrompt("world_building",{theme:_,elements:j,tone:"immersive",detail:"high"}),I=await ee.sendRequest(p.text,{temperature:.7,maxTokens:1e3});Y({...m,mainSetting:I.text}),G(""),E(""),v(!1)}catch(p){console.error("生成世界设定失败:",p),alert(`生成失败: ${p.message}`),v(!1)}},ge=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"世界书条目"}),e.jsx("button",{className:"px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600",onClick:b,children:"创建条目"})]}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsx("input",{type:"text",placeholder:"搜索条目...",value:h,onChange:p=>g(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"}),e.jsxs("select",{value:R,onChange:p=>T(p.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"所有类别"}),x.map(p=>e.jsx("option",{value:p,children:p},p))]})]}),z.length===0?e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:m.entries.length===0?'没有条目。点击"创建条目"按钮添加一个。':"没有匹配的条目。"}):e.jsx("ul",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:z.map(p=>e.jsx("li",{className:"py-2",children:e.jsxs("button",{className:`w-full text-left px-3 py-2 rounded ${s===p.id?"bg-indigo-100 dark:bg-indigo-900":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,onClick:()=>w(p.id),children:[e.jsx("div",{className:"font-medium",children:p.name||"未命名条目"}),p.category&&e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:p.category})]})},p.id))})]}),ue=()=>P?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:P.name||"未命名条目"}),P.category&&e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:["类别: ",P.category]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:F,children:"编辑"}),e.jsx("button",{className:"px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600",onClick:u,children:"删除"})]})]})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"内容"}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded border border-gray-200 dark:border-gray-700",children:P.content||"无内容"})]}),P.tags&&P.tags.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"标签"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:P.tags.map((p,I)=>e.jsx("span",{className:"px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-full text-sm",children:p},I))})]}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-4",children:["创建时间: ",new Date(P.createdAt).toLocaleString(),e.jsx("br",{}),"更新时间: ",new Date(P.updatedAt).toLocaleString()]})]})]}):e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-8",children:"请选择一个条目查看详情"})}),pe=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"世界主要设定"}),e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:f,children:"编辑"})]}),e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-3 rounded border border-gray-200 dark:border-gray-700",children:m.mainSetting?e.jsx("div",{className:"whitespace-pre-line",children:m.mainSetting}):e.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:'没有主要设定。点击"编辑"按钮添加。'})})]}),xe=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"AI生成世界设定"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"主题"}),e.jsx("input",{type:"text",value:_,onChange:p=>E(p.target.value),placeholder:"例如：中世纪奇幻、赛博朋克、太空歌剧...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"元素和要求"}),e.jsx("textarea",{value:j,onChange:p=>G(p.target.value),placeholder:"描述你想要包含的元素、特点或要求...",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"4"})]}),e.jsx("button",{className:"w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed",onClick:se,disabled:O||!_&&!j,children:O?"生成中...":"生成世界设定"}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"注意：生成的内容将替换当前的主要设定。请确保在生成前备份重要内容。"})]})]}),ye=()=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-4",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:l.mainSetting!==void 0?"编辑主要设定":i?"创建条目":"编辑条目"}),e.jsxs("form",{onSubmit:X,children:[l.mainSetting!==void 0?e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"主要设定"}),e.jsx("textarea",{name:"mainSetting",value:l.mainSetting,onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"10"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"名称"}),e.jsx("input",{type:"text",name:"name",value:l.name||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",required:!0})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"内容"}),e.jsx("textarea",{name:"content",value:l.content||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",rows:"6"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"类别"}),e.jsx("input",{type:"text",name:"category",value:l.category||"",onChange:H,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",list:"categories"}),e.jsx("datalist",{id:"categories",children:x.map(p=>e.jsx("option",{value:p},p))})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"标签（用逗号分隔）"}),e.jsx("input",{type:"text",value:l.tags?l.tags.join(", "):"",onChange:Q,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"isActive",checked:l.isActive!==!1,onChange:p=>c({...l,isActive:p.target.checked}),className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"启用此条目"})]})})]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{type:"button",className:"px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-400 dark:hover:bg-gray-500",onClick:()=>{o(!1),a(!1)},children:"取消"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",children:"保存"})]})]})]});return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"世界书"}),i||n?ye():e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"md:col-span-1",children:[pe(),xe()]}),e.jsx("div",{className:"md:col-span-1",children:ge()}),e.jsx("div",{className:"md:col-span-1",children:ue()})]})]})},Fe=({onResetGame:m,onExportGame:t,onImportGame:s})=>{const[r,n]=y.useState({}),[a,i]=y.useState({}),[o,l]=y.useState("llm"),[c,h]=y.useState(!1),[g,x]=y.useState(null),[d,R]=y.useState(Date.now());y.useEffect(()=>{T()},[]);const T=()=>{const w=ee.getConfig();n(w);const b=N.getState();i({maxHistoryLength:b.maxHistoryLength||100,autoSave:b.autoSave!==!1,autoSaveInterval:b.autoSaveInterval||5,debugMode:b.debugMode||!1})},O=w=>{const{name:b,value:F,type:u,checked:f}=w.target;n({...r,[b]:u==="checkbox"?f:u==="number"?Number(F):F})},v=w=>{const{name:b,value:F,type:u,checked:f}=w.target;i({...a,[b]:u==="checkbox"?f:u==="number"?Number(F):F})},j=()=>{try{ee.updateConfig(r),alert("LLM配置已保存")}catch(w){console.error("保存LLM配置失败:",w),alert(`保存失败: ${w.message}`)}},G=()=>{try{N.updateState({maxHistoryLength:a.maxHistoryLength,autoSave:a.autoSave,autoSaveInterval:a.autoSaveInterval,debugMode:a.debugMode}),alert("游戏配置已保存")}catch(w){console.error("保存游戏配置失败:",w),alert(`保存失败: ${w.message}`)}},_=async()=>{try{h(!0),x(null);const w={...r};ee.updateConfig(w);const b=await ee.checkConnection();x(b?"success":"error")}catch(w){console.error("测试连接失败:",w),x("error")}finally{h(!1)}},E=w=>{s&&(s(w),R(Date.now()))},W=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"LLM设置"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"提供商"}),e.jsxs("select",{name:"provider",value:r.provider||B.OPENAI,onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:B.OPENAI,children:"OpenAI"}),e.jsx("option",{value:B.LOCAL,children:"本地模型"}),e.jsx("option",{value:B.MOCK,children:"模拟模式"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"模型"}),e.jsx("input",{type:"text",name:"model",value:r.model||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"例如: gpt-3.5-turbo"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"模型类型"}),e.jsxs("select",{name:"modelType",value:r.modelType||J.CHAT,onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:J.CHAT,children:"聊天模型"}),e.jsx("option",{value:J.COMPLETION,children:"文本补全模型"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"API密钥"}),e.jsx("input",{type:"password",name:"apiKey",value:r.apiKey||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"输入你的API密钥"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"API端点 (可选)"}),e.jsx("input",{type:"text",name:"apiEndpoint",value:r.apiEndpoint||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"例如: https://api.openai.com/v1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"温度 (0-1)"}),e.jsx("input",{type:"range",name:"temperature",min:"0",max:"1",step:"0.1",value:r.temperature||.7,onChange:O,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-500 dark:text-gray-400",children:[e.jsx("span",{children:"更确定 (0)"}),e.jsx("span",{children:r.temperature||.7}),e.jsx("span",{children:"更随机 (1)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"最大令牌数"}),e.jsx("input",{type:"number",name:"maxTokens",value:r.maxTokens||1e3,onChange:O,min:"100",max:"8000",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"useProxy",checked:r.useProxy||!1,onChange:O,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"使用代理"})]})}),r.useProxy&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"代理URL"}),e.jsx("input",{type:"text",name:"proxyUrl",value:r.proxyUrl||"",onChange:O,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",placeholder:"例如: http://localhost:8080/"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",onClick:j,children:"保存配置"}),e.jsx("button",{className:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed",onClick:_,disabled:c,children:c?"测试中...":"测试连接"})]}),g&&e.jsx("div",{className:`p-3 rounded ${g==="success"?"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"}`,children:g==="success"?"连接成功！LLM API可用。":"连接失败。请检查你的API密钥和设置。"})]})]}),Y=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"游戏设置"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"最大历史记录长度"}),e.jsx("input",{type:"number",name:"maxHistoryLength",value:a.maxHistoryLength||100,onChange:v,min:"10",max:"1000",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"保存在内存中的最大历史记录数量"})]}),e.jsx("div",{children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"autoSave",checked:a.autoSave!==!1,onChange:v,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"启用自动保存"})]})}),a.autoSave!==!1&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"自动保存间隔（分钟）"}),e.jsx("input",{type:"number",name:"autoSaveInterval",value:a.autoSaveInterval||5,onChange:v,min:"1",max:"60",className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",name:"debugMode",checked:a.debugMode||!1,onChange:v,className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"调试模式"})]}),e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400 mt-1",children:"启用额外的日志和调试信息"})]}),e.jsx("button",{className:"px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600",onClick:G,children:"保存配置"})]})]}),P=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"界面设置"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"主题"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"light",checked:document.documentElement.classList.contains("dark")===!1,onChange:()=>{document.documentElement.classList.remove("dark"),localStorage.setItem("darkMode","false")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"亮色"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"dark",checked:document.documentElement.classList.contains("dark")===!0,onChange:()=>{document.documentElement.classList.add("dark"),localStorage.setItem("darkMode","true")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"暗色"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"theme",value:"system",checked:localStorage.getItem("darkMode")===null,onChange:()=>{window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.removeItem("darkMode")},className:"mr-2"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:"跟随系统"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-700 dark:text-gray-300 font-medium mb-2",children:"字体大小"}),e.jsxs("select",{className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700",onChange:w=>{document.documentElement.style.fontSize=w.target.value,localStorage.setItem("fontSize",w.target.value)},value:localStorage.getItem("fontSize")||"16px",children:[e.jsx("option",{value:"14px",children:"小"}),e.jsx("option",{value:"16px",children:"中"}),e.jsx("option",{value:"18px",children:"大"}),e.jsx("option",{value:"20px",children:"特大"})]})]})]})]}),z=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"数据管理"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"导出游戏数据"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"导出当前游戏的所有数据，包括游戏状态、历史记录和角色信息。"}),e.jsx("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",onClick:t,children:"导出数据"})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"导入游戏数据"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"从文件导入游戏数据，将覆盖当前的游戏状态。"}),e.jsxs("label",{className:"inline-block px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 cursor-pointer",children:["选择文件",e.jsx("input",{type:"file",className:"hidden",accept:".json",onChange:E},d)]})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"重置游戏"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"重置游戏到初始状态，将删除所有进度。此操作不可撤销。"}),e.jsx("button",{className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",onClick:m,children:"重置游戏"})]}),e.jsxs("div",{className:"p-4 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[e.jsx("h3",{className:"font-medium mb-2",children:"清除本地存储"}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-3",children:"清除浏览器中保存的所有游戏数据。此操作不可撤销。"}),e.jsx("button",{className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>{window.confirm("确定要清除所有本地存储数据吗？此操作不可撤销。")&&(localStorage.clear(),alert("本地存储已清除。请刷新页面。"))},children:"清除存储"})]})]})]});return e.jsxs("div",{className:"container mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"设置"}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow",children:[e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:e.jsxs("nav",{className:"flex",children:[e.jsx("button",{className:`px-4 py-2 ${o==="llm"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("llm"),children:"LLM设置"}),e.jsx("button",{className:`px-4 py-2 ${o==="game"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("game"),children:"游戏设置"}),e.jsx("button",{className:`px-4 py-2 ${o==="interface"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("interface"),children:"界面设置"}),e.jsx("button",{className:`px-4 py-2 ${o==="data"?"border-b-2 border-indigo-500 text-indigo-500":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"}`,onClick:()=>l("data"),children:"数据管理"})]})}),e.jsxs("div",{className:"p-6",children:[o==="llm"&&W(),o==="game"&&Y(),o==="interface"&&P(),o==="data"&&z()]})]})]})};class Be{processAction(t,s=null){const r=s||N.getState();switch(t.type){case S.DIALOGUE:return this._processDialogue(t,r);case S.ACTION:return this._processPhysicalAction(t,r);case S.ITEM:return this._processItemAction(t,r);default:return console.warn(`未知的行为类型: ${t.type}`),r}}_processDialogue(t,s){const r={...s};return r.updatedAt=new Date().toISOString(),t.targetType===D.CHARACTER&&t.targetId,r}_processPhysicalAction(t,s){const r={...s};switch(r.updatedAt=new Date().toISOString(),t.targetType){case D.CHARACTER:return this._processCharacterTargetedAction(t,r);case D.ENVIRONMENT:return this._processEnvironmentTargetedAction(t,r);case D.ITEM:return this._processItemTargetedAction(t,r);default:return r}}_processItemAction(t,s){const r={...s};r.updatedAt=new Date().toISOString();const n=t.itemId;let a=!1;if(r.player&&r.player.inventory&&(a=r.player.inventory.some(i=>i.id===n)),!a&&r.environment&&r.environment.locations){const i=r.environment.currentLocation,o=r.environment.locations[i];o&&o.objects&&(a=o.objects.some(l=>l.id===n))}if(!a)return console.warn(`物品不存在: ${n}`),r;switch(t.targetType){case D.CHARACTER:return this._processItemOnCharacter(t,r);case D.ENVIRONMENT:return this._processItemOnEnvironment(t,r);case D.ITEM:return this._processItemOnItem(t,r);default:return this._processItemGeneral(t,r)}}_processCharacterTargetedAction(t,s){const r=t.targetId;let n=null;return r==="player"?n=s.player:n=s.agents.find(a=>a.id===r),n||console.warn(`目标角色不存在: ${r}`),s}_processEnvironmentTargetedAction(t,s){const r=s.environment.currentLocation;return s.environment.locations[r]||console.warn(`当前位置不存在: ${r}`),s}_processItemTargetedAction(t,s){const r=t.targetId;let n=null;if(s.player&&s.player.inventory&&(n=s.player.inventory.find(a=>a.id===r)),!n&&s.environment&&s.environment.locations){const a=s.environment.currentLocation,i=s.environment.locations[a];i&&i.objects&&(n=i.objects.find(o=>o.id===r))}return n||console.warn(`目标物品不存在: ${r}`),s}_processItemOnCharacter(t,s){return s}_processItemOnEnvironment(t,s){return s}_processItemOnItem(t,s){return s}_processItemGeneral(t,s){return s}applyTransition(t){const s=N.getState(),r=this.processAction(t,s);return N.updateState(r),r}applyTransitions(t){let s=N.getState();for(const r of t)s=this.processAction(r,s);return N.updateState(s),s}}const Ye=new Be,L={DIALOGUE:"dialogue",ACTION:"action",EMOTION:"emotion",DECISION:"decision",REJECTION:"rejection"},Z={COOPERATE:"cooperate",COMPETE:"compete",AVOID:"avoid",HELP:"help",ATTACK:"attack",NEUTRAL:"neutral"};class Ve{constructor(){this.responseTemplates={[k.HAPPY]:['{{name}}笑着说，"{{content}}"','{{name}}愉快地回应，"{{content}}"','{{name}}面带微笑，"{{content}}"'],[k.SAD]:['{{name}}叹了口气，"{{content}}"','{{name}}低落地说，"{{content}}"','{{name}}声音中带着悲伤，"{{content}}"'],[k.ANGRY]:['{{name}}怒气冲冲地说，"{{content}}"','{{name}}提高了声音，"{{content}}"','{{name}}愤怒地回应，"{{content}}"'],[k.FEARFUL]:['{{name}}紧张地说，"{{content}}"','{{name}}声音颤抖着，"{{content}}"','{{name}}畏缩着回应，"{{content}}"'],[k.DISGUSTED]:['{{name}}厌恶地说，"{{content}}"','{{name}}皱着眉头，"{{content}}"','{{name}}不悦地回应，"{{content}}"'],[k.SURPRISED]:['{{name}}惊讶地说，"{{content}}"','{{name}}睁大了眼睛，"{{content}}"','{{name}}震惊地回应，"{{content}}"'],[k.NEUTRAL]:['{{name}}说，"{{content}}"','{{name}}回应道，"{{content}}"','{{name}}平静地说，"{{content}}"']}}async generateResponse(t,s,r={}){try{const n=A.getAgent(t);if(!n)throw new Error(`角色不存在: ${t}`);const a=A.createAgentCard(t),i=s.actorId?te.getRelationship(t,s.actorId):null,o=U.getRecentHistory(10),l=this._prepareResponseContext(n,s,i,o,r);let c;switch(n.type){case M.NPC:c=await this._generateNPCResponse(n,l,r);break;case M.GM:c=await this._generateGMResponse(n,l,r);break;case M.ENVIRONMENT:c=await this._generateEnvironmentResponse(n,l,r);break;default:throw new Error(`不支持的角色类型: ${n.type}`)}return c.type===L.DIALOGUE&&U.addNPCResponseEntry(t,c.content,{emotion:n.currentEmotion,intensity:n.emotionIntensity}),c.emotion&&c.emotion!==n.currentEmotion&&A.updateAgentEmotion(t,c.emotion,c.emotionIntensity||n.emotionIntensity),c}catch(n){return console.error("生成角色响应失败:",n),{type:L.REJECTION,content:"无法生成响应",error:n.message}}}_prepareResponseContext(t,s,r,n,a){var h,g,x;const i=N.getState(),o=((h=i.environment)==null?void 0:h.currentLocation)||"unknown",l=((x=(g=i.environment)==null?void 0:g.locations)==null?void 0:x[o])||{name:"未知位置",description:""},c=te.getSocialNetwork(t.id);return{agent:{id:t.id,name:t.name,type:t.type,personality:t.personality,currentEmotion:t.currentEmotion,emotionIntensity:t.emotionIntensity,goals:t.goals,fears:t.fears,dialogueStyle:t.dialogueStyle},action:{type:s.type,content:s.content,actorId:s.actorId,actorName:this._getAgentName(s.actorId),targetId:s.targetId,targetName:this._getAgentName(s.targetId)},relationship:r?{type:r.type,trust:r.factors[V.TRUST],intimacy:r.factors[V.INTIMACY],respect:r.factors[V.RESPECT]}:null,environment:{locationId:o,locationName:l.name,locationDescription:l.description},socialNetwork:c.map(d=>({id:d.agentId,name:d.name,relationshipStatus:d.relationship.status})),history:this._formatHistoryForContext(n),options:a}}_getAgentName(t){if(!t)return"";const s=A.getAgent(t);return s?s.name:t}_formatHistoryForContext(t){return t.map(s=>{var r;switch(s.type){case $.ACTION:return{type:"action",actorName:this._getAgentName(s.actorId),content:s.content,timestamp:s.timestamp};case $.NPC_RESPONSE:return{type:"response",speakerName:this._getAgentName(s.npcId),content:s.content,emotion:(r=s.metadata)==null?void 0:r.emotion,timestamp:s.timestamp};case $.ENVIRONMENT:return{type:"environment",locationName:s.locationId,description:s.description,timestamp:s.timestamp};default:return null}}).filter(s=>s!==null)}async _generateNPCResponse(t,s,r){switch(this._determineResponseType(s)){case L.DIALOGUE:return this._generateDialogueResponse(t,s);case L.ACTION:return this._generateActionResponse(t,s);case L.EMOTION:return this._generateEmotionResponse(t,s);case L.DECISION:return this._generateDecisionResponse(t,s);case L.REJECTION:return{type:L.REJECTION,content:"我不想回应这个。",reason:"不适合的互动"};default:return this._generateDialogueResponse(t,s)}}async _generateGMResponse(t,s,r){return{type:L.DIALOGUE,content:this._generateNarrativeDescription(s),emotion:k.NEUTRAL,emotionIntensity:50}}async _generateEnvironmentResponse(t,s,r){return{type:L.DIALOGUE,content:this._generateEnvironmentDescription(s),emotion:null}}_determineResponseType(t){const{agent:s,action:r,relationship:n}=t;return r.type==="dialogue"&&r.targetId===s.id?L.DIALOGUE:s.emotionIntensity>70?L.EMOTION:r.content.includes("请求")||r.content.includes("帮助")?L.DECISION:n&&n.trust<20&&Math.random()>.7?L.REJECTION:L.DIALOGUE}_generateDialogueResponse(t,s){const{action:r,relationship:n}=s;let a="",i=t.currentEmotion;if(r.content.includes("你好")||r.content.includes("嗨"))a=`你好，${r.actorName}。很高兴见到你。`,i=k.HAPPY;else if(r.content.includes("谢谢")||r.content.includes("感谢"))a="不客气，这是我应该做的。",i=k.HAPPY;else if(r.content.includes("抱歉")||r.content.includes("对不起"))a=n&&n.trust>60?"没关系，我理解。":"嗯，我接受你的道歉。",i=n&&n.trust>60?k.HAPPY:k.NEUTRAL;else if(r.content.includes("再见"))a="再见，保重。",i=k.NEUTRAL;else{const l=["我明白你的意思。","有意思的观点。","让我想想...","我需要考虑一下这个。"];a=l[Math.floor(Math.random()*l.length)]}const o=this._formatResponse(t,a,i);return{type:L.DIALOGUE,content:o,rawContent:a,emotion:i,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateActionResponse(t,s){const{action:r}=s;let n="",a=t.currentEmotion;return r.content.includes("攻击")||r.content.includes("伤害")?(n=`${t.name}迅速躲避，试图保护自己。`,a=k.FEARFUL):r.content.includes("给予")||r.content.includes("递给")?(n=`${t.name}接过物品，仔细查看。`,a=k.NEUTRAL):r.content.includes("拥抱")?(n=`${t.name}回应了拥抱。`,a=k.HAPPY):n=`${t.name}观察着情况，等待下一步行动。`,{type:L.ACTION,content:n,emotion:a,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateEmotionResponse(t,s){const{action:r}=s;let n="",a=t.currentEmotion;switch(t.currentEmotion){case k.HAPPY:n=`${t.name}笑容满面，看起来心情很好。`;break;case k.SAD:n=`${t.name}低下头，眼中含着泪水。`;break;case k.ANGRY:n=`${t.name}握紧拳头，怒视着${r.actorName}。`;break;case k.FEARFUL:n=`${t.name}颤抖着后退几步，警惕地看着周围。`;break;case k.DISGUSTED:n=`${t.name}皱起眉头，表情厌恶。`;break;case k.SURPRISED:n=`${t.name}睁大眼睛，一时说不出话来。`;break;default:n=`${t.name}的表情变得难以捉摸。`;break}return{type:L.EMOTION,content:n,emotion:a,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateDecisionResponse(t,s){const{relationship:r}=s,n=t.personality;let a=0;a+=(n[C.AGREEABLENESS]-50)*.5,a+=(n[C.EXTRAVERSION]-50)*.3,a+=(50-n[C.NEUROTICISM])*.2,r&&(a+=(r.trust-50)*.6,a+=(r.respect-50)*.4);let i,o="",l;return a>30?(i=Z.COOPERATE,o=`${t.name}决定合作，"我会帮助你的。"`,l=k.HAPPY):a>10?(i=Z.HELP,o=`${t.name}点点头，"我可以试试看。"`,l=k.NEUTRAL):a>-10?(i=Z.NEUTRAL,o=`${t.name}犹豫了一下，"我需要考虑一下。"`,l=k.NEUTRAL):a>-30?(i=Z.AVOID,o=`${t.name}摇摇头，"恐怕我不能参与这个。"`,l=k.FEARFUL):(i=Z.COMPETE,o=`${t.name}冷笑一声，"别指望我会帮你。"`,l=k.ANGRY),{type:L.DECISION,content:o,decisionType:i,emotion:l,emotionIntensity:this._calculateEmotionIntensity(t,s)}}_generateNarrativeDescription(t){const{action:s,environment:r}=t;return`在${r.locationName}，${s.actorName}${s.content}。
周围的环境${r.locationDescription}。`}_generateEnvironmentDescription(t){const{environment:s}=t;return`${s.locationName}: ${s.locationDescription}`}_formatResponse(t,s,r){const n=this.responseTemplates[r]||this.responseTemplates[k.NEUTRAL];return n[Math.floor(Math.random()*n.length)].replace("{{name}}",t.name).replace("{{content}}",s)}_calculateEmotionIntensity(t,s){let r=t.emotionIntensity||50;const n=t.personality[C.NEUROTICISM]||50;return r=r*(1+(n-50)/100),Math.max(0,Math.min(100,r))}async generateMultipleResponses(t,s,r={}){const n=[];for(const a of t)try{const i=await this.generateResponse(a,s,r);n.push({agentId:a,response:i})}catch(i){console.error(`生成角色 ${a} 的响应失败:`,i),n.push({agentId:a,response:{type:L.REJECTION,content:"无法生成响应",error:i.message}})}return n}async generateSceneResponses(t,s={}){var o;const n=((o=N.getState().environment)==null?void 0:o.currentLocation)||"",i=A.getAgentsByType(M.NPC).filter(l=>l.location===n).map(l=>l.id);return i.push("gm"),this.generateMultipleResponses(i,t,s)}}const qe=new Ve,Je=()=>{const[m,t]=y.useState("game"),[s,r]=y.useState(N.getState()),[n,a]=y.useState([]),[i,o]=y.useState(!1),[l,c]=y.useState(""),[h,g]=y.useState(localStorage.getItem("darkMode")==="true"||window.matchMedia("(prefers-color-scheme: dark)").matches);y.useEffect(()=>{N.initialize(),r(N.getState()),U.loadFromLocalStorage(),a(U.getRecentHistory(20)),A.initialize();const v=()=>{r({...N.getState()})},j=()=>{a(U.getRecentHistory(20))};return window.addEventListener("gameStateChanged",v),window.addEventListener("historyChanged",j),()=>{window.removeEventListener("gameStateChanged",v),window.removeEventListener("historyChanged",j)}},[]),y.useEffect(()=>{h?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),localStorage.setItem("darkMode",h)},[h]);const x=async v=>{try{o(!0),c("处理中..."),U.addActionEntry(v);const j=Ye.applyTransition(v);(await qe.generateSceneResponses(v)).forEach(({agentId:_,response:E})=>{E.type==="dialogue"&&U.addNPCResponseEntry(_,E.content,{emotion:E.emotion,intensity:E.emotionIntensity})}),U.saveToLocalStorage(),c("")}catch(j){console.error("处理行为失败:",j),c(`错误: ${j.message}`)}finally{o(!1)}},d=()=>{window.confirm("确定要重置游戏吗？这将清除所有进度。")&&(N.reset(),U.clearHistory(),r({...N.getState()}),a([]),c("游戏已重置"))},R=()=>{try{N.saveToLocalStorage(),U.saveToLocalStorage(),c("游戏已保存"),setTimeout(()=>{c("")},3e3)}catch(v){console.error("保存游戏失败:",v),c(`保存失败: ${v.message}`)}},T=()=>{try{const v={gameState:N.exportState(),history:U.exportHistory(),agents:A.exportAgents()},j=JSON.stringify(v,null,2),G=`data:application/json;charset=utf-8,${encodeURIComponent(j)}`,_=`ai_trpg_save_${new Date().toISOString().slice(0,10)}.json`,E=document.createElement("a");E.setAttribute("href",G),E.setAttribute("download",_),E.click(),c("游戏已导出"),setTimeout(()=>{c("")},3e3)}catch(v){console.error("导出游戏失败:",v),c(`导出失败: ${v.message}`)}},O=v=>{try{const j=v.target.files[0];if(!j)return;const G=new FileReader;G.onload=_=>{try{const E=JSON.parse(_.target.result);E.gameState&&(N.importState(E.gameState),r({...N.getState()})),E.history&&(U.importHistory(E.history),a(U.getRecentHistory(20))),E.agents&&A.importAgents(E.agents),c("游戏已导入"),setTimeout(()=>{c("")},3e3)}catch(E){console.error("解析导入数据失败:",E),c(`导入失败: ${E.message}`)}},G.onerror=()=>{c("读取文件失败")},G.readAsText(j)}catch(j){console.error("导入游戏失败:",j),c(`导入失败: ${j.message}`)}finally{v.target.value=null}};return e.jsxs("div",{className:"flex flex-col h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100",children:[e.jsx("header",{className:"bg-indigo-600 dark:bg-indigo-800 text-white p-4 shadow-md",children:e.jsxs("div",{className:"container mx-auto flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"AI TRPG 系统"}),e.jsxs("nav",{className:"flex space-x-4",children:[e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="game"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("game"),children:"游戏"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="characters"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("characters"),children:"角色"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="worldbook"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("worldbook"),children:"世界书"}),e.jsx("button",{className:`px-3 py-1 rounded-md ${m==="settings"?"bg-indigo-800 dark:bg-indigo-700":"hover:bg-indigo-700 dark:hover:bg-indigo-600"}`,onClick:()=>t("settings"),children:"设置"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{className:"p-2 rounded-full hover:bg-indigo-700 dark:hover:bg-indigo-600",onClick:()=>g(!h),title:h?"切换到亮色模式":"切换到暗色模式",children:h?e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z",clipRule:"evenodd"})}):e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"})})}),e.jsx("button",{className:"p-2 rounded-full hover:bg-indigo-700 dark:hover:bg-indigo-600",onClick:R,title:"保存游戏",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"})})})]})]})}),l&&e.jsx("div",{className:"bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500 text-blue-700 dark:text-blue-200 p-4",children:e.jsx("p",{children:l})}),e.jsxs("main",{className:"flex-grow flex overflow-hidden",children:[m==="game"&&e.jsxs("div",{className:"flex flex-col md:flex-row w-full h-full overflow-hidden",children:[e.jsx("div",{className:"w-full md:w-1/3 p-4 overflow-y-auto border-r border-gray-200 dark:border-gray-700",children:e.jsx(Le,{gameState:s})}),e.jsxs("div",{className:"w-full md:w-2/3 flex flex-col h-full",children:[e.jsx("div",{className:"flex-grow p-4 overflow-y-auto",children:e.jsx(Oe,{history:n})}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700",children:e.jsx(Ae,{onSubmit:x,disabled:i,gameState:s})})]})]}),m==="characters"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(De,{})}),m==="worldbook"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(Ue,{})}),m==="settings"&&e.jsx("div",{className:"w-full h-full overflow-y-auto p-4",children:e.jsx(Fe,{onResetGame:d,onExportGame:T,onImportGame:O})})]}),e.jsx("footer",{className:"bg-gray-200 dark:bg-gray-800 p-2 text-sm text-gray-600 dark:text-gray-400",children:e.jsxs("div",{className:"container mx-auto flex justify-between items-center",children:[e.jsxs("div",{children:["游戏ID: ",s.gameId," | 回合: ",s.turn," | 阶段: ",s.phase]}),e.jsx("div",{children:new Date().toLocaleString()})]})})]})};function ze(){const[m,t]=y.useState(localStorage.getItem("darkMode")==="true"||window.matchMedia("(prefers-color-scheme: dark)").matches),[s,r]=y.useState(!0);return y.useEffect(()=>{m?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const n=setTimeout(()=>{r(!1)},1e3);return()=>clearTimeout(n)},[m]),s?e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-4",children:"AI-TRPG 叙事系统"}),e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600 dark:text-gray-400",children:"正在加载系统组件..."})]})}):e.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100",children:e.jsx(Je,{})})}ie.createRoot(document.getElementById("root")).render(e.jsx(fe.StrictMode,{children:e.jsx(ze,{})}));
